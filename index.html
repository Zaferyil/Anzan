<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANZAN MEISTER - TEST</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="Anzan Meister - Mentale Arithmetik Trainings-App für Lehrer und Schüler">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Anzan Meister">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .container {
            width: 100%;
            max-width: 1000px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: 30px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        @media (min-width: 768px) {
            .container {
                padding: 40px;
            }
        }

        h1 {
            text-align: center;
            color: white;
            font-size: 1.8em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        @media (min-width: 480px) {
            h1 {
                font-size: 2.2em;
                margin-bottom: 12px;
            }
        }

        @media (min-width: 768px) {
            h1 {
                font-size: 3em;
                margin-bottom: 15px;
            }
        }

        h2 {
            text-align: center;
            color: white;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        @media (min-width: 480px) {
            h2 {
                font-size: 1.3em;
            }
        }

        @media (min-width: 768px) {
            h2 {
                font-size: 1.6em;
                margin-bottom: 20px;
            }
        }

        .screen {
            display: none;
            width: 100%;
        }

        .screen.active {
            display: flex !important;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-in;
        }

        /* Settings screen special layout */
        #settingsScreen.active,
        #anzanVisualSettingsScreen.active,
        #flashcardSettingsScreen.active,
        #speedZahlenSettingsScreen.active,
        #multiDivSettingsScreen.active,
        #zahlenMerkenSettingsScreen.active,
        #zahlenVergleichenSettingsScreen.active,
        #logikRatselSettingsScreen.active,
        #zirkusSettingsScreen.active {
            display: block !important;
            width: 100%;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* HOME SCREEN */
        .home-screen {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 60vh;
        }

        @media (min-width: 768px) {
            .home-screen {
                min-height: 70vh;
            }
        }

        .start-button {
            background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 50%, #FFA07A 100%);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 1.5em;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(255, 107, 107, 0.4);
            margin-top: 20px;
            font-weight: bold;
            display: block;
            margin-left: auto;
            margin-right: auto;
            width: fit-content;
        }

        @media (min-width: 480px) {
            .start-button {
                padding: 25px 60px;
                font-size: 1.8em;
                margin-top: 30px;
            }
        }

        @media (min-width: 768px) {
            .start-button {
                padding: 30px 80px;
                font-size: 2.2em;
                margin-top: 40px;
            }
        }

        @media (min-width: 1024px) {
            .start-button {
                padding: 35px 100px;
                font-size: 2.5em;
            }
        }

        .start-button:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 30px rgba(255, 107, 107, 0.6);
        }

        /* GAME SELECTION CARDS */
        .game-selection-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            max-width: 800px;
            margin: 40px auto;
            padding: 0 20px;
        }

        @media (max-width: 480px) {
            .game-selection-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
        }

        .game-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 30px 20px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.15),
                inset 0 2px 8px rgba(255, 255, 255, 0.3);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .game-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .game-card:hover::before {
            left: 100%;
        }

        .game-card:hover {
            transform: translateY(-10px) scale(1.03);
            box-shadow: 
                0 15px 45px rgba(0, 0, 0, 0.25),
                0 0 30px rgba(255, 255, 255, 0.2),
                inset 0 2px 8px rgba(255, 255, 255, 0.4);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .game-card:active {
            transform: translateY(-8px) scale(1.01);
        }

        .game-card-locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .game-card-locked:hover {
            transform: none;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.15),
                inset 0 2px 8px rgba(255, 255, 255, 0.3);
        }

        .game-card-locked::before {
            display: none;
        }

        .game-icon {
            font-size: 4em;
            margin-bottom: 15px;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .game-title {
            color: white;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-description {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        @media (min-width: 768px) {
            .game-selection-grid {
                gap: 25px;
            }

            .game-card {
                padding: 40px 25px;
            }

            .game-icon {
                font-size: 5em;
            }

            .game-title {
                font-size: 1.8em;
            }

            .game-description {
                font-size: 1.1em;
            }
        }

        /* TANDEM TRAINING STYLES */
        /* TANDEM TRAINING STYLES */
        .tandem-display-container {
            max-width: 1000px;
            margin: 50px auto;
        }

        .tandem-split {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            min-height: 300px;
        }

        .tandem-number-left,
        .tandem-number-right {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8em;
            font-weight: bold;
            color: white;
            text-shadow: 4px 4px 8px rgba(0, 0, 0, 0.4);
            min-height: 200px;
        }

        .tandem-divider-vertical {
            width: 4px;
            height: 250px;
            background: linear-gradient(180deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.6) 50%, 
                rgba(255, 255, 255, 0.1) 100%);
            border-radius: 2px;
        }

        .tandem-answer-section {
            max-width: 600px;
            margin: 30px auto;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
            backdrop-filter: blur(15px);
            border-radius: 30px;
            padding: 40px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .tandem-answer-section h3 {
            color: white;
            font-size: 2em;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            text-align: center;
        }

        .tandem-answer-inputs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .tandem-answer-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .tandem-answer-group label {
            color: white;
            font-size: 1.5em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .tandem-answer-input {
            width: 150px;
            padding: 20px;
            font-size: 2.5em;
            border-radius: 20px;
            border: 3px solid rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.95);
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .tandem-answer-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 25px rgba(76, 175, 80, 0.6);
            transform: scale(1.05);
        }

        .check-tandem-button {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            padding: 20px 50px;
            font-size: 1.8em;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
            display: block;
            margin: 0 auto;
            width: 100%;
            max-width: 400px;
        }

        .check-tandem-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(76, 175, 80, 0.6);
        }

        .check-tandem-button:active {
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .tandem-split {
                flex-direction: column;
                gap: 30px;
                min-height: auto;
            }

            .tandem-number-left,
            .tandem-number-right {
                font-size: 5em;
                min-height: 120px;
            }

            .tandem-divider-vertical {
                width: 200px;
                height: 4px;
                background: linear-gradient(90deg, 
                    rgba(255, 255, 255, 0.1) 0%, 
                    rgba(255, 255, 255, 0.6) 50%, 
                    rgba(255, 255, 255, 0.1) 100%);
            }

            .tandem-answer-section {
                padding: 25px;
            }

            .tandem-answer-inputs {
                flex-direction: row; /* Keep side by side! */
                gap: 15px;
            }

            .tandem-answer-group {
                flex: 1; /* Equal width */
            }

            .tandem-answer-group label {
                font-size: 1.2em;
            }

            .tandem-answer-input {
                width: 100%;
                font-size: 1.8em;
                padding: 12px;
            }

            .check-tandem-button {
                padding: 15px 30px;
                font-size: 1.5em;
            }
        }




        .start-button:active {
            transform: translateY(-2px) scale(1.02);
        }

        .sound-icon-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 1.8em;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sound-icon-button:hover {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25));
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .sound-icon-button:active {
            transform: scale(0.95);
        }

        .home-icon-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.25), rgba(255, 255, 255, 0.15));
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 1.8em;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .home-icon-button:hover {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.35), rgba(255, 255, 255, 0.25));
            transform: scale(1.15);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .home-icon-button:active {
            transform: scale(0.95);
        }

        .sound-icon-button.muted {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.15), rgba(255, 255, 255, 0.1));
            opacity: 0.5;
            border-color: rgba(255, 255, 255, 0.2);
        }

        .sound-icon-button.muted:hover {
            opacity: 0.7;
        }

        /* SETTINGS SCREEN */
        .settings-section {
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.15);
            padding: 12px;
            border-radius: 20px;
        }

        @media (min-width: 480px) {
            .settings-section {
                margin-bottom: 18px;
                padding: 15px;
            }
        }

        @media (min-width: 768px) {
            .settings-section {
                margin-bottom: 25px;
                padding: 20px;
            }
        }

        .settings-section h3 {
            color: white;
            text-align: center;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        @media (min-width: 480px) {
            .settings-section h3 {
                margin-bottom: 10px;
                font-size: 1.1em;
            }
        }

        @media (min-width: 768px) {
            .settings-section h3 {
                margin-bottom: 12px;
                font-size: 1.3em;
            }
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        @media (min-width: 480px) {
            .options-grid {
                gap: 10px;
                margin-top: 10px;
            }
        }

        @media (min-width: 768px) {
            .options-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
                margin-top: 12px;
            }
        }

        .option-card {
            background: rgba(255, 255, 255, 0.25);
            border: 3px solid transparent;
            border-radius: 15px;
            padding: 10px 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
        }

        @media (min-width: 480px) {
            .option-card {
                padding: 12px 8px;
            }
        }

        @media (min-width: 768px) {
            .option-card {
                padding: 18px 12px;
            }
        }

        .option-card:hover {
            background: rgba(255, 255, 255, 0.35);
            transform: translateY(-3px);
        }

        .option-card.selected {
            background: rgba(255, 255, 255, 0.5);
            border-color: white;
            box-shadow: 0 0 25px rgba(255, 255, 255, 0.6);
            transform: scale(1.05);
        }

        .option-card .icon {
            font-size: 1.5em;
            margin-bottom: 4px;
        }

        @media (min-width: 480px) {
            .option-card .icon {
                font-size: 1.8em;
                margin-bottom: 5px;
            }
        }

        @media (min-width: 768px) {
            .option-card .icon {
                font-size: 2.5em;
                margin-bottom: 8px;
            }
        }

        .option-card .label {
            font-size: 0.85em;
            font-weight: bold;
        }

        @media (min-width: 480px) {
            .option-card .label {
                font-size: 0.95em;
            }
        }

        @media (min-width: 768px) {
            .option-card .label {
                font-size: 1.1em;
            }
        }

        .option-card .time {
            font-size: 0.7em;
            opacity: 0.9;
            margin-top: 3px;
        }

        @media (min-width: 480px) {
            .option-card .time {
                font-size: 0.75em;
                margin-top: 4px;
            }
        }

        @media (min-width: 768px) {
            .option-card .time {
                font-size: 0.85em;
                margin-top: 5px;
            }
        }

        /* Rechenart specific colors */
        .option-card[data-type="addition"].selected {
            background: linear-gradient(135deg, #4FC3F7 0%, #29B6F6 100%);
        }

        .option-card[data-type="subtraktion"].selected {
            background: linear-gradient(135deg, #BA68C8 0%, #AB47BC 100%);
        }

        .option-card[data-type="multiplikation"].selected {
            background: linear-gradient(135deg, #FF7043 0%, #FF5722 100%);
        }

        .option-card[data-type="division"].selected {
            background: linear-gradient(135deg, #FFB74D 0%, #FFA726 100%);
        }

        /* Geschwindigkeit specific colors */
        .option-card[data-speed="langsam"].selected {
            background: linear-gradient(135deg, #81C784 0%, #66BB6A 100%);
        }

        .option-card[data-speed="normal"].selected {
            background: linear-gradient(135deg, #FFD54F 0%, #FFCA28 100%);
        }

        .option-card[data-speed="schnell"].selected {
            background: linear-gradient(135deg, #FF8A65 0%, #FF7043 100%);
        }

        .option-card[data-speed="sehr-schnell"].selected {
            background: linear-gradient(135deg, #BA68C8 0%, #AB47BC 100%);
        }

        .option-card[data-speed="ultra-schnell"].selected {
            background: linear-gradient(135deg, #EC407A 0%, #E91E63 100%);
        }

        .option-card[data-speed="blitz"].selected {
            background: linear-gradient(135deg, #FF6F00 0%, #FF5722 100%);
        }

        .option-card[data-speed="extrem"].selected {
            background: linear-gradient(135deg, #F4511E 0%, #E64A19 100%);
        }

        .option-card[data-speed="meister"].selected {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        }

        /* Zahlenbereich specific colors */
        .option-card[data-range].selected {
            background: linear-gradient(135deg, #9575CD 0%, #7E57C2 100%);
        }

        /* Anzahl specific colors */
        .option-card[data-count].selected {
            background: linear-gradient(135deg, #4DD0E1 0%, #26C6DA 100%);
        }

        .game-start-button {
            background: linear-gradient(135deg, #66BB6A 0%, #4CAF50 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1.1em;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
            margin-top: 12px;
            display: block;
            margin-left: auto;
            margin-right: auto;
            font-weight: bold;
        }

        @media (min-width: 480px) {
            .game-start-button {
                padding: 14px 40px;
                font-size: 1.3em;
                margin-top: 15px;
            }
        }

        @media (min-width: 768px) {
            .game-start-button {
                padding: 15px 50px;
                font-size: 1.5em;
                margin-top: 20px;
            }
        }

        .game-start-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(76, 175, 80, 0.6);
        }

        /* GAME SCREEN */
        .game-screen {
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 15px 0;
        }

        @media (min-width: 480px) {
            .game-screen {
                min-height: 500px;
                padding: 18px 0;
            }
        }

        @media (min-width: 768px) {
            .game-screen {
                min-height: 70vh;
                padding: 20px 0;
            }
        }

        .number-display {
            font-size: 5em;
            color: white;
            font-weight: bold;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.5);
            min-height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse 0.3s ease-in-out;
        }

        @media (min-width: 480px) {
            .number-display {
                font-size: 6em;
                min-height: 140px;
            }
        }

        @media (min-width: 768px) {
            .number-display {
                font-size: 8em;
                min-height: 200px;
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes soundPulse {
            0%, 100% { 
                transform: scale(1); 
                filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
            }
            50% { 
                transform: scale(1.15); 
                filter: drop-shadow(0 0 25px rgba(255,255,255,0.7));
            }
        }

        .answer-section {
            margin-top: 15px;
            width: 100%;
            max-width: 400px;
            padding: 0 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        @media (min-width: 480px) {
            .answer-section {
                margin-top: 25px;
                max-width: 450px;
            }
        }

        @media (min-width: 768px) {
            .answer-section {
                margin-top: 40px;
                max-width: 600px;
            }
        }

        .answer-display {
            background: linear-gradient(145deg, #ffffff 0%, #f0f0f0 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 8px;
            min-height: 100px;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 8px 16px rgba(0, 0, 0, 0.2),
                inset 0 -2px 4px rgba(0, 0, 0, 0.1),
                inset 0 2px 4px rgba(255, 255, 255, 0.8);
            border: 3px solid rgba(255, 255, 255, 0.5);
        }

        @media (min-width: 480px) {
            .answer-display {
                border-radius: 25px;
                padding: 35px;
                margin-bottom: 10px;
                min-height: 120px;
            }
        }

        @media (min-width: 768px) {
            .answer-display {
                padding: 45px;
                margin-bottom: 12px;
                min-height: 140px;
                border-radius: 30px;
            }
        }

        .answer-display .display-text {
            font-size: 2em;
            font-weight: bold;
            color: #333;
        }

        @media (min-width: 480px) {
            .answer-display .display-text {
                font-size: 2.3em;
            }
        }

        @media (min-width: 768px) {
            .answer-display .display-text {
                font-size: 3em;
            }
        }

        .answer-display .placeholder {
            font-size: 2em;
            color: #999;
        }

        @media (min-width: 480px) {
            .answer-display .placeholder {
                font-size: 2.3em;
            }
        }

        @media (min-width: 768px) {
            .answer-display .placeholder {
                font-size: 3em;
            }
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 8px;
            width: 100%;
        }

        @media (min-width: 480px) {
            .keypad {
                gap: 8px;
                margin-bottom: 10px;
            }
        }

        @media (min-width: 768px) {
            .keypad {
                gap: 10px;
                margin-bottom: 12px;
            }
        }

        .key-button {
            background: linear-gradient(145deg, #FFE57F 0%, #FFD54F 50%, #FFC107 100%);
            border: none;
            border-radius: 12px;
            padding: 12px;
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 
                0 6px 12px rgba(0, 0, 0, 0.25),
                0 3px 6px rgba(0, 0, 0, 0.15),
                inset 0 -3px 0 rgba(0, 0, 0, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.5);
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
            position: relative;
            border-bottom: 4px solid #F9A825;
        }

        @media (min-width: 480px) {
            .key-button {
                padding: 14px;
                font-size: 1.5em;
                border-radius: 15px;
            }
        }

        @media (min-width: 768px) {
            .key-button {
                padding: 18px;
                font-size: 1.8em;
                border-radius: 18px;
            }
        }

        .key-button:hover {
            background: linear-gradient(145deg, #FFD54F 0%, #FFCA28 50%, #FFB300 100%);
            transform: translateY(-4px);
            box-shadow: 
                0 8px 16px rgba(0, 0, 0, 0.3),
                0 4px 8px rgba(0, 0, 0, 0.2),
                inset 0 -3px 0 rgba(0, 0, 0, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.5);
        }

        .key-button:active {
            transform: translateY(0);
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(0, 0, 0, 0.2);
            border-bottom: 2px solid #F9A825;
        }

        .key-button.zero {
            grid-column: 1 / 3;
            background: linear-gradient(145deg, #A5D6A7 0%, #81C784 50%, #66BB6A 100%);
            border-bottom: 4px solid #4CAF50;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .key-button.zero:hover {
            background: linear-gradient(145deg, #81C784 0%, #66BB6A 50%, #4CAF50 100%);
        }

        .key-button.zero:active {
            border-bottom: 2px solid #4CAF50;
        }

        .key-button.delete {
            background: linear-gradient(145deg, #FF8A65 0%, #FF7043 50%, #FF5722 100%);
            color: white;
            font-size: 1.5em;
            border-bottom: 4px solid #E64A19;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        @media (min-width: 768px) {
            .key-button.delete {
                font-size: 1.8em;
            }
        }

        .key-button.delete:hover {
            background: linear-gradient(145deg, #FF7043 0%, #FF5722 50%, #F4511E 100%);
        }

        .key-button.delete:active {
            border-bottom: 2px solid #E64A19;
        }

        .answer-input {
            font-size: 3em;
            padding: 20px 40px;
            border: 3px solid white;
            border-radius: 15px;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            width: 300px;
            font-weight: bold;
        }

        .submit-button {
            background: linear-gradient(145deg, #81C784 0%, #66BB6A 50%, #4CAF50 100%);
            color: white;
            border: none;
            padding: 14px 35px;
            font-size: 1.3em;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 12px;
            width: 100%;
            box-shadow: 
                0 6px 12px rgba(76, 175, 80, 0.4),
                0 3px 6px rgba(0, 0, 0, 0.15),
                inset 0 -3px 0 rgba(0, 0, 0, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.3);
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            border-bottom: 4px solid #388E3C;
        }

        @media (min-width: 480px) {
            .submit-button {
                padding: 16px 45px;
                font-size: 1.5em;
                margin-top: 15px;
                border-radius: 18px;
            }
        }

        @media (min-width: 768px) {
            .submit-button {
                padding: 20px 60px;
                font-size: 1.8em;
                margin-top: 20px;
                border-radius: 20px;
            }
        }

        .submit-button:hover {
            transform: translateY(-4px);
            background: linear-gradient(145deg, #66BB6A 0%, #4CAF50 50%, #43A047 100%);
            box-shadow: 
                0 8px 16px rgba(76, 175, 80, 0.5),
                0 4px 8px rgba(0, 0, 0, 0.2),
                inset 0 -3px 0 rgba(0, 0, 0, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.3);
        }

        .submit-button:active {
            transform: translateY(0);
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(0, 0, 0, 0.2);
            border-bottom: 2px solid #388E3C;
        }

        /* RESULT SCREEN */
        .result-screen {
            text-align: center;
        }

        .result-message {
            font-size: 3em;
            margin: 20px 0;
            font-weight: 900;
            text-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            animation: resultAppear 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
            letter-spacing: 2px;
        }

        @keyframes resultAppear {
            0% { 
                transform: scale(0) rotate(-10deg); 
                opacity: 0; 
            }
            60% { 
                transform: scale(1.15) rotate(5deg); 
            }
            100% { 
                transform: scale(1) rotate(0deg); 
                opacity: 1; 
            }
        }

        @media (min-width: 768px) {
            .result-message {
                font-size: 4.5em;
                margin: 30px 0;
            }
        }

        .result-message.correct {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.6));
        }

        .result-message.wrong {
            background: linear-gradient(135deg, #FF6B9D 0%, #FF4757 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 0 15px rgba(255, 107, 157, 0.5));
        }

        .result-details {
            background: linear-gradient(145deg, 
                rgba(255, 255, 255, 0.25), 
                rgba(255, 255, 255, 0.15));
            backdrop-filter: blur(15px);
            padding: 25px;
            border-radius: 30px;
            margin: 20px 0;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.15),
                inset 0 2px 8px rgba(255, 255, 255, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.3);
            transform-style: preserve-3d;
            transition: all 0.3s ease;
        }

        .result-details:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.2),
                inset 0 2px 8px rgba(255, 255, 255, 0.4);
        }

        @media (min-width: 768px) {
            .result-details {
                padding: 35px;
                margin: 25px 0;
            }
        }

        .result-details p {
            color: white;
            font-size: 1.3em;
            margin: 12px 0;
            font-weight: 600;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-details p strong {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1));
            padding: 8px 15px;
            border-radius: 15px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            min-width: 180px;
            display: inline-block;
        }

        @media (min-width: 768px) {
            .result-details p {
                font-size: 1.6em;
                margin: 12px 0;
            }
        }

        .result-details strong {
            color: #FFE082;
            font-size: 1.1em;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            justify-content: center;
            margin-top: 18px;
        }

        @media (min-width: 480px) {
            .button-group {
                gap: 14px;
                margin-top: 22px;
            }
        }

        @media (min-width: 768px) {
            .button-group {
                flex-direction: row;
                gap: 20px;
                margin-top: 35px;
            }
        }

        .button-group button {
            padding: 13px 28px;
            font-size: 1.05em;
            border: none;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            box-shadow: 
                0 6px 12px rgba(0, 0, 0, 0.3),
                inset 0 -3px 0 rgba(0, 0, 0, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.3);
            border-bottom: 4px solid rgba(0, 0, 0, 0.2);
        }

        @media (min-width: 480px) {
            .button-group button {
                padding: 15px 35px;
                font-size: 1.15em;
            }
        }

        @media (min-width: 768px) {
            .button-group button {
                padding: 18px 45px;
                font-size: 1.4em;
            }
        }

        .restart-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .restart-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .restart-button:hover::before {
            left: 100%;
        }

        .restart-button:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-5px) scale(1.02);
        }

        .new-settings-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .new-settings-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .new-settings-button:hover::before {
            left: 100%;
        }

        .new-settings-button:hover {
            background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%);
            transform: translateY(-5px) scale(1.02);
        }

        .home-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .home-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .home-button:hover::before {
            left: 100%;
        }

        .home-button:hover {
            background: linear-gradient(135deg, #00f2fe 0%, #4facfe 100%);
            transform: translateY(-5px) scale(1.02);
        }

        .button-group button {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .button-group button:hover {
            box-shadow: 
                0 12px 24px rgba(0, 0, 0, 0.25),
                0 0 20px rgba(255, 255, 255, 0.2),
                inset 0 -3px 0 rgba(0, 0, 0, 0.15),
                inset 0 2px 0 rgba(255, 255, 255, 0.4);
        }

        .button-group button:active {
            transform: translateY(-2px) scale(0.98);
            box-shadow: 
                0 4px 8px rgba(0, 0, 0, 0.2),
                inset 0 2px 6px rgba(0, 0, 0, 0.3);
            border-bottom: 2px solid rgba(0, 0, 0, 0.3);
        }

        .example-text {
            color: rgba(255, 255, 255, 0.7);
            font-size: 1em;
            margin-top: 10px;
            text-align: center;
        }

        /* SOUND TOGGLE */
        .sound-toggle-container {
            display: flex;
            justify-content: center;
            margin-top: 15px;
        }

        .sound-toggle-button {
            background: linear-gradient(145deg, #42A5F5 0%, #2196F3 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.2em;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 
                0 6px 12px rgba(33, 150, 243, 0.4),
                inset 0 -3px 0 rgba(0, 0, 0, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.3);
            border-bottom: 4px solid #1976D2;
        }

        .sound-toggle-button:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 8px 16px rgba(33, 150, 243, 0.5),
                inset 0 -3px 0 rgba(0, 0, 0, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.3);
        }

        .sound-toggle-button:active {
            transform: translateY(0);
            border-bottom: 2px solid #1976D2;
        }

        .sound-toggle-button.muted {
            background: linear-gradient(145deg, #78909C 0%, #607D8B 100%);
            border-bottom: 4px solid #455A64;
        }

        .sound-toggle-button.muted:hover {
            box-shadow: 
                0 8px 16px rgba(96, 125, 139, 0.4),
                inset 0 -3px 0 rgba(0, 0, 0, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.3);
        }

        #soundIcon {
            font-size: 1.5em;
        }

        /* CONFETTI ANIMATION */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #f0f;
            opacity: 0;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                opacity: 1;
                transform: translateY(0) rotateZ(0deg);
            }
            100% {
                opacity: 0;
                transform: translateY(100vh) rotateZ(720deg);
            }
        }

        /* MEINE AUFGABEN SCREEN */
        .tasks-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
            padding: 10px;
        }

        .task-item {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            transition: all 0.3s ease;
        }

        .task-item:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateX(5px);
        }

        .task-checkbox {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .task-text {
            flex: 1;
            color: white;
            font-size: 1.2em;
            font-weight: bold;
        }

        .task-play-button, .task-delete-button {
            padding: 8px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s ease;
        }

        .task-play-button {
            background: linear-gradient(145deg, #66BB6A 0%, #4CAF50 100%);
            color: white;
        }

        .task-play-button:hover {
            background: linear-gradient(145deg, #4CAF50 0%, #43A047 100%);
            transform: scale(1.05);
        }

        .task-delete-button {
            background: linear-gradient(145deg, #FF7043 0%, #FF5722 100%);
            color: white;
        }

        .task-delete-button:hover {
            background: linear-gradient(145deg, #FF5722 0%, #F4511E 100%);
            transform: scale(1.05);
        }

        .tasks-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 20px;
        }

        @media (min-width: 768px) {
            .tasks-actions {
                flex-direction: row;
                justify-content: center;
            }
        }

        .add-task-button, .play-selected-button, .delete-all-button, .back-button {
            padding: 12px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .add-task-button {
            background: linear-gradient(145deg, #AB47BC 0%, #9C27B0 100%);
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.4);
        }

        .add-task-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(156, 39, 176, 0.5);
        }

        .play-selected-button {
            background: linear-gradient(145deg, #66BB6A 0%, #4CAF50 100%);
            color: white;
        }

        .play-selected-button:hover {
            transform: translateY(-3px);
        }

        .delete-all-button {
            background: linear-gradient(145deg, #FF7043 0%, #FF5722 100%);
            color: white;
        }

        .delete-all-button:hover {
            transform: translateY(-3px);
        }

        .back-button {
            background: linear-gradient(145deg, #78909C 0%, #607D8B 100%);
            color: white;
            margin-top: 20px;
            font-size: 1.3em;
            padding: 18px 40px;
        }

        .back-button:hover {
            transform: translateY(-3px);
            background: linear-gradient(145deg, #607D8B 0%, #546E7A 100%);
        }

        @media (max-width: 768px) {
            .back-button {
                font-size: 1.2em;
                padding: 15px 35px;
                margin-top: 15px;
            }
        }

        /* MODAL STYLES */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(145deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 90%;
        }

        .modal-content h3 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.5em;
            text-align: center;
        }

        .modal-instruction {
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 15px;
            text-align: center;
        }

        .task-input {
            width: 100%;
            padding: 15px;
            font-size: 1.3em;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            background: rgba(255, 255, 255, 0.9);
            text-align: center;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .task-input:focus {
            outline: none;
            border-color: white;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .modal-save-button, .modal-cancel-button {
            padding: 12px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .modal-save-button {
            background: linear-gradient(145deg, #66BB6A 0%, #4CAF50 100%);
            color: white;
        }

        .modal-save-button:hover {
            transform: translateY(-3px);
        }

        .modal-cancel-button {
            background: linear-gradient(145deg, #FF7043 0%, #FF5722 100%);
            color: white;
        }

        .modal-cancel-button:hover {
            transform: translateY(-3px);
        }

        .empty-tasks-message {
            color: white;
            text-align: center;
            font-size: 1.2em;
            padding: 40px;
            opacity: 0.7;
        }

        /* COUNTDOWN SCREEN */
        .countdown-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 50vh;
        }

        @media (min-width: 768px) {
            .countdown-screen {
                min-height: 60vh;
            }
        }

        .countdown-circle {
            position: relative;
            width: 250px;
            height: 250px;
            filter: drop-shadow(0 10px 30px rgba(0, 0, 0, 0.3));
        }

        @media (min-width: 480px) {
            .countdown-circle {
                width: 320px;
                height: 320px;
            }
        }

        @media (min-width: 768px) {
            .countdown-circle {
                width: 400px;
                height: 400px;
            }
        }

        .countdown-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .countdown-circle-bg {
            fill: none;
            stroke: rgba(255, 255, 255, 0.25);
            stroke-width: 15;
        }

        .countdown-circle-progress {
            fill: none;
            stroke: #66BB6A;
            stroke-width: 15;
            stroke-linecap: round;
            stroke-dasharray: 565.5;
            stroke-dashoffset: 565.5;
            will-change: stroke-dashoffset;
            filter: 
                drop-shadow(0 0 10px rgba(102, 187, 106, 0.6))
                drop-shadow(0 2px 6px rgba(0, 0, 0, 0.2));
        }

        .countdown-svg {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .countdown-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 80%;
        }

        .countdown-logo {
            max-width: 100%;
            height: auto;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .countdown-logo.hide {
            opacity: 0;
        }

        .countdown-los {
            font-size: 5em;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 40px rgba(255, 215, 0, 1);
            opacity: 0;
            transform: scale(0.3);
            animation: losAppear 0.5s ease-out forwards;
        }

        @media (min-width: 768px) {
            .countdown-los {
                font-size: 7em;
            }
        }

        @keyframes losAppear {
            0% { 
                opacity: 0;
                transform: scale(0.3);
            }
            50% { 
                transform: scale(1.2);
            }
            70% {
                transform: scale(0.9);
            }
            100% { 
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Modal/Popup Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.3s ease-in;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(240, 240, 240, 0.9));
            padding: 30px;
            border-radius: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            animation: slideUp 0.3s ease-out;
            position: relative;
        }

        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            color: #5E35B1;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        .modal-header p {
            color: #666;
            font-size: 0.95em;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #FF5252;
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: #E53935;
            transform: rotate(90deg);
        }

        .modal-input-group {
            margin: 20px 0;
        }

        .modal-input-group label {
            display: block;
            color: #333;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .modal-input {
            width: 100%;
            padding: 15px;
            font-size: 1.3em;
            border: 3px solid #9575CD;
            border-radius: 15px;
            text-align: center;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .modal-input:focus {
            outline: none;
            border-color: #5E35B1;
            box-shadow: 0 0 20px rgba(94, 53, 177, 0.3);
        }

        .modal-example {
            text-align: center;
            color: #666;
            font-size: 0.9em;
            margin-top: 8px;
            font-style: italic;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-top: 25px;
        }

        .modal-button {
            flex: 1;
            padding: 15px;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .modal-button-start {
            background: linear-gradient(145deg, #66BB6A 0%, #4CAF50 100%);
            color: white;
        }

        .modal-button-start:hover {
            background: linear-gradient(145deg, #4CAF50 0%, #43A047 100%);
            transform: translateY(-2px);
        }

        .modal-button-cancel {
            background: linear-gradient(145deg, #BDBDBD 0%, #9E9E9E 100%);
            color: white;
        }

        .modal-button-cancel:hover {
            background: linear-gradient(145deg, #9E9E9E 0%, #757575 100%);
            transform: translateY(-2px);
        }

        .custom-task-button {
            background: linear-gradient(145deg, #AB47BC 0%, #9C27B0 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            width: 100%;
            font-weight: bold;
            box-shadow: 
                0 6px 12px rgba(156, 39, 176, 0.4),
                inset 0 -3px 0 rgba(0, 0, 0, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.3);
            border-bottom: 4px solid #7B1FA2;
        }

        .custom-task-button:hover {
            background: linear-gradient(145deg, #9C27B0 0%, #8E24AA 100%);
            transform: translateY(-3px);
            box-shadow: 
                0 8px 16px rgba(156, 39, 176, 0.5),
                inset 0 -3px 0 rgba(0, 0, 0, 0.1),
                inset 0 2px 0 rgba(255, 255, 255, 0.3);
        }

        .custom-task-button:active {
            transform: translateY(0);
            border-bottom: 2px solid #7B1FA2;
        }

        /* Custom Range Styles */
        .custom-range-section {
            margin-top: 20px;
        }

        .custom-range-inputs {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .input-group label {
            color: white;
            font-size: 1.1em;
            font-weight: bold;
        }

        .input-group input {
            padding: 12px 20px;
            font-size: 1.3em;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            width: 150px;
            text-align: center;
            font-weight: bold;
        }

        .input-group input:focus {
            outline: none;
            border-color: white;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.5);
        }
        /* ==================== FLASH CARD STYLES ==================== */
        .flashcard-progress-boxes {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            padding: 20px;
        }

        .progress-box {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border: 3px solid rgba(255, 255, 255, 0.4);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            transition: all 0.3s ease;
        }

        .progress-box.correct {
            background: rgba(76, 175, 80, 0.3);
            border-color: #4CAF50;
        }

        .progress-box.correct::after {
            content: '✓';
            color: #4CAF50;
            font-weight: bold;
        }

        .progress-box.wrong {
            background: rgba(244, 67, 54, 0.3);
            border-color: #f44336;
        }

        .progress-box.wrong::after {
            content: '✗';
            color: #f44336;
            font-weight: bold;
        }

        .flashcard-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: bold;
            color: white;
        }

        .flashcard-container {
            max-width: 650px;
            margin: 0 auto;
            padding: 30px;
            background: linear-gradient(135deg, rgba(155, 89, 182, 0.1) 0%, rgba(142, 68, 173, 0.1) 100%);
            border-radius: 50px;
        }

        .soroban-display {
            background: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.05) 100%),
                linear-gradient(145deg, #9b59b6 0%, #8e44ad 100%);
            border-radius: 45px;
            padding: 50px 100px;
            margin-bottom: 40px;
            box-shadow: 
                0 20px 60px rgba(142, 68, 173, 0.4),
                0 10px 30px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            position: relative;
        }

        .soroban-display::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), transparent);
            border-radius: 45px;
            z-index: -1;
            opacity: 0.5;
        }

        .soroban-frame {
            background: linear-gradient(180deg, #ffffff 0%, #f8f8f8 100%);
            border-radius: 30px;
            padding: 50px 110px;
            position: relative;
            min-height: 400px;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.1),
                inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .soroban-rods {
            display: flex;
            justify-content: center;
            gap: 30px;
            position: relative;
        }

        .soroban-rod {
            width: auto;
            min-width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        .soroban-divider {
            width: 100%;
            height: 6px;
            background: #5DADE2;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
        }

        .soroban-column {
            width: 12px;
            height: 350px;
            background: #5DADE2;
            border-radius: 6px;
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: none;
        }

        .soroban-heaven {
            position: relative;
            height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding: 0;
            gap: 0;
            margin-bottom: 0;
        }

        .soroban-earth {
            position: relative;
            height: 200px;
            display: flex;
            flex-direction: column-reverse;
            align-items: center;
            justify-content: flex-end;
            padding: 0;
            gap: 0;
            margin-top: 0;
        }

        .soroban-bead {
            width: 60px;
            height: 32px;
            background: 
                linear-gradient(to right, rgba(255, 255, 255, 0.3) 0%, transparent 50%, rgba(0, 0, 0, 0.2) 100%),
                linear-gradient(to bottom, #FFF59D 0%, #FFD54F 25%, #FFCA28 50%, #FF9800 75%, #F57C00 100%);
            clip-path: polygon(
                0% 50%,
                25% 5%,
                75% 5%,
                100% 50%,
                75% 95%,
                25% 95%
            );
            position: relative;
            z-index: 2;
            margin: -2px 0;
            box-shadow: 
                0 2px 6px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .soroban-bead::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(
                135deg,
                rgba(255, 255, 255, 0.3) 0%,
                transparent 40%,
                rgba(0, 0, 0, 0.1) 100%
            );
            clip-path: inherit;
        }

        .soroban-bead:hover {
            transform: scale(1.03);
            box-shadow: 
                0 3px 8px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.4),
                inset 0 -1px 0 rgba(0, 0, 0, 0.2);
        }

        /* Tüm boncuklar aktif (sarı/altın) */
        .soroban-bead.active {
            background: 
                linear-gradient(to right, rgba(255, 255, 255, 0.3) 0%, transparent 50%, rgba(0, 0, 0, 0.2) 100%),
                linear-gradient(to bottom, #FFF59D 0%, #FFD54F 25%, #FFCA28 50%, #FF9800 75%, #F57C00 100%);
        }

        .flashcard-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .flashcard-option {
            background: #FFFFFF;
            color: #5DADE2;
            font-size: 3em;
            font-weight: bold;
            padding: 25px 35px;
            border-radius: 12px;
            border: 3px solid #E8E8E8;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .flashcard-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
            border-color: #5DADE2;
        }

        .flashcard-option.correct {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
            animation: correctPulse 0.5s ease;
        }

        .flashcard-option.wrong {
            background: #f44336;
            color: white;
            border-color: #f44336;
            animation: shake 0.5s ease;
        }

        @keyframes correctPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        @media (max-width: 768px) {
            .flashcard-option { font-size: 2em; padding: 20px; }
            .soroban-display { padding: 40px 30px; }
            .soroban-frame { padding: 40px 30px; }
            .soroban-rods { gap: 15px; }
            .soroban-rod { width: 40px; }
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- Confetti Container -->
        <div class="confetti-container" id="confettiContainer"></div>

        <!-- HOME SCREEN -->
        <div class="screen active" id="homeScreen">
            <button class="sound-icon-button" onclick="toggleSound()" id="soundIconButton">
                <span id="soundIconHome">🔊</span>
            </button>
            <h1>🧮 ANZAN MEISTER</h1>
            <h2>Gehirntraining & Mathe-Spiele</h2>
            
            <div class="game-selection-grid">
                <div class="game-card" onclick="selectGame('anzan')">
                    <div style="font-size: 0.85em; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                        🎯 Konzentration & Kopfrechnen
                    </div>
                    <div class="game-icon">🧮</div>
                    <div class="game-title">Anzan Meister</div>
                    <div class="game-description">Mental Arithmetik</div>
                </div>
                
                <div class="game-card" onclick="selectGame('tandem')">
                    <div style="font-size: 0.85em; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                        🎯 Konzentration & Multitasking
                    </div>
                    <div class="game-icon">🧠</div>
                    <div class="game-title">Tandem Training</div>
                    <div class="game-description">BrainPower Duo</div>
                </div>
                
                <div class="game-card" onclick="selectGame('flashcard')">
                    <div style="font-size: 0.85em; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                        🎯 Wahrnehmung & Gedächtnis
                    </div>
                    <div class="game-icon">🎴</div>
                    <div class="game-title">Abakus Flash Card</div>
                    <div class="game-description">Soroban Lernen</div>
                </div>
                
                <div class="game-card" onclick="selectGame('visualTraining')">
                    <div style="font-size: 0.85em; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                        🎯 Verarbeitungsgeschwindigkeit
                    </div>
                    <div class="game-icon">👁️</div>
                    <div class="game-title">Abakus Visual Training</div>
                    <div class="game-description">Flash Speed Training</div>
                </div>
                
                <div class="game-card" onclick="selectGame('speedZahlen')">
                    <div style="font-size: 0.85em; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                        🎯 Konzentration & Wahrnehmung
                    </div>
                    <div class="game-icon">⏱️🔢</div>
                    <div class="game-title">Speed Zählen</div>
                    <div class="game-description">Schnell Zählen</div>
                </div>
                
                <div class="game-card" onclick="selectGame('multiDivCards')">
                    <div style="font-size: 0.85em; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                        🎯 Logisches Denken & Kopfrechnen
                    </div>
                    <div class="game-icon">🧮✖️➗</div>
                    <div class="game-title">MultiDiv Cards</div>
                    <div class="game-description">Multi & Div – Flashkarten</div>
                </div>
                
                <div class="game-card" onclick="selectGame('zahlenMerken')">
                    <div style="font-size: 0.85em; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                        🎯 Gedächtnis & Konzentration
                    </div>
                    <div class="game-icon">🧠💭</div>
                    <div class="game-title">Zahlen Merken</div>
                    <div class="game-description">Gedächtnistraining</div>
                </div>
                
                <div class="game-card" onclick="selectGame('zahlenVergleichen')">
                    <div style="font-size: 0.85em; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                        🎯 Wahrnehmung & Logisches Denken
                    </div>
                    <div class="game-icon">⚖️🔢</div>
                    <div class="game-title">Zahlen Vergleichen</div>
                    <div class="game-description">Vergleich & Wähle</div>
                </div>
                
                <div class="game-card" onclick="selectGame('logikRatsel')">
                    <div style="font-size: 0.85em; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                        🎯 Logisches Denken & Konzentration
                    </div>
                    <div class="game-icon">🎲🧠</div>
                    <div class="game-title">Logik Rätsel</div>
                    <div class="game-description">Muster erkennen</div>
                </div>
                
                <div class="game-card" onclick="selectGame('sesliAnzan')">
                    <div style="font-size: 0.85em; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                        🎯 Konzentration & Kopfrechnen
                    </div>
                    <div class="game-icon">🔊🧮</div>
                    <div class="game-title">Anzan mit Stimme</div>
                    <div class="game-description">Hören & Rechnen</div>
                </div>
                
                <div class="game-card" onclick="selectGame('farbSpiel')">
                    <div style="font-size: 0.85em; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                        🎯 Konzentration & Verarbeitungsgeschwindigkeit
                    </div>
                    <div class="game-icon">🎨🧠</div>
                    <div class="game-title">Sag die richtige Farbe!</div>
                    <div class="game-description">Stroop Test</div>
                </div>
                
                <div class="game-card" onclick="selectGame('sorobanMathe')">
                    <div style="font-size: 0.85em; color: rgba(255,255,255,0.9); font-weight: bold; margin-bottom: 12px; text-shadow: 1px 1px 2px rgba(0,0,0,0.3);">
                        🎯 Logisches Denken & Kopfrechnen
                    </div>
                    <div class="game-icon">🧮➕➖✖️➗</div>
                    <div class="game-title">Soroban Mathe</div>
                    <div class="game-description">Abakus Rechnen</div>
                </div>
            </div>
        </div>

        <!-- SETTINGS SCREEN -->
        <div class="screen" id="settingsScreen">
            <button class="home-icon-button" onclick="goHome()" title="Zurück zur Startseite">🏠</button>
            <h2>Einstellungen wählen</h2>

            <!-- Rechenart wählen -->
            <div class="settings-section">
                <h3>Rechenart wählen</h3>
                <div class="options-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="option-card selected" data-type="addition" onclick="selectOption('rechenart', 'addition', this)">
                        <div class="icon">➕</div>
                        <div class="label">Addition</div>
                    </div>
                    <div class="option-card" data-type="subtraktion" onclick="selectOption('rechenart', 'subtraktion', this)">
                        <div class="icon">➖</div>
                        <div class="label">Subtraktion</div>
                    </div>
                    <div class="option-card" data-type="multiplikation" onclick="selectOption('rechenart', 'multiplikation', this)">
                        <div class="icon">✖️</div>
                        <div class="label">Multiplikation</div>
                    </div>
                    <div class="option-card" data-type="division" onclick="selectOption('rechenart', 'division', this)">
                        <div class="icon">➗</div>
                        <div class="label">Division</div>
                    </div>
                </div>
            </div>

            <!-- Geschwindigkeit wählen -->
            <div class="settings-section" id="geschwindigkeitSection">
                <h3>Geschwindigkeit wählen</h3>
                <div class="options-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="option-card" data-speed="langsam" onclick="selectOption('geschwindigkeit', 4000, this)">
                        <div class="icon">🐌</div>
                        <div class="label">Langsam</div>
                        <div class="time">4s</div>
                    </div>
                    <div class="option-card selected" data-speed="normal" onclick="selectOption('geschwindigkeit', 3000, this)">
                        <div class="icon">🏃</div>
                        <div class="label">Normal</div>
                        <div class="time">3s</div>
                    </div>
                    <div class="option-card" data-speed="schnell" onclick="selectOption('geschwindigkeit', 2000, this)">
                        <div class="icon">🏃‍♂️</div>
                        <div class="label">Schnell</div>
                        <div class="time">2s</div>
                    </div>
                    <div class="option-card" data-speed="sehr-schnell" onclick="selectOption('geschwindigkeit', 1000, this)">
                        <div class="icon">⚡</div>
                        <div class="label">Sehr Schnell</div>
                        <div class="time">1s</div>
                    </div>
                    <div class="option-card" data-speed="ultra-schnell" onclick="selectOption('geschwindigkeit', 800, this)">
                        <div class="icon">🚀</div>
                        <div class="label">Ultra Schnell</div>
                        <div class="time">0.8s</div>
                    </div>
                    <div class="option-card" data-speed="blitz" onclick="selectOption('geschwindigkeit', 600, this)">
                        <div class="icon">⚡🔥</div>
                        <div class="label">Blitz</div>
                        <div class="time">0.6s</div>
                    </div>
                    <div class="option-card" data-speed="extrem" onclick="selectOption('geschwindigkeit', 500, this)">
                        <div class="icon">💥</div>
                        <div class="label">Extrem</div>
                        <div class="time">0.5s</div>
                    </div>
                    <div class="option-card" data-speed="meister" onclick="selectOption('geschwindigkeit', 400, this)">
                        <div class="icon">🏆</div>
                        <div class="label">Meister</div>
                        <div class="time">0.4s</div>
                    </div>
                </div>
            </div>

            <!-- Zahlenbereich wählen -->
            <div class="settings-section" id="zahlenbereichSection">
                <h3>Zahlenbereich wählen</h3>
                
                <!-- Standard für Addition/Subtraktion -->
                <div id="standardZahlenbereich">
                    <div class="options-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="option-card" data-range="1-5" onclick="selectOption('zahlenbereich', [1, 5], this)">
                            <div class="label">1-5</div>
                        </div>
                        <div class="option-card selected" data-range="1-10" onclick="selectOption('zahlenbereich', [1, 10], this)">
                            <div class="label">1-10</div>
                        </div>
                        <div class="option-card" data-range="1-20" onclick="selectOption('zahlenbereich', [1, 20], this)">
                            <div class="label">1-20</div>
                        </div>
                        <div class="option-card" data-range="1-50" onclick="selectOption('zahlenbereich', [1, 50], this)">
                            <div class="label">1-50</div>
                        </div>
                    </div>
                    
                    <!-- Eigener Bereich -->
                    <div class="custom-range-section">
                        <div class="option-card" data-range="custom" onclick="toggleCustomRange(this)">
                            <div class="label">Eigener Bereich</div>
                        </div>
                        <div class="custom-range-inputs" id="customRangeInputs" style="display: none;">
                            <div class="input-group">
                                <label>Von:</label>
                                <input type="number" id="customMin" value="1" min="0" max="9999">
                            </div>
                            <div class="input-group">
                                <label>Bis:</label>
                                <input type="number" id="customMax" value="100" min="1" max="10000">
                            </div>
                        </div>
                    </div>

                    <!-- Meine Aufgaben Button -->
                    <button class="custom-task-button" id="meineAufgabenButton" onclick="showMeineAufgaben()">
                        📚 Meine Aufgaben
                    </button>
                </div>

                <!-- Multiplikation Optionen -->
                <div id="multiplikationOptions" style="display: none;">
                    <h4 style="color: white; margin-bottom: 10px;">Multiplikationsstufe</h4>
                    <div class="options-grid" style="grid-template-columns: repeat(5, 1fr);">
                        <div class="option-card selected" data-multi-level="1" onclick="selectMultiplicationLevel(1, this)">
                            <div class="icon">✖️</div>
                            <div class="label">1 • 5</div>
                            <div class="time">Einfach</div>
                        </div>
                        <div class="option-card" data-multi-level="11" onclick="selectMultiplicationLevel(11, this)">
                            <div class="icon">✖️</div>
                            <div class="label">1 • 9</div>
                            <div class="time">Sehr einfach</div>
                        </div>
                        <div class="option-card" data-multi-level="2" onclick="selectMultiplicationLevel(2, this)">
                            <div class="icon">✖️</div>
                            <div class="label">35 • 2</div>
                            <div class="time">Mittel</div>
                        </div>
                        <div class="option-card" data-multi-level="3" onclick="selectMultiplicationLevel(3, this)">
                            <div class="icon">✖️</div>
                            <div class="label">452 • 4</div>
                            <div class="time">Fortgeschritten</div>
                        </div>
                        <div class="option-card" data-multi-level="4" onclick="selectMultiplicationLevel(4, this)">
                            <div class="icon">✖️</div>
                            <div class="label">4524 • 4</div>
                            <div class="time">Schwer</div>
                        </div>
                        <div class="option-card" data-multi-level="5" onclick="selectMultiplicationLevel(5, this)">
                            <div class="icon">✖️</div>
                            <div class="label">34 • 23</div>
                            <div class="time">Experte</div>
                        </div>
                        <div class="option-card" data-multi-level="6" onclick="selectMultiplicationLevel(6, this)">
                            <div class="icon">✖️</div>
                            <div class="label">234 • 42</div>
                            <div class="time">Meister</div>
                        </div>
                        <div class="option-card" data-multi-level="7" onclick="selectMultiplicationLevel(7, this)">
                            <div class="icon">🔥</div>
                            <div class="label">89 • 7</div>
                            <div class="time">Profi</div>
                        </div>
                        <div class="option-card" data-multi-level="9" onclick="selectMultiplicationLevel(9, this)">
                            <div class="icon">💎</div>
                            <div class="label">149 • 9</div>
                            <div class="time">Champion</div>
                        </div>
                        <div class="option-card" data-multi-level="10" onclick="selectMultiplicationLevel(10, this)">
                            <div class="icon">👑</div>
                            <div class="label">56 • 78</div>
                            <div class="time">Legende</div>
                        </div>
                    </div>

                    <h4 style="color: white; margin: 20px 0 10px 0; text-align: center;">Ziffernbereich</h4>
                    <div class="options-grid">
                        <div class="option-card selected" data-digit-range="1-5" onclick="selectDigitRange('1-5', this)">
                            <div class="label">1-5</div>
                            <div class="time">Sehr einfach</div>
                        </div>
                        <div class="option-card" data-digit-range="1-7" onclick="selectDigitRange('1-7', this)">
                            <div class="label">1-7</div>
                            <div class="time">Einfach</div>
                        </div>
                        <div class="option-card" data-digit-range="1-9" onclick="selectDigitRange('1-9', this)">
                            <div class="label">1-9</div>
                            <div class="time">Normal</div>
                        </div>
                    </div>
                </div>

                <!-- Division Optionen -->
                <div id="divisionOptions" style="display: none;">
                    <h4 style="color: white; margin-bottom: 10px;">Divisionsstufe</h4>
                    <div class="options-grid" style="grid-template-columns: repeat(5, 1fr);">
                        <div class="option-card selected" data-div-level="1" onclick="selectDivisionLevel(1, this)">
                            <div class="icon">➗</div>
                            <div class="label">10 : 5</div>
                            <div class="time">Einfach</div>
                        </div>
                        <div class="option-card" data-div-level="2" onclick="selectDivisionLevel(2, this)">
                            <div class="icon">➗</div>
                            <div class="label">45 : 9</div>
                            <div class="time">Sehr einfach</div>
                        </div>
                        <div class="option-card" data-div-level="3" onclick="selectDivisionLevel(3, this)">
                            <div class="icon">➗</div>
                            <div class="label">70 : 2</div>
                            <div class="time">Mittel</div>
                        </div>
                        <div class="option-card" data-div-level="4" onclick="selectDivisionLevel(4, this)">
                            <div class="icon">➗</div>
                            <div class="label">452 : 4</div>
                            <div class="time">Fortgeschritten</div>
                        </div>
                        <div class="option-card" data-div-level="5" onclick="selectDivisionLevel(5, this)">
                            <div class="icon">➗</div>
                            <div class="label">4524 : 4</div>
                            <div class="time">Schwer</div>
                        </div>
                        <div class="option-card" data-div-level="6" onclick="selectDivisionLevel(6, this)">
                            <div class="icon">🔥</div>
                            <div class="label">45234 : 5</div>
                            <div class="time">Experte</div>
                        </div>
                        <div class="option-card" data-div-level="7" onclick="selectDivisionLevel(7, this)">
                            <div class="icon">⚡</div>
                            <div class="label">451234 : 4</div>
                            <div class="time">Meister</div>
                        </div>
                        <div class="option-card" data-div-level="8" onclick="selectDivisionLevel(8, this)">
                            <div class="icon">💎</div>
                            <div class="label">455 : 13</div>
                            <div class="time">Profi</div>
                        </div>
                        <div class="option-card" data-div-level="9" onclick="selectDivisionLevel(9, this)">
                            <div class="icon">👑</div>
                            <div class="label">5684 : 17</div>
                            <div class="time">Champion</div>
                        </div>
                        <div class="option-card" data-div-level="10" onclick="selectDivisionLevel(10, this)">
                            <div class="icon">🏆</div>
                            <div class="label">8856 : 123</div>
                            <div class="time">Legende</div>
                        </div>
                    </div>

                    <h4 style="color: white; margin: 20px 0 10px 0; text-align: center;">Ziffernbereich</h4>
                    <div class="options-grid">
                        <div class="option-card selected" data-digit-range-div="1-5" onclick="selectDigitRangeDiv('1-5', this)">
                            <div class="label">1-5</div>
                            <div class="time">Sehr einfach</div>
                        </div>
                        <div class="option-card" data-digit-range-div="1-7" onclick="selectDigitRangeDiv('1-7', this)">
                            <div class="label">1-7</div>
                            <div class="time">Einfach</div>
                        </div>
                        <div class="option-card" data-digit-range-div="1-9" onclick="selectDigitRangeDiv('1-9', this)">
                            <div class="label">1-9</div>
                            <div class="time">Normal</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Anzahl der Zahlen pro Aufgabe -->
            <div class="settings-section" id="anzahlSection">
                <h3>Anzahl der Zahlen pro Aufgabe</h3>
                <div class="options-grid" style="grid-template-columns: repeat(5, 1fr);">
                    <div class="option-card" data-count="2" onclick="selectOption('anzahl', 2, this)">
                        <div class="label">2</div>
                    </div>
                    <div class="option-card selected" data-count="3" onclick="selectOption('anzahl', 3, this)">
                        <div class="label">3</div>
                    </div>
                    <div class="option-card" data-count="4" onclick="selectOption('anzahl', 4, this)">
                        <div class="label">4</div>
                    </div>
                    <div class="option-card" data-count="5" onclick="selectOption('anzahl', 5, this)">
                        <div class="label">5</div>
                    </div>
                    <div class="option-card" data-count="6" onclick="selectOption('anzahl', 6, this)">
                        <div class="label">6</div>
                    </div>
                    <div class="option-card" data-count="7" onclick="selectOption('anzahl', 7, this)">
                        <div class="label">7</div>
                    </div>
                    <div class="option-card" data-count="8" onclick="selectOption('anzahl', 8, this)">
                        <div class="label">8</div>
                    </div>
                    <div class="option-card" data-count="9" onclick="selectOption('anzahl', 9, this)">
                        <div class="label">9</div>
                    </div>
                    <div class="option-card" data-count="10" onclick="selectOption('anzahl', 10, this)">
                        <div class="label">10</div>
                    </div>
                    <div class="option-card" data-count="15" onclick="selectOption('anzahl', 15, this)">
                        <div class="label">15</div>
                    </div>
                    <div class="option-card" data-count="20" onclick="selectOption('anzahl', 20, this)">
                        <div class="label">20</div>
                    </div>
                    <div class="option-card" data-count="25" onclick="selectOption('anzahl', 25, this)">
                        <div class="label">25</div>
                    </div>
                    <div class="option-card" data-count="30" onclick="selectOption('anzahl', 30, this)">
                        <div class="label">30</div>
                    </div>
                    <div class="option-card" data-count="40" onclick="selectOption('anzahl', 40, this)">
                        <div class="label">40</div>
                    </div>
                    <div class="option-card" data-count="50" onclick="selectOption('anzahl', 50, this)">
                        <div class="label">50</div>
                    </div>
                </div>
                <div class="example-text">Beispiel: 2 + 4 + 6 = ?</div>
            </div>

            <button class="game-start-button" onclick="startGame()">🎮 SPIEL STARTEN</button>
        </div>

        <!-- COUNTDOWN SCREEN -->
        <div class="screen" id="countdownScreen">
            <div class="countdown-screen">
                <div class="countdown-circle">
                    <svg class="countdown-svg" viewBox="0 0 200 200">
                        <circle cx="100" cy="100" r="90" class="countdown-circle-bg"></circle>
                        <circle cx="100" cy="100" r="90" class="countdown-circle-progress" id="countdownProgress"></circle>
                    </svg>
                    <div class="countdown-content">
                        <div class="countdown-logo" id="countdownLogo">
                            <div style="font-size: 2em; font-weight: bold; color: white; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">🧮</div>
                            <div style="font-size: 1.2em; font-weight: bold; color: white; margin-top: 10px;">ANZAN<br>MEISTER</div>
                        </div>
                        <div class="countdown-los" id="countdownLos" style="display: none;">LOS!</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div class="screen" id="gameScreen">
            <div class="number-display" id="numberDisplay"></div>
            <div class="answer-section" id="answerSection" style="display: none;">
                <div class="answer-display">
                    <div class="display-text" id="answerDisplay">
                        <span class="placeholder"></span>
                    </div>
                </div>
                
                <div class="keypad">
                    <button class="key-button" onclick="addDigit(1)">1</button>
                    <button class="key-button" onclick="addDigit(2)">2</button>
                    <button class="key-button" onclick="addDigit(3)">3</button>
                    <button class="key-button" onclick="addDigit(4)">4</button>
                    <button class="key-button" onclick="addDigit(5)">5</button>
                    <button class="key-button" onclick="addDigit(6)">6</button>
                    <button class="key-button" onclick="addDigit(7)">7</button>
                    <button class="key-button" onclick="addDigit(8)">8</button>
                    <button class="key-button" onclick="addDigit(9)">9</button>
                    <button class="key-button zero" onclick="addDigit(0)">0</button>
                    <button class="key-button delete" onclick="deleteDigit()">⌫</button>
                </div>

                <button class="submit-button" onclick="checkAnswer()">✓ Antwort prüfen</button>
            </div>
        </div>

        <!-- RESULT SCREEN -->
        <div class="screen" id="resultScreen">
            <div class="result-message" id="resultMessage"></div>
            <div class="result-details">
                <p><strong>Aufgabe:</strong> <span id="questionText"></span></p>
                <p><strong>Richtige Antwort:</strong> <span id="correctAnswer"></span></p>
                <p><strong>Deine Antwort:</strong> <span id="userAnswer"></span></p>
            </div>
            <div class="button-group">
                <button class="restart-button" onclick="startGame()">🔄 Nochmal</button>
                <button class="new-settings-button" onclick="showSettings()">⚙️ Neue Einstellungen</button>
                <button class="home-button" onclick="goHome()">🏠 Startseite</button>
            </div>
        </div>

        <!-- CUSTOM TASK MODAL -->
        <div class="modal" id="customTaskModal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeCustomTaskModal()">×</button>
                <div class="modal-header">
                    <h3>✏️ Eigene Aufgabe</h3>
                    <p>Gib deine eigenen Zahlen ein</p>
                </div>
                <div class="modal-input-group">
                    <label for="customTaskInput">Zahlen eingeben:</label>
                    <input 
                        type="text" 
                        id="customTaskInput" 
                        class="modal-input" 
                        placeholder="z.B. 5+6+8 oder 5, 6, 8"
                    >
                    <div class="modal-example">Beispiele: "5+6+8" oder "5, 6, 8, 12" oder "5 6 8"</div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-button modal-button-cancel" onclick="closeCustomTaskModal()">
                        ❌ Abbrechen
                    </button>
                    <button class="modal-button modal-button-start" onclick="startCustomTask()">
                        ▶️ Aufgabe starten
                    </button>
                </div>
            </div>
        </div>

        <!-- TANDEM TRAINING SCREEN -->
        <div class="screen" id="tandemScreen">
            <!-- Countdown -->
            <div class="countdown-container" id="tandemCountdownContainer" style="display: none;">
                <svg class="countdown-circle" viewBox="0 0 200 200">
                    <circle class="countdown-bg" cx="100" cy="100" r="90"></circle>
                    <circle class="countdown-progress" id="tandemCountdownProgress" cx="100" cy="100" r="90"></circle>
                </svg>
                <div class="countdown-number" id="tandemCountdownNumber">3</div>
            </div>

            <!-- LOS Display -->
            <div class="los-display" id="tandemLosDisplay" style="display: none;">LOS!</div>

            <!-- Tandem Split Display -->
            <div class="tandem-display-container" id="tandemDisplayContainer" style="display: none;">
                <div class="tandem-split">
                    <div class="tandem-number-left" id="tandemNumberLeft"></div>
                    <div class="tandem-divider-vertical"></div>
                    <div class="tandem-number-right" id="tandemNumberRight"></div>
                </div>
            </div>

            <!-- Answer Section -->
            <div class="tandem-answer-section" id="tandemAnswerSection" style="display: none;">
                <h3>ERGEBNIS</h3>
                <div class="tandem-answer-inputs">
                    <div class="tandem-answer-group">
                        <label>LINKS</label>
                        <input type="number" class="tandem-answer-input" id="tandemAnswerLeft" placeholder="?">
                    </div>
                    <div class="tandem-answer-group">
                        <label>RECHTS</label>
                        <input type="number" class="tandem-answer-input" id="tandemAnswerRight" placeholder="?">
                    </div>
                </div>
                <button class="check-tandem-button" onclick="checkTandemAnswer()">✓ Antwort prüfen</button>
            </div>
        </div>

        <!-- FLASH CARD SETTINGS SCREEN -->
        <div class="screen" id="flashcardSettingsScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            <h2>Einstellungen wählen</h2>

            <div class="settings-section">
                <h3>🎮 Spielmodus wählen</h3>
                <div class="options-grid" style="grid-template-columns: repeat(2, 1fr);">
                    <div class="option-card selected" data-flashmode="abacusToNumber" onclick="selectFlashcardMode('abacusToNumber', this)">
                        <div class="icon">🧮</div>
                        <div class="label">Abakus → Zahl</div>
                        <div class="time">(Lesen)</div>
                    </div>
                    <div class="option-card" data-flashmode="numberToAbacus" onclick="selectFlashcardMode('numberToAbacus', this)">
                        <div class="icon">🔢</div>
                        <div class="label">Zahl → Abakus</div>
                        <div class="time">(Finden)</div>
                    </div>
                </div>
            </div>

            <div class="settings-section">
                <h3>🔢 Stellenwert wählen</h3>
                <div class="options-grid">
                    <div class="option-card selected" data-flashdigits="1" onclick="selectFlashcardDigits(1, this)">
                        <div class="icon">1️⃣</div>
                        <div class="label">1 Stelle</div>
                        <div class="time">(0-9)</div>
                    </div>
                    <div class="option-card" data-flashdigits="2" onclick="selectFlashcardDigits(2, this)">
                        <div class="icon">2️⃣</div>
                        <div class="label">2 Stellen</div>
                        <div class="time">(0-99)</div>
                    </div>
                    <div class="option-card" data-flashdigits="3" onclick="selectFlashcardDigits(3, this)">
                        <div class="icon">3️⃣</div>
                        <div class="label">3 Stellen</div>
                        <div class="time">(0-999)</div>
                    </div>
                </div>
            </div>

            <button class="game-start-button" onclick="startFlashcardGame()">🎮 SPIEL STARTEN</button>
        </div>

        <!-- VISUAL TRAINING SETTINGS SCREEN -->
        <div class="screen" id="visualTrainingSettingsScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            <h2 style="font-size: 1.3em; margin-bottom: 15px;">Einstellungen wählen</h2>

            <div class="settings-section" style="margin-bottom: 12px; padding: 12px;">
                <h3 style="font-size: 1em; margin-bottom: 8px;">🎮 Spielmodus wählen</h3>
                <div class="options-grid" style="grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <div class="option-card selected" data-visualmode="flashLeicht" onclick="selectVisualMode('flashLeicht', this)" style="padding: 12px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">⚡</div>
                        <div class="label" style="font-size: 0.95em;">Flash Leicht</div>
                        <div class="time" style="font-size: 0.75em;">(Speed!)</div>
                    </div>
                    <div class="option-card" data-visualmode="flashAddition" onclick="selectVisualMode('flashAddition', this)" style="padding: 12px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">➕</div>
                        <div class="label" style="font-size: 0.95em;">Flash Addition</div>
                        <div class="time" style="font-size: 0.75em;">(Rechnen!)</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 12px; padding: 12px;">
                <h3 style="font-size: 1em; margin-bottom: 8px;">⏱️ Anzeigezeit wählen</h3>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                    <div class="option-card" data-visualspeed="5" onclick="selectVisualSpeed(5, this)" style="padding: 10px 6px;">
                        <div class="icon" style="font-size: 1.5em; margin-bottom: 3px;">🐌</div>
                        <div class="label" style="font-size: 0.85em;">Langsam</div>
                        <div class="time" style="font-size: 0.7em;">5s</div>
                    </div>
                    <div class="option-card" data-visualspeed="4" onclick="selectVisualSpeed(4, this)" style="padding: 10px 6px;">
                        <div class="icon" style="font-size: 1.5em; margin-bottom: 3px;">🐢</div>
                        <div class="label" style="font-size: 0.85em;">Gemütlich</div>
                        <div class="time" style="font-size: 0.7em;">4s</div>
                    </div>
                    <div class="option-card selected" data-visualspeed="3" onclick="selectVisualSpeed(3, this)" style="padding: 10px 6px;">
                        <div class="icon" style="font-size: 1.5em; margin-bottom: 3px;">🏃</div>
                        <div class="label" style="font-size: 0.85em;">Normal</div>
                        <div class="time" style="font-size: 0.7em;">3s</div>
                    </div>
                    <div class="option-card" data-visualspeed="2" onclick="selectVisualSpeed(2, this)" style="padding: 10px 6px;">
                        <div class="icon" style="font-size: 1.5em; margin-bottom: 3px;">🏃‍♂️</div>
                        <div class="label" style="font-size: 0.85em;">Schnell</div>
                        <div class="time" style="font-size: 0.7em;">2s</div>
                    </div>
                    <div class="option-card" data-visualspeed="1" onclick="selectVisualSpeed(1, this)" style="padding: 10px 6px;">
                        <div class="icon" style="font-size: 1.5em; margin-bottom: 3px;">⚡</div>
                        <div class="label" style="font-size: 0.85em;">Blitz</div>
                        <div class="time" style="font-size: 0.7em;">1s</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" id="visualCountSection" style="display: none; margin-bottom: 12px; padding: 12px;">
                <h3 style="font-size: 1em; margin-bottom: 8px;">🧮 Anzahl der Abakusse</h3>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                    <div class="option-card" data-visualcount="2" onclick="selectVisualCount(2, this)" style="padding: 10px 6px;">
                        <div class="label" style="font-size: 0.9em;">2</div>
                    </div>
                    <div class="option-card selected" data-visualcount="3" onclick="selectVisualCount(3, this)" style="padding: 10px 6px;">
                        <div class="label" style="font-size: 0.9em;">3</div>
                    </div>
                    <div class="option-card" data-visualcount="4" onclick="selectVisualCount(4, this)" style="padding: 10px 6px;">
                        <div class="label" style="font-size: 0.9em;">4</div>
                    </div>
                    <div class="option-card" data-visualcount="5" onclick="selectVisualCount(5, this)" style="padding: 10px 6px;">
                        <div class="label" style="font-size: 0.9em;">5</div>
                    </div>
                    <div class="option-card" data-visualcount="7" onclick="selectVisualCount(7, this)" style="padding: 10px 6px;">
                        <div class="label" style="font-size: 0.9em;">7</div>
                    </div>
                    <div class="option-card" data-visualcount="10" onclick="selectVisualCount(10, this)" style="padding: 10px 6px;">
                        <div class="label" style="font-size: 0.9em;">10</div>
                    </div>
                    <div class="option-card" data-visualcount="15" onclick="selectVisualCount(15, this)" style="padding: 10px 6px;">
                        <div class="label" style="font-size: 0.9em;">15</div>
                    </div>
                    <div class="option-card" data-visualcount="20" onclick="selectVisualCount(20, this)" style="padding: 10px 6px;">
                        <div class="label" style="font-size: 0.9em;">20</div>
                    </div>
                    <div class="option-card" data-visualcount="30" onclick="selectVisualCount(30, this)" style="padding: 10px 6px;">
                        <div class="label" style="font-size: 0.9em;">30</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 12px; padding: 12px;">
                <h3 style="font-size: 1em; margin-bottom: 8px;">🔢 Stellenwert wählen</h3>
                <div class="options-grid" style="gap: 10px;">
                    <div class="option-card selected" data-visualdigits="1" onclick="selectVisualDigits(1, this)" style="padding: 12px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">1️⃣</div>
                        <div class="label" style="font-size: 0.95em;">1 Stelle</div>
                        <div class="time" style="font-size: 0.75em;">(0-9)</div>
                    </div>
                    <div class="option-card" data-visualdigits="2" onclick="selectVisualDigits(2, this)" style="padding: 12px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">2️⃣</div>
                        <div class="label" style="font-size: 0.95em;">2 Stellen</div>
                        <div class="time" style="font-size: 0.75em;">(0-99)</div>
                    </div>
                    <div class="option-card" data-visualdigits="3" onclick="selectVisualDigits(3, this)" style="padding: 12px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">3️⃣</div>
                        <div class="label" style="font-size: 0.95em;">3 Stellen</div>
                        <div class="time" style="font-size: 0.75em;">(0-999)</div>
                    </div>
                </div>
            </div>

            <button class="game-start-button" style="margin-top: 10px; padding: 12px 40px; font-size: 1.2em;" onclick="startVisualTrainingGame()">🎮 SPIEL STARTEN</button>
        </div>

        <!-- FLASH CARD GAME SCREEN -->

        <div class="screen" id="flashcardGameScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            
            <div class="flashcard-progress-boxes" id="flashcardProgressBoxes">
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
            </div>

            <div class="flashcard-container">
                <div class="soroban-display" id="sorobanDisplay"></div>
                <div class="flashcard-options" id="flashcardOptions"></div>
            </div>
        </div>

        <!-- SPEED ZÄHLEN SETTINGS SCREEN -->
        <div class="screen" id="speedZahlenSettingsScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            <h2 style="font-size: 1.3em; margin-bottom: 15px;">Einstellungen wählen</h2>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">🎮 Spielmodus wählen</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px;">
                    <div class="option-card selected" data-speedmode="zahlenZahlen" onclick="selectSpeedMode('zahlenZahlen', this)" style="padding: 18px 12px; min-height: 140px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">🔢</div>
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">Zahlen zählen</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">(Nach dem Sehen)</div>
                    </div>
                    <div class="option-card" data-speedmode="schnellFinden" onclick="selectSpeedMode('schnellFinden', this)" style="padding: 18px 12px; min-height: 140px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">👁️</div>
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">Schnell Finden</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">(Vor dem Sehen)</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">🔢 Anzahl der Zahlen</h3>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                    <div class="option-card" data-speedzahl="10" onclick="selectSpeedZahlCount(10, this)" style="padding: 18px 10px;">
                        <div class="label" style="font-size: 1.3em; font-weight: bold;">10</div>
                    </div>
                    <div class="option-card" data-speedzahl="20" onclick="selectSpeedZahlCount(20, this)" style="padding: 18px 10px;">
                        <div class="label" style="font-size: 1.3em; font-weight: bold;">20</div>
                    </div>
                    <div class="option-card selected" data-speedzahl="30" onclick="selectSpeedZahlCount(30, this)" style="padding: 18px 10px;">
                        <div class="label" style="font-size: 1.3em; font-weight: bold;">30</div>
                    </div>
                    <div class="option-card" data-speedzahl="40" onclick="selectSpeedZahlCount(40, this)" style="padding: 18px 10px;">
                        <div class="label" style="font-size: 1.3em; font-weight: bold;">40</div>
                    </div>
                    <div class="option-card" data-speedzahl="50" onclick="selectSpeedZahlCount(50, this)" style="padding: 18px 10px;">
                        <div class="label" style="font-size: 1.3em; font-weight: bold;">50</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">⏱️ Anzeigezeit wählen</h3>
                <div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px;">
                    <div class="option-card" data-speedtime="1" onclick="selectSpeedZahlTime(1, this)" style="padding: 15px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">⚡</div>
                        <div class="label" style="font-size: 1em; font-weight: bold;">1s</div>
                    </div>
                    <div class="option-card" data-speedtime="2" onclick="selectSpeedZahlTime(2, this)" style="padding: 15px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">🏃‍♂️</div>
                        <div class="label" style="font-size: 1em; font-weight: bold;">2s</div>
                    </div>
                    <div class="option-card selected" data-speedtime="3" onclick="selectSpeedZahlTime(3, this)" style="padding: 15px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">🏃</div>
                        <div class="label" style="font-size: 1em; font-weight: bold;">3s</div>
                    </div>
                    <div class="option-card" data-speedtime="5" onclick="selectSpeedZahlTime(5, this)" style="padding: 15px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">🐢</div>
                        <div class="label" style="font-size: 1em; font-weight: bold;">5s</div>
                    </div>
                    <div class="option-card" data-speedtime="7" onclick="selectSpeedZahlTime(7, this)" style="padding: 15px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">🐌</div>
                        <div class="label" style="font-size: 1em; font-weight: bold;">7s</div>
                    </div>
                    <div class="option-card" data-speedtime="10" onclick="selectSpeedZahlTime(10, this)" style="padding: 15px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">🕐</div>
                        <div class="label" style="font-size: 1em; font-weight: bold;">10s</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">❓ Anzahl der Fragen</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <div class="option-card" data-speedquestions="5" onclick="selectSpeedZahlQuestions(5, this)" style="padding: 20px 15px;">
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">5 Fragen</div>
                    </div>
                    <div class="option-card selected" data-speedquestions="8" onclick="selectSpeedZahlQuestions(8, this)" style="padding: 20px 15px;">
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">8 Fragen</div>
                    </div>
                    <div class="option-card" data-speedquestions="10" onclick="selectSpeedZahlQuestions(10, this)" style="padding: 20px 15px;">
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">10 Fragen</div>
                    </div>
                </div>
            </div>

            <button class="game-start-button" style="margin-top: 15px; padding: 15px 50px; font-size: 1.3em;" onclick="startSpeedZahlenGame()">🎮 SPIEL STARTEN</button>
        </div>

        <!-- SPEED ZÄHLEN GAME SCREEN -->
        <div class="screen" id="speedZahlenGameScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            
            <div class="flashcard-progress-boxes" id="speedZahlenProgressBoxes">
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
            </div>

            <div id="speedZahlenNumberDisplay" style="position: relative; width: 100%; height: 60vh; display: flex; align-items: center; justify-content: center;">
                <!-- Numbers will be scattered here -->
            </div>

            <div id="speedZahlenQuestionSection" style="display: none; max-width: 600px; margin: 0 auto; padding: 20px;">
                <h3 style="color: white; font-size: 2em; margin-bottom: 20px; text-align: center;">Wie viele <span id="speedZahlenTargetNumber" style="color: #FFD700; font-size: 1.5em;"></span> waren es?</h3>
                <div class="flashcard-options" id="speedZahlenOptions"></div>
            </div>
        </div>

        <!-- MULTIDIV CARDS SETTINGS SCREEN -->
        <div class="screen" id="multiDivSettingsScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            <h2 style="font-size: 1.3em; margin-bottom: 15px;">MultiDiv Cards Einstellungen</h2>

            <!-- Mode Selection -->
            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">🎮 Modus wählen</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="option-card selected" data-multidivmode="multiplication" onclick="selectMultiDivMode('multiplication', this)" style="padding: 20px 15px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">✖️</div>
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">Multiplikation</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">3 × ? = 24</div>
                    </div>
                    <div class="option-card" data-multidivmode="division" onclick="selectMultiDivMode('division', this)" style="padding: 20px 15px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">➗</div>
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">Division</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">24 : ? = 3</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">🎯 Schwierigkeitsgrad</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <div class="option-card selected" data-multidivdifficulty="leicht" onclick="selectMultiDivDifficulty('leicht', this)" style="padding: 18px 12px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">😊</div>
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">Leicht</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;" id="difficultyLeichtExample">2 × 3</div>
                    </div>
                    <div class="option-card" data-multidivdifficulty="mittel" onclick="selectMultiDivDifficulty('mittel', this)" style="padding: 18px 12px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">🤔</div>
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">Mittel</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;" id="difficultyMittelExample">12 × 4</div>
                    </div>
                    <div class="option-card" data-multidivdifficulty="schwer" onclick="selectMultiDivDifficulty('schwer', this)" style="padding: 18px 12px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">🔥</div>
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">Schwer</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;" id="difficultySchwerExample">23 × 15</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">🔢 Ergebnis Stellenwert</h3>
                <div class="options-grid" style="gap: 10px;">
                    <div class="option-card selected" data-multidivdigits="1" onclick="selectMultiDivDigits(1, this)" style="padding: 12px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">1️⃣</div>
                        <div class="label" style="font-size: 0.95em;">1 Stelle</div>
                        <div class="time" style="font-size: 0.75em;">(0-9)</div>
                    </div>
                    <div class="option-card" data-multidivdigits="2" onclick="selectMultiDivDigits(2, this)" style="padding: 12px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">2️⃣</div>
                        <div class="label" style="font-size: 0.95em;">2 Stellen</div>
                        <div class="time" style="font-size: 0.75em;">(10-99)</div>
                    </div>
                    <div class="option-card" data-multidivdigits="3" onclick="selectMultiDivDigits(3, this)" style="padding: 12px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">3️⃣</div>
                        <div class="label" style="font-size: 0.95em;">3 Stellen</div>
                        <div class="time" style="font-size: 0.75em;">(100-999)</div>
                    </div>
                </div>
            </div>

            <button class="game-start-button" style="margin-top: 15px; padding: 15px 50px; font-size: 1.3em;" onclick="startMultiDivGame()">🎮 SPIEL STARTEN</button>
        </div>

        <!-- MULTIDIV CARDS GAME SCREEN -->
        <div class="screen" id="multiDivGameScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            
            <div class="flashcard-progress-boxes" id="multiDivProgressBoxes">
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
            </div>

            <div class="flashcard-container" style="max-width: 700px;">
                <!-- Question Card -->
                <div style="background: linear-gradient(135deg, rgba(155, 89, 182, 0.15) 0%, rgba(142, 68, 173, 0.1) 100%); border-radius: 30px; padding: 30px; margin-bottom: 30px; text-align: center;">
                    <h2 id="multiDivQuestion" style="color: white; font-size: 3.5em; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">3 × ? = 24</h2>
                </div>

                <!-- Abacus Options -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;" id="multiDivAbacusOptions">
                    <!-- Abacus options will be inserted here -->
                </div>
            </div>
        </div>

        <!-- ZAHLEN MERKEN SETTINGS SCREEN -->
        <div class="screen" id="zahlenMerkenSettingsScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            <h2 style="font-size: 1.3em; margin-bottom: 15px;">Zahlen Merken Einstellungen</h2>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">🎮 Modus wählen</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="option-card selected" data-memorymode="vorwarts" onclick="selectMemoryMode('vorwarts', this)" style="padding: 20px 15px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">➡️</div>
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">Vorwärts</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">3-7-2-9</div>
                    </div>
                    <div class="option-card" data-memorymode="ruckwarts" onclick="selectMemoryMode('ruckwarts', this)" style="padding: 20px 15px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">⬅️</div>
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">Rückwärts</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">9-2-7-3</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">🔢 Anzahl der Zahlen</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <div class="option-card" data-memorycount="3" onclick="selectMemoryCount(3, this)" style="padding: 18px 12px;">
                        <div class="label" style="font-size: 1.3em; font-weight: bold;">3</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Sehr Leicht</div>
                    </div>
                    <div class="option-card selected" data-memorycount="4" onclick="selectMemoryCount(4, this)" style="padding: 18px 12px;">
                        <div class="label" style="font-size: 1.3em; font-weight: bold;">4</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Leicht</div>
                    </div>
                    <div class="option-card" data-memorycount="5" onclick="selectMemoryCount(5, this)" style="padding: 18px 12px;">
                        <div class="label" style="font-size: 1.3em; font-weight: bold;">5</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Mittel</div>
                    </div>
                    <div class="option-card" data-memorycount="6" onclick="selectMemoryCount(6, this)" style="padding: 18px 12px;">
                        <div class="label" style="font-size: 1.3em; font-weight: bold;">6</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Schwer</div>
                    </div>
                    <div class="option-card" data-memorycount="7" onclick="selectMemoryCount(7, this)" style="padding: 18px 12px;">
                        <div class="label" style="font-size: 1.3em; font-weight: bold;">7</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Sehr Schwer</div>
                    </div>
                    <div class="option-card" data-memorycount="8" onclick="selectMemoryCount(8, this)" style="padding: 18px 12px;">
                        <div class="label" style="font-size: 1.3em; font-weight: bold;">8</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Extrem</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">⏱️ Anzeigezeit</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <div class="option-card selected" data-memorytime="3" onclick="selectMemoryTime(3, this)" style="padding: 18px 12px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">⚡</div>
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">3 Sek</div>
                    </div>
                    <div class="option-card" data-memorytime="5" onclick="selectMemoryTime(5, this)" style="padding: 18px 12px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">🏃</div>
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">5 Sek</div>
                    </div>
                    <div class="option-card" data-memorytime="7" onclick="selectMemoryTime(7, this)" style="padding: 18px 12px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">🐢</div>
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">7 Sek</div>
                    </div>
                </div>
            </div>

            <button class="game-start-button" style="margin-top: 15px; padding: 15px 50px; font-size: 1.3em;" onclick="startZahlenMerkenGame()">🎮 SPIEL STARTEN</button>
        </div>

        <!-- ZAHLEN MERKEN GAME SCREEN -->
        <div class="screen" id="zahlenMerkenGameScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            
            <div class="flashcard-progress-boxes" id="zahlenMerkenProgressBoxes">
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
            </div>

            <!-- Numbers Display Area -->
            <div id="zahlenMerkenDisplay" style="min-height: 200px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px;">
                <!-- Numbers will be displayed here -->
            </div>

            <!-- Answer Input Area -->
            <div id="zahlenMerkenAnswerSection" style="display: none; max-width: 600px; margin: 0 auto; padding: 20px;">
                <h3 style="color: white; font-size: 1.5em; margin-bottom: 15px; text-align: center;" id="zahlenMerkenPrompt">Welche Zahlen waren es?</h3>
                
                <!-- User's answer display -->
                <div style="background: linear-gradient(145deg, #ffffff 0%, #f0f0f0 100%); border-radius: 20px; padding: 20px; margin-bottom: 15px; min-height: 60px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2), inset 0 -2px 4px rgba(0, 0, 0, 0.1), inset 0 2px 4px rgba(255, 255, 255, 0.8); border: 3px solid rgba(255, 255, 255, 0.5);">
                    <div id="zahlenMerkenUserAnswer" style="font-size: 2em; font-weight: bold; color: #333; letter-spacing: 8px;">
                        <span style="color: #999;">-</span>
                    </div>
                </div>

                <!-- Number buttons -->
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 15px;">
                    <button class="key-button" onclick="addMemoryDigit(0)" style="grid-column: 1;">0</button>
                    <button class="key-button" onclick="addMemoryDigit(1)">1</button>
                    <button class="key-button" onclick="addMemoryDigit(2)">2</button>
                    <button class="key-button" onclick="addMemoryDigit(3)">3</button>
                    <button class="key-button" onclick="addMemoryDigit(4)">4</button>
                    <button class="key-button" onclick="addMemoryDigit(5)">5</button>
                    <button class="key-button" onclick="addMemoryDigit(6)">6</button>
                    <button class="key-button" onclick="addMemoryDigit(7)">7</button>
                    <button class="key-button" onclick="addMemoryDigit(8)">8</button>
                    <button class="key-button" onclick="addMemoryDigit(9)">9</button>
                </div>

                <!-- Control buttons -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button class="key-button delete" onclick="deleteMemoryDigit()">⌫ Löschen</button>
                    <button class="submit-button" onclick="checkMemoryAnswer()">✓ Prüfen</button>
                </div>
            </div>
        </div>

        <!-- ZAHLEN VERGLEICHEN SETTINGS SCREEN -->
        <div class="screen" id="zahlenVergleichenSettingsScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            <h2 style="font-size: 1.3em; margin-bottom: 15px;">Zahlen Vergleichen Einstellungen</h2>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">🎮 Modus wählen</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div class="option-card selected" data-comparemode="groesser" onclick="selectCompareMode('groesser', this)" style="padding: 20px 15px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">🔼</div>
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">Welche ist größer?</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">2 Abakusse</div>
                    </div>
                    <div class="option-card" data-comparemode="kleiner" onclick="selectCompareMode('kleiner', this)" style="padding: 20px 15px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">🔽</div>
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">Welche ist kleiner?</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">2 Abakusse</div>
                    </div>
                    <div class="option-card" data-comparemode="groesste" onclick="selectCompareMode('groesste', this)" style="padding: 20px 15px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">🏆</div>
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">Die Größte finden</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">3 Abakusse</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">🔢 Stellenwert</h3>
                <div class="options-grid" style="gap: 10px;">
                    <div class="option-card selected" data-comparedigits="1" onclick="selectCompareDigits(1, this)" style="padding: 12px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">1️⃣</div>
                        <div class="label" style="font-size: 0.95em;">1 Stelle</div>
                        <div class="time" style="font-size: 0.75em;">(0-9)</div>
                    </div>
                    <div class="option-card" data-comparedigits="2" onclick="selectCompareDigits(2, this)" style="padding: 12px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">2️⃣</div>
                        <div class="label" style="font-size: 0.95em;">2 Stellen</div>
                        <div class="time" style="font-size: 0.75em;">(10-99)</div>
                    </div>
                    <div class="option-card" data-comparedigits="3" onclick="selectCompareDigits(3, this)" style="padding: 12px 8px;">
                        <div class="icon" style="font-size: 2em; margin-bottom: 5px;">3️⃣</div>
                        <div class="label" style="font-size: 0.95em;">3 Stellen</div>
                        <div class="time" style="font-size: 0.75em;">(100-999)</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">⚡ Schwierigkeitsgrad</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <div class="option-card selected" data-comparedifficulty="leicht" onclick="selectCompareDifficulty('leicht', this)" style="padding: 18px 12px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">😊</div>
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">Leicht</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Große Unterschiede</div>
                    </div>
                    <div class="option-card" data-comparedifficulty="mittel" onclick="selectCompareDifficulty('mittel', this)" style="padding: 18px 12px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">🤔</div>
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">Mittel</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Normale Unterschiede</div>
                    </div>
                    <div class="option-card" data-comparedifficulty="schwer" onclick="selectCompareDifficulty('schwer', this)" style="padding: 18px 12px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">🔥</div>
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">Schwer</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Sehr ähnlich</div>
                    </div>
                </div>
            </div>

            <button class="game-start-button" style="margin-top: 15px; padding: 15px 50px; font-size: 1.3em;" onclick="startZahlenVergleichenGame()">🎮 SPIEL STARTEN</button>
        </div>

        <!-- ZAHLEN VERGLEICHEN GAME SCREEN -->
        <div class="screen" id="zahlenVergleichenGameScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            
            <div class="flashcard-progress-boxes" id="zahlenVergleichenProgressBoxes">
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
            </div>

            <h2 id="zahlenVergleichenQuestion" style="color: white; font-size: 2em; text-align: center; margin-bottom: 30px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Welche ist größer?</h2>

            <div id="zahlenVergleichenOptions" style="display: grid; gap: 30px; max-width: 900px; margin: 0 auto; padding: 20px;">
                <!-- Abacus options will be inserted here (2 or 3 based on mode) -->
            </div>
        </div>

        <!-- LOGIK RÄTSEL SETTINGS SCREEN -->
        <div class="screen" id="logikRatselSettingsScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            <h2 style="font-size: 1.3em; margin-bottom: 15px;">Logik Rätsel Einstellungen</h2>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">🎮 Muster-Typ wählen</h3>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
                    <div class="option-card selected" data-patterntype="addition" onclick="selectPatternType('addition', this)" style="padding: 20px 15px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">➕</div>
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">Addition</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">2-4-6-?</div>
                    </div>
                    <div class="option-card" data-patterntype="subtraktion" onclick="selectPatternType('subtraktion', this)" style="padding: 20px 15px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">➖</div>
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">Subtraktion</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">10-8-6-?</div>
                    </div>
                    <div class="option-card" data-patterntype="multiplikation" onclick="selectPatternType('multiplikation', this)" style="padding: 20px 15px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">✖️</div>
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">Multiplikation</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">2-4-8-?</div>
                    </div>
                    <div class="option-card" data-patterntype="gemischt" onclick="selectPatternType('gemischt', this)" style="padding: 20px 15px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">🎲</div>
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">Gemischt</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Überraschung!</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">⚡ Schwierigkeitsgrad</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <div class="option-card selected" data-patterndifficulty="leicht" onclick="selectPatternDifficulty('leicht', this)" style="padding: 18px 12px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">😊</div>
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">Leicht</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Einfache Muster</div>
                    </div>
                    <div class="option-card" data-patterndifficulty="mittel" onclick="selectPatternDifficulty('mittel', this)" style="padding: 18px 12px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">🤔</div>
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">Mittel</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Mittlere Muster</div>
                    </div>
                    <div class="option-card" data-patterndifficulty="schwer" onclick="selectPatternDifficulty('schwer', this)" style="padding: 18px 12px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">🔥</div>
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">Schwer</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Komplexe Muster</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">🔢 Anzahl der Zahlen</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px;">
                    <div class="option-card selected" data-patterncount="3" onclick="selectPatternCount(3, this)" style="padding: 18px 12px;">
                        <div class="label" style="font-size: 1.3em; font-weight: bold;">3 Zahlen</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">+ Fragezeichen</div>
                    </div>
                    <div class="option-card" data-patterncount="4" onclick="selectPatternCount(4, this)" style="padding: 18px 12px;">
                        <div class="label" style="font-size: 1.3em; font-weight: bold;">4 Zahlen</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">+ Fragezeichen</div>
                    </div>
                    <div class="option-card" data-patterncount="5" onclick="selectPatternCount(5, this)" style="padding: 18px 12px;">
                        <div class="label" style="font-size: 1.3em; font-weight: bold;">5 Zahlen</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">+ Fragezeichen</div>
                    </div>
                </div>
            </div>

            <button class="game-start-button" style="margin-top: 15px; padding: 15px 50px; font-size: 1.3em;" onclick="startLogikRatselGame()">🎮 SPIEL STARTEN</button>
        </div>

        <!-- LOGIK RÄTSEL GAME SCREEN -->
        <div class="screen" id="logikRatselGameScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            
            <div class="flashcard-progress-boxes" id="logikRatselProgressBoxes">
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
            </div>

            <h2 style="color: white; font-size: 2em; text-align: center; margin-bottom: 30px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Welche Zahl kommt als Nächstes?</h2>

            <div id="logikRatselPattern" style="display: flex; justify-content: center; align-items: center; gap: 20px; margin-bottom: 40px; flex-wrap: wrap; padding: 20px;"></div>

            <div id="logikRatselOptions" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 800px; margin: 0 auto; padding: 20px;"></div>
        </div>

        <!-- SESLI ANZAN SETTINGS SCREEN -->
        <div class="screen" id="sesliAnzanSettingsScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            <h2>Einstellungen wählen</h2>

            <!-- Spielmodus + Rechenart (Yan Yana) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <!-- Spielmodus wählen -->
                <div class="settings-section" style="margin-bottom: 0;">
                    <h3>🎮 Spielmodus wählen</h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                        <div class="option-card selected" data-seslimode="sehenHoren" onclick="selectSesliAnzanMode('sehenHoren', this)">
                            <div class="icon" style="font-size: 2em;">📺+🔊</div>
                            <div class="label" style="font-size: 1em;">Sehen + Hören</div>
                            <div class="time" style="font-size: 0.75em;">(Zahlen sichtbar)</div>
                        </div>
                        <div class="option-card" data-seslimode="nurHoren" onclick="selectSesliAnzanMode('nurHoren', this)">
                            <div class="icon" style="font-size: 2em;">🔊</div>
                            <div class="label" style="font-size: 1em;">Nur Hören</div>
                            <div class="time" style="font-size: 0.75em;">(Nur Audio)</div>
                        </div>
                    </div>
                </div>

                <!-- Rechenart wählen -->
                <div class="settings-section" style="margin-bottom: 0;">
                    <h3>Rechenart wählen</h3>
                    <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
                        <div class="option-card selected" data-type="addition" onclick="selectOption('rechenart', 'addition', this)">
                            <div class="icon">➕</div>
                            <div class="label">Addition</div>
                        </div>
                        <div class="option-card" data-type="subtraktion" onclick="selectOption('rechenart', 'subtraktion', this)">
                            <div class="icon">➖</div>
                            <div class="label">Subtraktion</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Geschwindigkeit wählen -->
            <div class="settings-section" id="sesliGeschwindigkeitSection">
                <h3>Geschwindigkeit wählen</h3>
                <div class="options-grid" style="grid-template-columns: repeat(5, 1fr);">
                    <div class="option-card" data-speed="langsam" onclick="selectOption('geschwindigkeit', 4000, this)">
                        <div class="icon">🐌</div>
                        <div class="label">Langsam</div>
                        <div class="time">4s</div>
                    </div>
                    <div class="option-card selected" data-speed="normal" onclick="selectOption('geschwindigkeit', 3000, this)">
                        <div class="icon">🏃</div>
                        <div class="label">Normal</div>
                        <div class="time">3s</div>
                    </div>
                    <div class="option-card" data-speed="schnell" onclick="selectOption('geschwindigkeit', 2000, this)">
                        <div class="icon">🏃‍♂️</div>
                        <div class="label">Schnell</div>
                        <div class="time">2s</div>
                    </div>
                    <div class="option-card" data-speed="sehr-schnell" onclick="selectOption('geschwindigkeit', 1000, this)">
                        <div class="icon">⚡</div>
                        <div class="label">Sehr Schnell</div>
                        <div class="time">1s</div>
                    </div>
                    <div class="option-card" data-speed="ultra-schnell" onclick="selectOption('geschwindigkeit', 800, this)">
                        <div class="icon">🚀</div>
                        <div class="label">Ultra Schnell</div>
                        <div class="time">0.8s</div>
                    </div>
                </div>
            </div>

            <!-- Zahlenbereich wählen -->
            <div class="settings-section" id="sesliZahlenbereichSection">
                <h3>Zahlenbereich wählen</h3>
                
                <!-- Standard für Addition/Subtraktion -->
                <div id="sesliStandardZahlenbereich">
                    <div class="options-grid" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="option-card" data-range="1-5" onclick="selectOption('zahlenbereich', [1, 5], this)">
                            <div class="label">1-5</div>
                        </div>
                        <div class="option-card selected" data-range="1-10" onclick="selectOption('zahlenbereich', [1, 10], this)">
                            <div class="label">1-10</div>
                        </div>
                        <div class="option-card" data-range="1-20" onclick="selectOption('zahlenbereich', [1, 20], this)">
                            <div class="label">1-20</div>
                        </div>
                        <div class="option-card" data-range="1-50" onclick="selectOption('zahlenbereich', [1, 50], this)">
                            <div class="label">1-50</div>
                        </div>
                    </div>
                    
                    <!-- Eigener Bereich + Meine Aufgaben (Yan Yana) -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                        <!-- Eigener Bereich -->
                        <div class="custom-range-section" style="margin: 0;">
                            <div class="option-card" data-range="custom" onclick="toggleCustomRange(this)">
                                <div class="label">Eigener Bereich</div>
                            </div>
                            <div class="custom-range-inputs" id="sesliCustomRangeInputs" style="display: none;">
                                <div class="input-group">
                                    <label>Von:</label>
                                    <input type="number" id="sesliCustomMin" value="1" min="0" max="9999">
                                </div>
                                <div class="input-group">
                                    <label>Bis:</label>
                                    <input type="number" id="sesliCustomMax" value="100" min="1" max="10000">
                                </div>
                            </div>
                        </div>

                        <!-- Meine Aufgaben Button -->
                        <div style="display: flex; align-items: flex-start;">
                            <button class="custom-task-button" onclick="showMeineAufgaben()" style="margin: 0; height: 100%; display: flex; align-items: center; justify-content: center;">
                                📚 Meine Aufgaben
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Anzahl der Zahlen pro Aufgabe -->
            <div class="settings-section" id="sesliAnzahlSection">
                <h3>Anzahl der Zahlen pro Aufgabe</h3>
                <div class="options-grid" style="grid-template-columns: repeat(8, 1fr);">
                    <div class="option-card" data-count="2" onclick="selectOption('anzahl', 2, this)">
                        <div class="label">2</div>
                    </div>
                    <div class="option-card selected" data-count="3" onclick="selectOption('anzahl', 3, this)">
                        <div class="label">3</div>
                    </div>
                    <div class="option-card" data-count="4" onclick="selectOption('anzahl', 4, this)">
                        <div class="label">4</div>
                    </div>
                    <div class="option-card" data-count="5" onclick="selectOption('anzahl', 5, this)">
                        <div class="label">5</div>
                    </div>
                    <div class="option-card" data-count="6" onclick="selectOption('anzahl', 6, this)">
                        <div class="label">6</div>
                    </div>
                    <div class="option-card" data-count="7" onclick="selectOption('anzahl', 7, this)">
                        <div class="label">7</div>
                    </div>
                    <div class="option-card" data-count="8" onclick="selectOption('anzahl', 8, this)">
                        <div class="label">8</div>
                    </div>
                    <div class="option-card" data-count="9" onclick="selectOption('anzahl', 9, this)">
                        <div class="label">9</div>
                    </div>
                    <div class="option-card" data-count="10" onclick="selectOption('anzahl', 10, this)">
                        <div class="label">10</div>
                    </div>
                    <div class="option-card" data-count="15" onclick="selectOption('anzahl', 15, this)">
                        <div class="label">15</div>
                    </div>
                    <div class="option-card" data-count="20" onclick="selectOption('anzahl', 20, this)">
                        <div class="label">20</div>
                    </div>
                    <div class="option-card" data-count="25" onclick="selectOption('anzahl', 25, this)">
                        <div class="label">25</div>
                    </div>
                    <div class="option-card" data-count="30" onclick="selectOption('anzahl', 30, this)">
                        <div class="label">30</div>
                    </div>
                    <div class="option-card" data-count="40" onclick="selectOption('anzahl', 40, this)">
                        <div class="label">40</div>
                    </div>
                    <div class="option-card" data-count="50" onclick="selectOption('anzahl', 50, this)">
                        <div class="label">50</div>
                    </div>
                    <div class="option-card" data-count="60" onclick="selectOption('anzahl', 60, this)">
                        <div class="label">60</div>
                    </div>
                </div>
                <div class="example-text">Beispiel: 2 + 4 + 6 = ?</div>
            </div>

            <button class="game-start-button" onclick="startSesliAnzanGame()">🎮 SPIEL STARTEN</button>
        </div>

        <!-- FARB SPIEL SETTINGS SCREEN -->
        <div class="screen" id="farbSpielSettingsScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            <h2 style="font-size: 1.3em; margin-bottom: 15px;">Sag die richtige Farbe! - Einstellungen</h2>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">🎮 Spielmodus wählen</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                    <div class="option-card selected" data-farbmode="congruent" onclick="selectFarbMode('congruent', this)" style="padding: 20px 15px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">😊</div>
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">Kongruent</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Farbe = Wort</div>
                    </div>
                    <div class="option-card" data-farbmode="incongruent" onclick="selectFarbMode('incongruent', this)" style="padding: 20px 15px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">🤯</div>
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">Inkongruent</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Farbe ≠ Wort</div>
                    </div>
                    <div class="option-card" data-farbmode="farbenMerken" onclick="selectFarbMode('farbenMerken', this)" style="padding: 20px 15px;">
                        <div class="icon" style="font-size: 2.5em; margin-bottom: 8px;">🧠</div>
                        <div class="label" style="font-size: 1.2em; font-weight: bold;">Farben Merken</div>
                        <div class="time" style="font-size: 0.85em; margin-top: 5px;">Memory Challenge</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">⏱️ Geschwindigkeit wählen</h3>
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
                    <div class="option-card" data-farbspeed="langsam" onclick="selectFarbSpeed(4000, this)" style="padding: 15px 10px;">
                        <div class="icon" style="font-size: 1.8em; margin-bottom: 5px;">🐌</div>
                        <div class="label" style="font-size: 1em; font-weight: bold;">Langsam</div>
                        <div class="time" style="font-size: 0.8em;">4s</div>
                    </div>
                    <div class="option-card selected" data-farbspeed="normal" onclick="selectFarbSpeed(3000, this)" style="padding: 15px 10px;">
                        <div class="icon" style="font-size: 1.8em; margin-bottom: 5px;">🏃</div>
                        <div class="label" style="font-size: 1em; font-weight: bold;">Normal</div>
                        <div class="time" style="font-size: 0.8em;">3s</div>
                    </div>
                    <div class="option-card" data-farbspeed="schnell" onclick="selectFarbSpeed(2000, this)" style="padding: 15px 10px;">
                        <div class="icon" style="font-size: 1.8em; margin-bottom: 5px;">🏃‍♂️</div>
                        <div class="label" style="font-size: 1em; font-weight: bold;">Schnell</div>
                        <div class="time" style="font-size: 0.8em;">2s</div>
                    </div>
                    <div class="option-card" data-farbspeed="sehr-schnell" onclick="selectFarbSpeed(1000, this)" style="padding: 15px 10px;">
                        <div class="icon" style="font-size: 1.8em; margin-bottom: 5px;">⚡</div>
                        <div class="label" style="font-size: 1em; font-weight: bold;">Sehr Schnell</div>
                        <div class="time" style="font-size: 0.8em;">1s</div>
                    </div>
                    <div class="option-card" data-farbspeed="ultra-schnell" onclick="selectFarbSpeed(800, this)" style="padding: 15px 10px;">
                        <div class="icon" style="font-size: 1.8em; margin-bottom: 5px;">🚀</div>
                        <div class="label" style="font-size: 1em; font-weight: bold;">Ultra Schnell</div>
                        <div class="time" style="font-size: 0.8em;">0.8s</div>
                    </div>
                    <div class="option-card" data-farbspeed="blitz" onclick="selectFarbSpeed(600, this)" style="padding: 15px 10px;">
                        <div class="icon" style="font-size: 1.8em; margin-bottom: 5px;">⚡🔥</div>
                        <div class="label" style="font-size: 1em; font-weight: bold;">Blitz</div>
                        <div class="time" style="font-size: 0.8em;">0.6s</div>
                    </div>
                    <div class="option-card" data-farbspeed="extrem" onclick="selectFarbSpeed(500, this)" style="padding: 15px 10px;">
                        <div class="icon" style="font-size: 1.8em; margin-bottom: 5px;">💥</div>
                        <div class="label" style="font-size: 1em; font-weight: bold;">Extrem</div>
                        <div class="time" style="font-size: 0.8em;">0.5s</div>
                    </div>
                    <div class="option-card" data-farbspeed="meister" onclick="selectFarbSpeed(400, this)" style="padding: 15px 10px;">
                        <div class="icon" style="font-size: 1.8em; margin-bottom: 5px;">🏆</div>
                        <div class="label" style="font-size: 1em; font-weight: bold;">Meister</div>
                        <div class="time" style="font-size: 0.8em;">0.4s</div>
                    </div>
                </div>
            </div>

            <div class="settings-section" style="margin-bottom: 15px; padding: 15px;">
                <h3 style="font-size: 1.1em; margin-bottom: 12px;">🎨 Anzahl der Farben</h3>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
                    <div class="option-card" data-farbanzahl="5" onclick="selectFarbAnzahl(5, this)" style="padding: 15px 10px;">
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">5</div>
                    </div>
                    <div class="option-card selected" data-farbanzahl="10" onclick="selectFarbAnzahl(10, this)" style="padding: 15px 10px;">
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">10</div>
                    </div>
                    <div class="option-card" data-farbanzahl="15" onclick="selectFarbAnzahl(15, this)" style="padding: 15px 10px;">
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">15</div>
                    </div>
                    <div class="option-card" data-farbanzahl="20" onclick="selectFarbAnzahl(20, this)" style="padding: 15px 10px;">
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">20</div>
                    </div>
                    <div class="option-card" data-farbanzahl="30" onclick="selectFarbAnzahl(30, this)" style="padding: 15px 10px;">
                        <div class="label" style="font-size: 1.1em; font-weight: bold;">30</div>
                    </div>
                </div>
            </div>

            <button class="game-start-button" style="margin-top: 15px; padding: 15px 50px; font-size: 1.3em;" onclick="startFarbSpielGame()">🎮 SPIEL STARTEN</button>
        </div>

        <!-- FARB SPIEL GAME SCREEN -->
        <div class="screen" id="farbSpielGameScreen" style="padding: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <!-- Top Bar -->
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: rgba(255,255,255,0.95); border-radius: 30px; margin: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <span style="font-size: 2em;">📊</span>
                    <span id="farbSpielCounter" style="font-size: 2.2em; font-weight: bold; color: #333;">0/10</span>
                    <span style="font-size: 2em; color: #4CAF50;">✓</span>
                    <span style="font-size: 2em; color: #999;">0</span>
                    <span style="font-size: 2em; color: #999;">●</span>
                </div>
                <button onclick="goHome()" style="background: linear-gradient(145deg, #FF5252, #E53935); color: white; border: none; padding: 15px 35px; border-radius: 15px; font-size: 1.3em; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(255,82,82,0.4); transition: all 0.3s ease;">
                    <span style="font-size: 1.2em;">🔄</span> Beenden
                </button>
            </div>

            <!-- Main Color Display -->
            <div id="farbSpielMainDisplay" style="background: rgba(255,255,255,0.98); border-radius: 30px; margin: 20px; padding: 80px 40px; min-height: 400px; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 30px rgba(0,0,0,0.15);">
                <div id="farbSpielWordDisplay" style="font-size: 12em; font-weight: 900; text-align: center; line-height: 1;"></div>
            </div>

            <!-- Answer Section for Farben Merken Mode -->
            <div id="farbSpielAnswerSection" style="display: none; padding: 20px; margin: 20px;">
                <h2 style="color: white; font-size: 2.5em; text-align: center; margin-bottom: 30px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                    Klicke die Farben in der richtigen Reihenfolge!
                </h2>
                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; max-width: 900px; margin: 0 auto;">
                    <button onclick="selectFarbenMerkenColor('rot')" style="background: #FF0000; color: white; font-size: 1.8em; font-weight: bold; padding: 40px 20px; border-radius: 20px; border: 4px solid rgba(255,255,255,0.3); cursor: pointer; transition: all 0.3s ease; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                        ROT
                    </button>
                    <button onclick="selectFarbenMerkenColor('blau')" style="background: #0000FF; color: white; font-size: 1.8em; font-weight: bold; padding: 40px 20px; border-radius: 20px; border: 4px solid rgba(255,255,255,0.3); cursor: pointer; transition: all 0.3s ease; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                        BLAU
                    </button>
                    <button onclick="selectFarbenMerkenColor('gelb')" style="background: #FFD700; color: white; font-size: 1.8em; font-weight: bold; padding: 40px 20px; border-radius: 20px; border: 4px solid rgba(255,255,255,0.3); cursor: pointer; transition: all 0.3s ease; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                        GELB
                    </button>
                    <button onclick="selectFarbenMerkenColor('grun')" style="background: #00FF00; color: white; font-size: 1.8em; font-weight: bold; padding: 40px 20px; border-radius: 20px; border: 4px solid rgba(255,255,255,0.3); cursor: pointer; transition: all 0.3s ease; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                        GRÜN
                    </button>
                    <button onclick="selectFarbenMerkenColor('rosa')" style="background: #FF69B4; color: white; font-size: 1.8em; font-weight: bold; padding: 40px 20px; border-radius: 20px; border: 4px solid rgba(255,255,255,0.3); cursor: pointer; transition: all 0.3s ease; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">
                        ROSA
                    </button>
                </div>
                <div id="farbenMerkenFeedback" style="margin-top: 30px; text-align: center; font-size: 2em; font-weight: bold; min-height: 60px;"></div>
            </div>

            <!-- Progress Bar -->
            <div style="margin: 20px; padding: 0 20px;">
                <div style="height: 15px; background: linear-gradient(90deg, #4CAF50 0%, #2196F3 100%); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); position: relative; overflow: hidden;">
                    <div id="farbSpielProgressBar" style="position: absolute; top: 0; left: 0; height: 100%; width: 0%; background: rgba(255,255,255,0.3); transition: width 0.3s ease;"></div>
                </div>
            </div>

            <!-- End Message (hidden initially) -->
            <div id="farbSpielEndMessage" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; flex-direction: column; gap: 30px;">
                <h2 style="color: white; font-size: 5em; margin: 0;">🎉 FERTIG! 🎉</h2>
                <div class="button-group" style="flex-direction: row;">
                    <button class="restart-button" onclick="startFarbSpielGame()">🔄 Nochmal</button>
                    <button class="new-settings-button" onclick="showFarbSpielSettings()">⚙️ Neue Einstellungen</button>
                    <button class="home-button" onclick="goHome()">🏠 Startseite</button>
                </div>
            </div>
        </div>

        <!-- SOROBAN MATHE SETTINGS SCREEN -->
        <div class="screen" id="sorobanMatheSettingsScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            <h2>Einstellungen wählen</h2>

            <!-- Rechenart wählen -->
            <div class="settings-section">
                <h3>Rechenart wählen</h3>
                <div class="options-grid" style="grid-template-columns: repeat(4, 1fr);">
                    <div class="option-card selected" data-sorobanop="addition" onclick="selectSorobanOperation('addition', this)">
                        <div class="icon">➕</div>
                        <div class="label">Addition</div>
                    </div>
                    <div class="option-card" data-sorobanop="subtraktion" onclick="selectSorobanOperation('subtraktion', this)">
                        <div class="icon">➖</div>
                        <div class="label">Subtraktion</div>
                    </div>
                    <div class="option-card" data-sorobanop="multiplikation" onclick="selectSorobanOperation('multiplikation', this)">
                        <div class="icon">✖️</div>
                        <div class="label">Multiplikation</div>
                    </div>
                    <div class="option-card" data-sorobanop="division" onclick="selectSorobanOperation('division', this)">
                        <div class="icon">➗</div>
                        <div class="label">Division</div>
                    </div>
                </div>
            </div>

            <!-- Schwierigkeitsgrad + Stellenwert (Yan Yana) -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <!-- Schwierigkeitsgrad -->
                <div class="settings-section" style="margin-bottom: 0;">
                    <h3>⚡ Schwierigkeitsgrad</h3>
                    <div class="options-grid">
                        <div class="option-card selected" data-sorobandiff="leicht" onclick="selectSorobanDifficulty('leicht', this)">
                            <div class="icon">😊</div>
                            <div class="label">Leicht</div>
                        </div>
                        <div class="option-card" data-sorobandiff="mittel" onclick="selectSorobanDifficulty('mittel', this)">
                            <div class="icon">🤔</div>
                            <div class="label">Mittel</div>
                        </div>
                        <div class="option-card" data-sorobandiff="schwer" onclick="selectSorobanDifficulty('schwer', this)">
                            <div class="icon">🔥</div>
                            <div class="label">Schwer</div>
                        </div>
                    </div>
                </div>

                <!-- Stellenwert -->
                <div class="settings-section" style="margin-bottom: 0;">
                    <h3>🔢 Stellenwert</h3>
                    <div class="options-grid">
                        <div class="option-card selected" data-sorobandigits="1" onclick="selectSorobanDigits(1, this)">
                            <div class="icon">1️⃣</div>
                            <div class="label">1 Stelle</div>
                            <div class="time">(1-9)</div>
                        </div>
                        <div class="option-card" data-sorobandigits="2" onclick="selectSorobanDigits(2, this)">
                            <div class="icon">2️⃣</div>
                            <div class="label">2 Stellen</div>
                            <div class="time">(10-99)</div>
                        </div>
                        <div class="option-card" data-sorobandigits="3" onclick="selectSorobanDigits(3, this)">
                            <div class="icon">3️⃣</div>
                            <div class="label">3 Stellen</div>
                            <div class="time">(100-999)</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Anzahl der Fragen -->
            <div class="settings-section" style="width: 100%;">
                <h3>❓ Anzahl der Fragen</h3>
                <div class="options-grid">
                    <div class="option-card" data-sorobancount="5" onclick="selectSorobanCount(5, this)">
                        <div class="label">5</div>
                    </div>
                    <div class="option-card selected" data-sorobancount="8" onclick="selectSorobanCount(8, this)">
                        <div class="label">8</div>
                    </div>
                    <div class="option-card" data-sorobancount="10" onclick="selectSorobanCount(10, this)">
                        <div class="label">10</div>
                    </div>
                </div>
            </div>

            <button class="game-start-button" onclick="startSorobanMatheGame()">🎮 SPIEL STARTEN</button>
        </div>

        <!-- SOROBAN MATHE GAME SCREEN -->
        <div class="screen" id="sorobanMatheGameScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            
            <div class="flashcard-progress-boxes" id="sorobanMatheProgressBoxes">
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
            </div>

            <!-- Abacus Display -->
            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 30px; align-items: center; justify-content: center; max-width: 1200px; margin: 40px auto; padding: 20px;">
                <!-- Left Abacus -->
                <div id="sorobanMatheLeft" style="display: flex; justify-content: center;"></div>
                
                <!-- Operation Sign -->
                <div id="sorobanMatheOperation" style="font-size: 10em; color: #FFD700; text-shadow: 4px 4px 8px rgba(0,0,0,0.4); font-weight: 900; font-family: Arial, sans-serif;">+</div>
                
                <!-- Right Abacus -->
                <div id="sorobanMatheRight" style="display: flex; justify-content: center;"></div>
            </div>

            <!-- Answer Options -->
            <div id="sorobanMatheOptions" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; max-width: 700px; margin: 0 auto; padding: 20px;"></div>
        </div>

        <!-- ABAKUS BAUEN GAME SCREEN -->
        <div class="screen" id="abakusBauenGameScreen">
        <div class="screen" id="abakusBauenGameScreen">
            <button class="home-icon-button" onclick="goHome()">🏠</button>
            
            <div class="flashcard-progress-boxes" id="abakusBauenProgressBoxes">
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
                <div class="progress-box"></div>
            </div>

            <div class="target-number-display">
                <h2>Baue diese Zahl:</h2>
                <div class="number" id="abakusTargetNumber">0</div>
            </div>

            <div style="background: linear-gradient(180deg, #ffffff 0%, #f8f8f8 100%); border-radius: 25px; padding: 40px; margin: 30px auto; max-width: 600px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);">
                <div id="interactiveAbakusContainer" style="text-align: center; min-height: 300px;">
                    <!-- Interactive abacus will be built here -->
                </div>
            </div>

            <div class="abakus-controls">
                <button class="reset-abakus-button" onclick="resetInteractiveAbakus()">🔄 Reset</button>
                <button class="check-abakus-button" onclick="checkAbakusBauen()">✓ Prüfen</button>
            </div>
        </div>

        <!-- MEINE AUFGABEN SCREEN -->
        <div class="screen" id="meineAufgabenScreen">
            <h2>📚 Meine Aufgaben</h2>
            
            <button class="add-task-button" onclick="showAddTaskModal()">➕ Neue Aufgabe erstellen</button>
            
            <div class="tasks-list" id="tasksList">
                <div class="empty-tasks-message">Noch keine Aufgaben. Erstelle deine erste Aufgabe!</div>
            </div>
            
            <div class="tasks-actions">
                <button class="play-selected-button" onclick="playSelectedTasks()">🎮 Ausgewählte spielen</button>
                <button class="delete-all-button" onclick="deleteAllTasks()">🗑️ Alle löschen</button>
                <button class="back-button" onclick="goHome()">⬅️ Zurück</button>
            </div>
        </div>

        <!-- ADD/SAVE TASK MODAL -->
        <div class="modal" id="addTaskModal">
            <div class="modal-content">
                <h3>Neue Aufgabe erstellen</h3>
                <p class="modal-instruction">Gib die Aufgabe ein (z.B. 6+4-2 oder 10*3+5):</p>
                <input type="text" id="taskInput" class="task-input" placeholder="6 + 4 - 2">
                <div class="modal-buttons">
                    <button class="modal-save-button" onclick="saveTask()">💾 Speichern</button>
                    <button class="modal-cancel-button" onclick="closeAddTaskModal()">❌ Abbrechen</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Game settings
        let settings = {
            rechenart: 'addition',
            geschwindigkeit: 3000,
            zahlenbereich: [1, 10],
            anzahl: 3,
            multiplicationLevel: 1, // 1-11: difficulty levels
            digitRange: '1-5', // '1-5', '1-7', '1-9'
            divisionLevel: 1, // 1-10: difficulty levels
            digitRangeDiv: '1-5' // '1-5', '1-7', '1-9' for division
        };

        // Sound settings
        let soundEnabled = true;
        let audioContext = null;

        // Initialize audio context
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        // Play beep sound
        function playBeep() {
            if (!soundEnabled) return;
            
            initAudioContext();
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Beep settings
            oscillator.frequency.value = 800; // Hz
            oscillator.type = 'sine';
            
            // Volume envelope
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }

        // Play success sound (celebration)
        function playSuccessSound() {
            if (!soundEnabled) return;
            
            initAudioContext();
            
            // Play a cheerful melody: C-E-G (major chord arpeggio)
            const notes = [523.25, 659.25, 783.99]; // C5, E5, G5
            const startTime = audioContext.currentTime;
            
            notes.forEach((freq, index) => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = freq;
                oscillator.type = 'sine';
                
                const noteStart = startTime + (index * 0.15);
                const noteEnd = noteStart + 0.2;
                
                gainNode.gain.setValueAtTime(0, noteStart);
                gainNode.gain.linearRampToValueAtTime(0.3, noteStart + 0.02);
                gainNode.gain.exponentialRampToValueAtTime(0.01, noteEnd);
                
                oscillator.start(noteStart);
                oscillator.stop(noteEnd);
            });
            
            // Add applause sound after melody
            playApplauseSound(startTime + 0.5);
        }

        function playApplauseSound(startTime) {
            if (!soundEnabled) return;
            
            initAudioContext();
            
            // Create applause effect using white noise with rhythm
            const duration = 1.5; // 1.5 seconds of applause
            const bufferSize = audioContext.sampleRate * duration;
            const buffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
            const data = buffer.getChannelData(0);
            
            // Generate rhythmic noise for applause effect
            for (let i = 0; i < bufferSize; i++) {
                const time = i / audioContext.sampleRate;
                // Create clapping rhythm with noise bursts
                const rhythm = Math.sin(time * 8) * Math.sin(time * 13);
                const envelope = Math.exp(-time * 0.8); // Fade out
                data[i] = (Math.random() * 2 - 1) * rhythm * envelope * 0.15;
            }
            
            const source = audioContext.createBufferSource();
            const gainNode = audioContext.createGain();
            const filter = audioContext.createBiquadFilter();
            
            source.buffer = buffer;
            source.connect(filter);
            filter.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Filter to make it sound more like applause
            filter.type = 'bandpass';
            filter.frequency.value = 1000;
            filter.Q.value = 0.5;
            
            // Volume envelope
            gainNode.gain.setValueAtTime(0, startTime);
            gainNode.gain.linearRampToValueAtTime(0.4, startTime + 0.1);
            gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
            
            source.start(startTime);
            source.stop(startTime + duration);
        }

        // Create confetti explosion
        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2', '#FFD700', '#FF1493', '#00CED1', '#FF69B4'];
            const shapes = ['circle', 'square', 'triangle'];
            const confettiCount = 80; // More confetti!
            
            for (let i = 0; i < confettiCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                
                // Random position
                confetti.style.left = Math.random() * 100 + '%';
                
                // Random color
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                
                // Bigger size range (10-25px instead of 5-15px)
                const size = Math.random() * 15 + 10;
                confetti.style.width = size + 'px';
                confetti.style.height = size + 'px';
                
                // Random shape
                const shape = shapes[Math.floor(Math.random() * shapes.length)];
                if (shape === 'circle') {
                    confetti.style.borderRadius = '50%';
                } else if (shape === 'triangle') {
                    confetti.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
                }
                
                // More variation in timing
                confetti.style.animationDelay = Math.random() * 0.8 + 's';
                confetti.style.animationDuration = (Math.random() * 2.5 + 2) + 's';
                
                // Add glow effect to some confetti
                if (Math.random() > 0.5) {
                    confetti.style.boxShadow = `0 0 10px ${colors[Math.floor(Math.random() * colors.length)]}`;
                }
                
                container.appendChild(confetti);
                
                // Remove confetti after animation
                setTimeout(() => {
                    confetti.remove();
                }, 5000);
            }
        }

        // Toggle sound on/off
        function toggleSound() {
            soundEnabled = !soundEnabled;
            
            const button = document.getElementById('soundIconButton');
            const icon = document.getElementById('soundIconHome');
            
            if (soundEnabled) {
                button.classList.remove('muted');
                icon.textContent = '🔊';
            } else {
                button.classList.add('muted');
                icon.textContent = '🔇';
            }
            
            // Save to localStorage
            localStorage.setItem('anzanSoundEnabled', soundEnabled);
        }

        // Load sound preference
        function loadSoundPreference() {
            const saved = localStorage.getItem('anzanSoundEnabled');
            if (saved !== null) {
                soundEnabled = saved === 'true';
                
                const button = document.getElementById('soundIconButton');
                const icon = document.getElementById('soundIconHome');
                
                if (button && icon) {
                    if (!soundEnabled) {
                        button.classList.add('muted');
                        icon.textContent = '🔇';
                    }
                }
            }
        }

        // Game state
        let currentNumbers = [];
        let correctAnswer = 0;
        let userAnswerString = '';
        let isCustomTask = false;

        // Task management
        let savedTasks = [];
        let selectedTasksQueue = [];
        let currentTaskIndex = 0;

        // Load tasks from localStorage on page load
        function loadTasksFromStorage() {
            const stored = localStorage.getItem('anzanTasks');
            if (stored) {
                savedTasks = JSON.parse(stored);
            }
        }

        // Save tasks to localStorage
        function saveTasksToStorage() {
            localStorage.setItem('anzanTasks', JSON.stringify(savedTasks));
        }

        // Show Meine Aufgaben screen
        function showMeineAufgaben() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('meineAufgabenScreen').classList.add('active');
            renderTasksList();
        }

        // Render tasks list
        function renderTasksList() {
            const container = document.getElementById('tasksList');
            
            if (savedTasks.length === 0) {
                container.innerHTML = '<div class="empty-tasks-message">Noch keine Aufgaben. Erstelle deine erste Aufgabe!</div>';
                return;
            }

            container.innerHTML = '';
            savedTasks.forEach((task, index) => {
                const taskItem = document.createElement('div');
                taskItem.className = 'task-item';
                taskItem.innerHTML = `
                    <input type="checkbox" class="task-checkbox" data-index="${index}">
                    <div class="task-text">${task.displayText}</div>
                    <button class="task-play-button" onclick="playSingleTask(${index})">▶️</button>
                    <button class="task-delete-button" onclick="deleteTask(${index})">🗑️</button>
                `;
                container.appendChild(taskItem);
            });
        }

        // Show add task modal
        function showAddTaskModal() {
            document.getElementById('addTaskModal').classList.add('active');
            document.getElementById('taskInput').value = '';
            document.getElementById('taskInput').focus();
        }

        // Close add task modal
        function closeAddTaskModal() {
            document.getElementById('addTaskModal').classList.remove('active');
        }

        // Save task
        function saveTask() {
            const input = document.getElementById('taskInput').value.trim();
            
            if (!input) {
                alert('Bitte gib mindestens eine Zahl ein!');
                return;
            }

            // Parse input to extract numbers and operators
            const elements = [];
            let currentNumber = '';
            
            for (let i = 0; i < input.length; i++) {
                const char = input[i];
                
                if (char === '+' || char === '-' || char === '*' || char === '/' || char === '×' || char === '÷') {
                    if (currentNumber) {
                        elements.push(parseInt(currentNumber.trim()));
                        currentNumber = '';
                    }
                    // Normalize operators
                    let operator = char;
                    if (char === '×') operator = '*';
                    if (char === '÷') operator = '/';
                    elements.push(operator);
                } else if (char >= '0' && char <= '9') {
                    currentNumber += char;
                } else if (char !== ' ' && char !== ',') {
                    // Skip spaces and commas
                    continue;
                }
            }
            
            // Add last number
            if (currentNumber) {
                elements.push(parseInt(currentNumber.trim()));
            }

            // Validate: should start and end with number, alternating pattern
            if (elements.length === 0 || typeof elements[0] !== 'number' || typeof elements[elements.length - 1] !== 'number') {
                alert('Bitte gib eine gültige Aufgabe ein! (z.B. 6+4-2)');
                return;
            }

            // Calculate answer
            let answer;
            try {
                // Build expression string for calculation
                let expression = elements.join('');
                answer = eval(expression);
                answer = Math.round(answer * 100) / 100; // Round to 2 decimals
            } catch (e) {
                alert('Fehler beim Berechnen der Aufgabe!');
                return;
            }

            // Create display text
            let displayText = '';
            for (let i = 0; i < elements.length; i++) {
                if (typeof elements[i] === 'number') {
                    displayText += elements[i];
                } else {
                    displayText += ' ' + elements[i] + ' ';
                }
            }
            displayText += ' = ?';

            // Create task object
            const task = {
                elements: elements, // Array of numbers and operators
                displayText: displayText,
                answer: answer
            };

            // Add to savedTasks
            savedTasks.push(task);
            saveTasksToStorage();
            
            // Close modal and update list
            closeAddTaskModal();
            renderTasksList();
        }

        // Play single task
        function playSingleTask(index) {
            const task = savedTasks[index];
            
            // Check if task has new format (elements) or old format (numbers)
            if (task.elements) {
                currentNumbers = task.elements;
            } else {
                // Old format compatibility
                currentNumbers = task.numbers || [];
            }
            
            correctAnswer = task.answer;
            isCustomTask = true;
            userAnswerString = '';

            // Start countdown
            startCountdown();
        }

        // Delete task
        function deleteTask(index) {
            if (confirm('Diese Aufgabe löschen?')) {
                savedTasks.splice(index, 1);
                saveTasksToStorage();
                renderTasksList();
            }
        }

        // Delete all tasks
        function deleteAllTasks() {
            if (savedTasks.length === 0) {
                alert('Keine Aufgaben zum Löschen!');
                return;
            }
            
            if (confirm(`Alle ${savedTasks.length} Aufgaben löschen?`)) {
                savedTasks = [];
                saveTasksToStorage();
                renderTasksList();
            }
        }

        // Play selected tasks
        function playSelectedTasks() {
            const checkboxes = document.querySelectorAll('.task-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('Bitte wähle mindestens eine Aufgabe aus!');
                return;
            }

            // Collect selected tasks
            selectedTasksQueue = [];
            checkboxes.forEach(cb => {
                const index = parseInt(cb.dataset.index);
                selectedTasksQueue.push(savedTasks[index]);
            });

            // Start playing queue
            currentTaskIndex = 0;
            playNextTaskFromQueue();
        }

        // Play next task from queue
        function playNextTaskFromQueue() {
            if (currentTaskIndex >= selectedTasksQueue.length) {
                // All tasks completed
                alert('🎉 Alle ausgewählten Aufgaben abgeschlossen!');
                showMeineAufgaben();
                return;
            }

            const task = selectedTasksQueue[currentTaskIndex];
            
            // Check if task has new format (elements) or old format (numbers)
            if (task.elements) {
                currentNumbers = task.elements;
            } else {
                // Old format compatibility
                currentNumbers = task.numbers || [];
            }
            
            correctAnswer = task.answer;
            isCustomTask = true;
            userAnswerString = '';

            // Start countdown
            startCountdown();
        }

        function openCustomTaskModal() {
            document.getElementById('customTaskModal').classList.add('active');
            document.getElementById('customTaskInput').value = '';
            document.getElementById('customTaskInput').focus();
        }

        function closeCustomTaskModal() {
            document.getElementById('customTaskModal').classList.remove('active');
        }

        function startCustomTask() {
            const input = document.getElementById('customTaskInput').value.trim();
            
            if (!input) {
                alert('Bitte gib mindestens eine Zahl ein!');
                return;
            }

            // Parse input - accept +, comma, or space as separators
            const numbersString = input.replace(/\+/g, ',').replace(/\s+/g, ',');
            const numbers = numbersString.split(',')
                .map(n => n.trim())
                .filter(n => n !== '')
                .map(n => parseInt(n))
                .filter(n => !isNaN(n));

            if (numbers.length === 0) {
                alert('Bitte gib gültige Zahlen ein!');
                return;
            }

            // Set custom task
            isCustomTask = true;
            currentNumbers = numbers;

            // Calculate answer based on selected operation
            if (settings.rechenart === 'addition') {
                correctAnswer = currentNumbers.reduce((sum, num) => sum + num, 0);
            }

            // Close modal
            closeCustomTaskModal();

            // Reset user answer
            userAnswerString = '';

            // Show game screen
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('gameScreen').classList.add('active');
            document.getElementById('answerSection').style.display = 'none';
            updateAnswerDisplay();

            // Display numbers sequentially
            displayNumbers();
        }

        function addDigit(digit) {
            userAnswerString += digit.toString();
            updateAnswerDisplay();
        }

        function deleteDigit() {
            userAnswerString = userAnswerString.slice(0, -1);
            updateAnswerDisplay();
        }

        function updateAnswerDisplay() {
            const display = document.getElementById('answerDisplay');
            if (userAnswerString === '') {
                display.innerHTML = '<span class="placeholder"></span>';
            } else {
                display.innerHTML = userAnswerString;
            }
        }

        function selectOption(category, value, element) {
            // Remove selected class from siblings
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            
            // Add selected class to clicked element
            element.classList.add('selected');
            
            // Update settings
            settings[category] = value;

            // If custom range is deselected, hide inputs
            if (category === 'zahlenbereich' && element.dataset.range !== 'custom') {
                document.getElementById('customRangeInputs').style.display = 'none';
            }
            
            // Show/hide sections based on rechenart
            if (category === 'rechenart') {
                const geschwindigkeitSection = document.getElementById('geschwindigkeitSection');
                const standardZahlenbereich = document.getElementById('standardZahlenbereich');
                const multiplikationOptions = document.getElementById('multiplikationOptions');
                const divisionOptions = document.getElementById('divisionOptions');
                const anzahlSection = document.getElementById('anzahlSection');
                
                if (value === 'multiplikation') {
                    // Hide geschwindigkeit and anzahl for multiplication
                    geschwindigkeitSection.style.display = 'none';
                    anzahlSection.style.display = 'none';
                    // Show multiplication options
                    standardZahlenbereich.style.display = 'none';
                    multiplikationOptions.style.display = 'block';
                    divisionOptions.style.display = 'none';
                } else if (value === 'division') {
                    // Hide geschwindigkeit and anzahl for division
                    geschwindigkeitSection.style.display = 'none';
                    anzahlSection.style.display = 'none';
                    // Show division options
                    standardZahlenbereich.style.display = 'none';
                    multiplikationOptions.style.display = 'none';
                    divisionOptions.style.display = 'block';
                } else {
                    // Show geschwindigkeit and anzahl for addition/subtraction
                    geschwindigkeitSection.style.display = 'block';
                    anzahlSection.style.display = 'block';
                    // Show standard options
                    standardZahlenbereich.style.display = 'block';
                    multiplikationOptions.style.display = 'none';
                    divisionOptions.style.display = 'none';
                }
            }
        }

        // Select multiplication level
        function selectMultiplicationLevel(level, element) {
            settings.multiplicationLevel = level;
            
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
        }

        // Select digit range for multiplication
        function selectDigitRange(range, element) {
            settings.digitRange = range;
            
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
        }

        // Select division level
        function selectDivisionLevel(level, element) {
            settings.divisionLevel = level;
            
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
        }

        // Select digit range for division
        function selectDigitRangeDiv(range, element) {
            settings.digitRangeDiv = range;
            
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
        }

        // Generate random number with specific digits
        function generateNumberWithDigits(numDigits, digitRange) {
            const [minDigit, maxDigit] = digitRange.split('-').map(Number);
            let number = '';
            
            for (let i = 0; i < numDigits; i++) {
                const digit = Math.floor(Math.random() * (maxDigit - minDigit + 1)) + minDigit;
                // First digit cannot be 0
                if (i === 0 && digit === 0) {
                    number += '1';
                } else {
                    number += digit;
                }
            }
            
            return parseInt(number);
        }

        function toggleCustomRange(element) {
            const customInputs = document.getElementById('customRangeInputs');
            const siblings = element.closest('.settings-section').querySelectorAll('.option-card');
            
            // Remove selected from all siblings
            siblings.forEach(sib => sib.classList.remove('selected'));
            
            // Select this option
            element.classList.add('selected');
            
            // Show/hide custom inputs
            if (customInputs.style.display === 'none') {
                customInputs.style.display = 'flex';
                updateCustomRange();
            } else {
                customInputs.style.display = 'none';
            }
        }

        function updateCustomRange() {
            const min = parseInt(document.getElementById('customMin').value) || 1;
            const max = parseInt(document.getElementById('customMax').value) || 100;
            
            // Validate
            if (min >= max) {
                document.getElementById('customMax').value = min + 1;
            }
            
            settings.zahlenbereich = [min, max];
        }

        // Add event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            const customMin = document.getElementById('customMin');
            const customMax = document.getElementById('customMax');
            
            if (customMin && customMax) {
                customMin.addEventListener('input', updateCustomRange);
                customMax.addEventListener('input', updateCustomRange);
            }

            // Allow Enter key in custom task modal
            const customTaskInput = document.getElementById('customTaskInput');
            if (customTaskInput) {
                customTaskInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        startCustomTask();
                    }
                });
            }

            // Close modal on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeCustomTaskModal();
                }
            });
        });

        function showSettings() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('settingsScreen').classList.add('active');
            
            // Update speed cards based on game mode
            const geschwindigkeitGrid = document.querySelector('#geschwindigkeitSection .options-grid');
            
            if (currentGameMode === 'tandem') {
                // Tandem mode: Different speeds, Meister becomes "Sehr Langsam" 5s at start
                geschwindigkeitGrid.innerHTML = `
                    <div class="option-card" data-speed="sehr-langsam" onclick="selectOption('geschwindigkeit', 5000, this)">
                        <div class="icon">🐢</div>
                        <div class="label">Sehr Langsam</div>
                        <div class="time">5s</div>
                    </div>
                    <div class="option-card" data-speed="langsam" onclick="selectOption('geschwindigkeit', 4000, this)">
                        <div class="icon">🐌</div>
                        <div class="label">Langsam</div>
                        <div class="time">4s</div>
                    </div>
                    <div class="option-card selected" data-speed="normal" onclick="selectOption('geschwindigkeit', 3000, this)">
                        <div class="icon">🏃</div>
                        <div class="label">Normal</div>
                        <div class="time">3s</div>
                    </div>
                    <div class="option-card" data-speed="schnell" onclick="selectOption('geschwindigkeit', 2000, this)">
                        <div class="icon">🏃‍♂️</div>
                        <div class="label">Schnell</div>
                        <div class="time">2s</div>
                    </div>
                    <div class="option-card" data-speed="sehr-schnell" onclick="selectOption('geschwindigkeit', 1000, this)">
                        <div class="icon">⚡</div>
                        <div class="label">Sehr Schnell</div>
                        <div class="time">1s</div>
                    </div>
                    <div class="option-card" data-speed="ultra-schnell" onclick="selectOption('geschwindigkeit', 800, this)">
                        <div class="icon">🚀</div>
                        <div class="label">Ultra Schnell</div>
                        <div class="time">0.8s</div>
                    </div>
                    <div class="option-card" data-speed="blitz" onclick="selectOption('geschwindigkeit', 600, this)">
                        <div class="icon">⚡🔥</div>
                        <div class="label">Blitz</div>
                        <div class="time">0.6s</div>
                    </div>
                    <div class="option-card" data-speed="extrem" onclick="selectOption('geschwindigkeit', 500, this)">
                        <div class="icon">💥</div>
                        <div class="label">Extrem</div>
                        <div class="time">0.5s</div>
                    </div>
                `;
            } else {
                // Anzan mode: Original speeds with Meister 0.4s
                geschwindigkeitGrid.innerHTML = `
                    <div class="option-card" data-speed="langsam" onclick="selectOption('geschwindigkeit', 4000, this)">
                        <div class="icon">🐌</div>
                        <div class="label">Langsam</div>
                        <div class="time">4s</div>
                    </div>
                    <div class="option-card selected" data-speed="normal" onclick="selectOption('geschwindigkeit', 3000, this)">
                        <div class="icon">🏃</div>
                        <div class="label">Normal</div>
                        <div class="time">3s</div>
                    </div>
                    <div class="option-card" data-speed="schnell" onclick="selectOption('geschwindigkeit', 2000, this)">
                        <div class="icon">🏃‍♂️</div>
                        <div class="label">Schnell</div>
                        <div class="time">2s</div>
                    </div>
                    <div class="option-card" data-speed="sehr-schnell" onclick="selectOption('geschwindigkeit', 1000, this)">
                        <div class="icon">⚡</div>
                        <div class="label">Sehr Schnell</div>
                        <div class="time">1s</div>
                    </div>
                    <div class="option-card" data-speed="ultra-schnell" onclick="selectOption('geschwindigkeit', 800, this)">
                        <div class="icon">🚀</div>
                        <div class="label">Ultra Schnell</div>
                        <div class="time">0.8s</div>
                    </div>
                    <div class="option-card" data-speed="blitz" onclick="selectOption('geschwindigkeit', 600, this)">
                        <div class="icon">⚡🔥</div>
                        <div class="label">Blitz</div>
                        <div class="time">0.6s</div>
                    </div>
                    <div class="option-card" data-speed="extrem" onclick="selectOption('geschwindigkeit', 500, this)">
                        <div class="icon">💥</div>
                        <div class="label">Extrem</div>
                        <div class="time">0.5s</div>
                    </div>
                    <div class="option-card" data-speed="meister" onclick="selectOption('geschwindigkeit', 400, this)">
                        <div class="icon">🏆</div>
                        <div class="label">Meister</div>
                        <div class="time">0.4s</div>
                    </div>
                `;
            }
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function goHome() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('homeScreen').classList.add('active');
        }

        // Game selection
        function selectGame(gameType) {
            if (gameType === 'anzan') {
                currentGameMode = 'anzan';
                showSettings();
            } else if (gameType === 'tandem') {
                currentGameMode = 'tandem';
                showSettings();
            } else if (gameType === 'flashcard') {
                currentGameMode = 'flashcard';
                showFlashcardSettings();
            } else if (gameType === 'visualTraining') {
                currentGameMode = 'visualTraining';
                showVisualTrainingSettings();
            } else if (gameType === 'speedZahlen') {
                currentGameMode = 'speedZahlen';
                showSpeedZahlenSettings();
            } else if (gameType === 'multiDivCards') {
                currentGameMode = 'multiDivCards';
                showMultiDivSettings();
            } else if (gameType === 'zahlenMerken') {
                currentGameMode = 'zahlenMerken';
                showZahlenMerkenSettings();
            } else if (gameType === 'zahlenVergleichen') {
                currentGameMode = 'zahlenVergleichen';
                showZahlenVergleichenSettings();
            } else if (gameType === 'logikRatsel') {
                currentGameMode = 'logikRatsel';
                showLogikRatselSettings();
            } else if (gameType === 'zahlenZirkus') {
                currentGameMode = 'zahlenZirkus';
                // Show Zirkus settings screen
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('zirkusSettingsScreen').classList.add('active');
            } else if (gameType === 'sesliAnzan') {
                currentGameMode = 'sesliAnzan';
                showSesliAnzanSettings();
            } else if (gameType === 'farbSpiel') {
                currentGameMode = 'farbSpiel';
                showFarbSpielSettings();
            } else if (gameType === 'sorobanMathe') {
                currentGameMode = 'sorobanMathe';
                showSorobanMatheSettings();
            }
        }

        // Speed Zählen settings and state
        let speedZahlenSettings = {
            mode: 'zahlenZahlen', // 'zahlenZahlen' or future modes
            numberCount: 30,
            displayTime: 3,
            questionCount: 8
        };

        let speedZahlenState = {
            currentQuestion: 0,
            score: 0,
            targetNumber: 0,
            correctCount: 0,
            allNumbers: []
        };

        function showSpeedZahlenSettings() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('speedZahlenSettingsScreen').classList.add('active');
        }

        function selectSpeedMode(mode, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            speedZahlenSettings.mode = mode;
        }

        function selectSpeedZahlCount(count, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            speedZahlenSettings.numberCount = count;
        }

        function selectSpeedZahlTime(seconds, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            speedZahlenSettings.displayTime = seconds;
        }

        function selectSpeedZahlQuestions(count, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            speedZahlenSettings.questionCount = count;
        }

        function startSpeedZahlenGame() {
            speedZahlenState = {
                currentQuestion: 0,
                score: 0,
                targetNumber: 0,
                correctCount: 0,
                allNumbers: []
            };

            // Reset progress boxes
            const boxes = document.querySelectorAll('#speedZahlenProgressBoxes .progress-box');
            boxes.forEach(box => {
                box.classList.remove('correct', 'wrong');
            });

            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('speedZahlenGameScreen').classList.add('active');

            showSpeedZahlenQuestion();
        }

        function showSpeedZahlenQuestion() {
            if (speedZahlenState.currentQuestion >= speedZahlenSettings.questionCount) {
                endSpeedZahlenGame();
                return;
            }

            // Generate random numbers
            const numbers = [];
            for (let i = 0; i < speedZahlenSettings.numberCount; i++) {
                numbers.push(Math.floor(Math.random() * 10)); // 0-9
            }
            speedZahlenState.allNumbers = numbers;

            // Pick a random target number that exists in the array
            const uniqueNumbers = [...new Set(numbers)];
            speedZahlenState.targetNumber = uniqueNumbers[Math.floor(Math.random() * uniqueNumbers.length)];
            
            // Count how many times target appears
            speedZahlenState.correctCount = numbers.filter(n => n === speedZahlenState.targetNumber).length;

            // Different flow based on mode
            if (speedZahlenSettings.mode === 'schnellFinden') {
                // Schnell Finden: Show question FIRST
                showSchnellFindenPreQuestion();
            } else {
                // Zahlen zählen: Show numbers FIRST
                displaySpeedZahlenNumbers(numbers);
            }
        }

        function showSchnellFindenPreQuestion() {
            const container = document.getElementById('speedZahlenNumberDisplay');
            const questionSection = document.getElementById('speedZahlenQuestionSection');
            
            container.style.display = 'flex';
            questionSection.style.display = 'none';
            
            // Show "Get ready" message with target number
            container.innerHTML = `
                <div style="text-align: center;">
                    <h2 style="color: white; font-size: 2.5em; margin-bottom: 20px;">Bereit machen!</h2>
                    <h1 style="color: #FFD700; font-size: 5em; margin: 30px 0;">Zähle: ${speedZahlenState.targetNumber}</h1>
                    <p style="color: rgba(255,255,255,0.8); font-size: 1.5em;">Die Zahlen erscheinen gleich...</p>
                </div>
            `;
            
            // After 2 seconds, show the numbers
            setTimeout(() => {
                displaySpeedZahlenNumbers(speedZahlenState.allNumbers);
            }, 2000);
        }

        function displaySpeedZahlenNumbers(numbers) {
            const container = document.getElementById('speedZahlenNumberDisplay');
            const questionSection = document.getElementById('speedZahlenQuestionSection');
            
            container.innerHTML = '';
            questionSection.style.display = 'none';
            container.style.display = 'flex';

            // Create grid positions to avoid overlap
            const gridSize = Math.ceil(Math.sqrt(numbers.length));
            const positions = [];
            
            // Generate grid positions
            for (let row = 0; row < gridSize; row++) {
                for (let col = 0; col < gridSize; col++) {
                    positions.push({
                        x: (col / gridSize) * 80 + 10, // 10-90% range
                        y: (row / gridSize) * 80 + 10
                    });
                }
            }
            
            // Shuffle positions for randomness
            for (let i = positions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [positions[i], positions[j]] = [positions[j], positions[i]];
            }

            // Scatter numbers using shuffled grid positions
            numbers.forEach((num, index) => {
                const numberEl = document.createElement('div');
                numberEl.textContent = num;
                numberEl.style.position = 'absolute';
                numberEl.style.fontSize = '3em';
                numberEl.style.fontWeight = 'bold';
                numberEl.style.color = 'white';
                numberEl.style.textShadow = '2px 2px 4px rgba(0,0,0,0.5)';
                
                // Use grid position with small random offset for natural look
                const pos = positions[index];
                const offsetX = (Math.random() - 0.5) * 5; // ±2.5% offset
                const offsetY = (Math.random() - 0.5) * 5;
                
                numberEl.style.left = (pos.x + offsetX) + '%';
                numberEl.style.top = (pos.y + offsetY) + '%';
                
                container.appendChild(numberEl);
            });

            // Hide after display time
            setTimeout(() => {
                container.style.display = 'none';
                showSpeedZahlenQuestionOptions();
            }, speedZahlenSettings.displayTime * 1000);
        }

        function showSpeedZahlenQuestionOptions() {
            const questionSection = document.getElementById('speedZahlenQuestionSection');
            const targetNumberSpan = document.getElementById('speedZahlenTargetNumber');
            const optionsContainer = document.getElementById('speedZahlenOptions');
            
            questionSection.style.display = 'block';
            
            // Different question text based on mode
            if (speedZahlenSettings.mode === 'schnellFinden') {
                targetNumberSpan.parentElement.innerHTML = `Wie viele <span id="speedZahlenTargetNumber" style="color: #FFD700; font-size: 1.5em;">${speedZahlenState.targetNumber}</span> hast du gezählt?`;
            } else {
                targetNumberSpan.textContent = speedZahlenState.targetNumber;
            }
            
            // Generate 4 options (1 correct, 3 wrong)
            const options = [speedZahlenState.correctCount];
            
            while (options.length < 4) {
                let wrongAnswer = speedZahlenState.correctCount + (Math.floor(Math.random() * 6) - 3);
                if (wrongAnswer < 0) wrongAnswer = 0;
                if (wrongAnswer > speedZahlenSettings.numberCount) wrongAnswer = speedZahlenSettings.numberCount;
                
                if (!options.includes(wrongAnswer)) {
                    options.push(wrongAnswer);
                }
            }
            
            // Shuffle options
            options.sort(() => Math.random() - 0.5);
            
            // Create buttons
            optionsContainer.innerHTML = '';
            optionsContainer.style.display = 'grid';
            optionsContainer.style.gridTemplateColumns = 'repeat(2, 1fr)';
            
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'flashcard-option';
                btn.textContent = option;
                btn.onclick = () => checkSpeedZahlenAnswer(option);
                optionsContainer.appendChild(btn);
            });
        }

        function checkSpeedZahlenAnswer(selectedAnswer) {
            const isCorrect = selectedAnswer === speedZahlenState.correctCount;
            
            const boxes = document.querySelectorAll('#speedZahlenProgressBoxes .progress-box');
            const currentBox = boxes[speedZahlenState.currentQuestion];
            if (currentBox) {
                currentBox.classList.add(isCorrect ? 'correct' : 'wrong');
            }
            
            const buttons = document.querySelectorAll('#speedZahlenOptions .flashcard-option');
            buttons.forEach(btn => {
                btn.disabled = true;
                const value = parseInt(btn.textContent);
                if (value === speedZahlenState.correctCount) {
                    btn.classList.add('correct');
                } else if (value === selectedAnswer && !isCorrect) {
                    btn.classList.add('wrong');
                }
            });

            if (isCorrect) {
                speedZahlenState.score++;
                playBeep();
            }

            setTimeout(() => {
                speedZahlenState.currentQuestion++;
                showSpeedZahlenQuestion();
            }, 1500);
        }

        function endSpeedZahlenGame() {
            showScreen('resultScreen');
            
            const percentage = Math.round((speedZahlenState.score / speedZahlenSettings.questionCount) * 100);
            const resultMessage = document.getElementById('resultMessage');
            
            if (percentage === 100) {
                const perfectMessages = [
                    '🎉 SUPER! 🎉',
                    '⭐ TOLL! ⭐',
                    '🏆 FANTASTISCH! 🏆',
                    '🌟 PERFEKT! 🌟',
                    '💪 STARK! 💪',
                    '🎊 SPITZE! 🎊'
                ];
                resultMessage.textContent = perfectMessages[Math.floor(Math.random() * perfectMessages.length)];
                resultMessage.className = 'result-message correct';
                playSuccessSound();
                createConfetti();
            } else if (percentage >= 75) {
                const goodMessages = [
                    '👏 SEHR GUT! 👏',
                    '🌟 TOLL GEMACHT! 🌟',
                    '💪 SUPER LEISTUNG! 💪'
                ];
                resultMessage.textContent = goodMessages[Math.floor(Math.random() * goodMessages.length)];
                resultMessage.className = 'result-message correct';
            } else if (percentage >= 50) {
                const okMessages = [
                    '👍 GUT GEMACHT! 👍',
                    '💫 WEITER SO! 💫',
                    '⭐ SCHÖN! ⭐'
                ];
                resultMessage.textContent = okMessages[Math.floor(Math.random() * okMessages.length)];
                resultMessage.className = 'result-message correct';
            } else {
                const encourageMessages = [
                    '💪 Weiter üben!',
                    '🌈 Nächstes Mal!',
                    '⭐ Fast geschafft!',
                    '💫 Du schaffst das!'
                ];
                resultMessage.textContent = encourageMessages[Math.floor(Math.random() * encourageMessages.length)];
                resultMessage.className = 'result-message wrong';
            }
            
            document.getElementById('questionText').textContent = 
                `Du hast ${speedZahlenState.score} von ${speedZahlenSettings.questionCount} Fragen richtig beantwortet!`;
            document.getElementById('correctAnswer').textContent = `Erfolgsquote: ${percentage}%`;
            document.getElementById('userAnswer').textContent = '';
        }

        // MultiDiv Cards Settings and State
        let multiDivSettings = {
            mode: 'multiplication', // 'multiplication' or 'division'
            difficulty: 'leicht', // 'leicht', 'mittel', 'schwer'
            digits: 1, // 1, 2, or 3
            questionCount: 8
        };

        let multiDivState = {
            currentQuestion: 0,
            score: 0,
            correctAnswer: 0,
            question: '',
            num1: 0,
            num2: 0
        };

        function showMultiDivSettings() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('multiDivSettingsScreen').classList.add('active');
            updateDifficultyExamples(); // Update examples based on mode
        }

        function selectMultiDivMode(mode, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            multiDivSettings.mode = mode;
            updateDifficultyExamples(); // Update examples when mode changes
        }

        function updateDifficultyExamples() {
            const leichtEx = document.getElementById('difficultyLeichtExample');
            const mittelEx = document.getElementById('difficultyMittelExample');
            const schwerEx = document.getElementById('difficultySchwerExample');
            
            if (multiDivSettings.mode === 'multiplication') {
                leichtEx.textContent = '2 × 3';
                mittelEx.textContent = '12 × 4';
                schwerEx.textContent = '23 × 15';
            } else {
                leichtEx.textContent = '6 : 3';
                mittelEx.textContent = '48 : 4';
                schwerEx.textContent = '345 : 15';
            }
        }

        function selectMultiDivDifficulty(difficulty, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            multiDivSettings.difficulty = difficulty;
        }

        function selectMultiDivDigits(digits, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            multiDivSettings.digits = digits;
        }

        function startMultiDivGame() {
            multiDivState = {
                currentQuestion: 0,
                score: 0,
                correctAnswer: 0,
                question: '',
                num1: 0,
                num2: 0
            };

            // Reset progress boxes
            const boxes = document.querySelectorAll('#multiDivProgressBoxes .progress-box');
            boxes.forEach(box => {
                box.classList.remove('correct', 'wrong');
            });

            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('multiDivGameScreen').classList.add('active');

            showMultiDivQuestion();
        }

        function showMultiDivQuestion() {
            if (multiDivState.currentQuestion >= multiDivSettings.questionCount) {
                endMultiDivGame();
                return;
            }

            let num1, num2, result;
            
            if (multiDivSettings.mode === 'multiplication') {
                // MULTIPLICATION MODE
                if (multiDivSettings.difficulty === 'leicht') {
                    num1 = Math.floor(Math.random() * 9) + 1; // 1-9
                    num2 = Math.floor(Math.random() * 9) + 1; // 1-9
                } else if (multiDivSettings.difficulty === 'mittel') {
                    num1 = Math.floor(Math.random() * 90) + 10; // 10-99
                    num2 = Math.floor(Math.random() * 9) + 1; // 1-9
                } else { // schwer
                    num1 = Math.floor(Math.random() * 90) + 10; // 10-99
                    num2 = Math.floor(Math.random() * 90) + 10; // 10-99
                }

                result = num1 * num2;
                
                // Ensure num2 (the answer) fits digit requirement
                const maxNum = Math.pow(10, multiDivSettings.digits) - 1;
                if (num2 > maxNum) {
                    showMultiDivQuestion();
                    return;
                }

                multiDivState.num1 = num1;
                multiDivState.num2 = num2;
                multiDivState.correctAnswer = num2; // num2 is the answer
                multiDivState.question = `${num1} × ? = ${result}`;
                
            } else {
                // DIVISION MODE
                // Generate divisor (answer) first, then result, then calculate dividend
                if (multiDivSettings.difficulty === 'leicht') {
                    num2 = Math.floor(Math.random() * 9) + 1; // divisor: 1-9
                    result = Math.floor(Math.random() * 9) + 1; // result: 1-9
                } else if (multiDivSettings.difficulty === 'mittel') {
                    num2 = Math.floor(Math.random() * 9) + 1; // divisor: 1-9
                    result = Math.floor(Math.random() * 90) + 10; // result: 10-99
                } else { // schwer
                    num2 = Math.floor(Math.random() * 90) + 10; // divisor: 10-99
                    result = Math.floor(Math.random() * 90) + 10; // result: 10-99
                }
                
                num1 = num2 * result; // dividend = divisor × result
                
                // Ensure num2 (the answer/divisor) fits digit requirement
                const maxNum = Math.pow(10, multiDivSettings.digits) - 1;
                if (num2 > maxNum) {
                    showMultiDivQuestion();
                    return;
                }

                multiDivState.num1 = num1;
                multiDivState.num2 = num2;
                multiDivState.correctAnswer = num2; // num2 is the answer (divisor)
                multiDivState.question = `${num1} : ? = ${result}`;
            }

            // Display question
            document.getElementById('multiDivQuestion').textContent = multiDivState.question;

            // Generate 3 abacus options showing num2 as correct answer
            generateMultiDivAbacusOptions(num2);
        }

        function generateMultiDivAbacusOptions(correctAnswer) {
            const options = [correctAnswer];
            const maxNum = Math.pow(10, multiDivSettings.digits) - 1;
            
            // Generate 2 wrong answers
            while (options.length < 3) {
                let wrongAnswer;
                const offset = Math.floor(Math.random() * 5) + 1;
                const direction = Math.random() < 0.5 ? -1 : 1;
                wrongAnswer = correctAnswer + (offset * direction);
                
                if (wrongAnswer < 0) wrongAnswer = Math.abs(wrongAnswer);
                if (wrongAnswer > maxNum) wrongAnswer = maxNum - offset;
                if (wrongAnswer < 1) wrongAnswer = 1;
                
                if (!options.includes(wrongAnswer) && wrongAnswer >= 1 && wrongAnswer <= maxNum) {
                    options.push(wrongAnswer);
                }
            }

            // Shuffle options
            options.sort(() => Math.random() - 0.5);

            // Create abacus buttons
            const container = document.getElementById('multiDivAbacusOptions');
            container.innerHTML = '';
            
            options.forEach(option => {
                const btn = document.createElement('div');
                btn.style.cssText = 'cursor: pointer; transition: all 0.3s ease; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 20px; border: 3px solid rgba(255,255,255,0.3);';
                btn.dataset.value = option;
                btn.innerHTML = drawMultiDivMiniSoroban(option);
                btn.onclick = () => checkMultiDivAnswer(option);
                
                // Hover effect
                btn.onmouseenter = () => {
                    btn.style.background = 'rgba(255,255,255,0.2)';
                    btn.style.transform = 'translateY(-5px)';
                    btn.style.borderColor = 'rgba(255,255,255,0.5)';
                };
                btn.onmouseleave = () => {
                    btn.style.background = 'rgba(255,255,255,0.1)';
                    btn.style.transform = 'translateY(0)';
                    btn.style.borderColor = 'rgba(255,255,255,0.3)';
                };
                
                container.appendChild(btn);
            });
        }

        function drawMultiDivMiniSoroban(number) {
            const digitCount = multiDivSettings.digits;
            const numStr = number.toString().padStart(digitCount, '0');
            const digits = numStr.split('').map(d => parseInt(d));

            let html = '<div style="display: flex; justify-content: center; gap: 12px; padding: 10px;">';

            digits.forEach((digit) => {
                html += `<div style="display: flex; flex-direction: column; align-items: center; width: 35px;">`;
                html += `<div style="width: 4px; height: 120px; background: #5DADE2; position: relative; border-radius: 2px;">`;
                
                // Heaven bead
                if (digit >= 5) {
                    html += `<div style="position: absolute; bottom: 58px; left: -12px; width: 28px; height: 14px; background: linear-gradient(145deg, #FFD700, #FFA500); border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`;
                }
                
                // Divider
                html += `<div style="position: absolute; top: 60px; left: -12px; right: -12px; height: 3px; background: #5DADE2; border-radius: 2px;"></div>`;
                
                // Earth beads
                const activeCount = digit % 5;
                for (let i = 0; i < activeCount; i++) {
                    html += `<div style="position: absolute; top: ${63 + i * 15}px; left: -12px; width: 28px; height: 14px; background: linear-gradient(145deg, #FFD700, #FFA500); border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`;
                }
                
                html += `</div></div>`;
            });

            html += '</div>';
            return html;
        }

        function checkMultiDivAnswer(selectedAnswer) {
            const isCorrect = selectedAnswer === multiDivState.correctAnswer;
            
            const boxes = document.querySelectorAll('#multiDivProgressBoxes .progress-box');
            const currentBox = boxes[multiDivState.currentQuestion];
            if (currentBox) {
                currentBox.classList.add(isCorrect ? 'correct' : 'wrong');
            }
            
            // Disable all buttons and show correct/wrong
            const buttons = document.querySelectorAll('#multiDivAbacusOptions > div');
            buttons.forEach(btn => {
                const value = parseInt(btn.dataset.value);
                btn.style.pointerEvents = 'none';
                
                if (value === multiDivState.correctAnswer) {
                    btn.style.background = 'rgba(76, 175, 80, 0.3)';
                    btn.style.borderColor = '#4CAF50';
                    btn.style.transform = 'scale(1.05)';
                } else if (value === selectedAnswer && !isCorrect) {
                    btn.style.background = 'rgba(244, 67, 54, 0.3)';
                    btn.style.borderColor = '#f44336';
                }
            });

            if (isCorrect) {
                multiDivState.score++;
                playBeep();
            }

            setTimeout(() => {
                multiDivState.currentQuestion++;
                showMultiDivQuestion();
            }, 1500);
        }

        function endMultiDivGame() {
            showScreen('resultScreen');
            
            const percentage = Math.round((multiDivState.score / multiDivSettings.questionCount) * 100);
            const resultMessage = document.getElementById('resultMessage');
            
            if (percentage === 100) {
                const perfectMessages = [
                    '🎉 SUPER! 🎉',
                    '⭐ TOLL! ⭐',
                    '🏆 FANTASTISCH! 🏆',
                    '🌟 PERFEKT! 🌟',
                    '💪 STARK! 💪',
                    '🎊 SPITZE! 🎊'
                ];
                resultMessage.textContent = perfectMessages[Math.floor(Math.random() * perfectMessages.length)];
                resultMessage.className = 'result-message correct';
                playSuccessSound();
                createConfetti();
            } else if (percentage >= 75) {
                const goodMessages = [
                    '👏 SEHR GUT! 👏',
                    '🌟 TOLL GEMACHT! 🌟',
                    '💪 SUPER LEISTUNG! 💪'
                ];
                resultMessage.textContent = goodMessages[Math.floor(Math.random() * goodMessages.length)];
                resultMessage.className = 'result-message correct';
            } else if (percentage >= 50) {
                const okMessages = [
                    '👍 GUT GEMACHT! 👍',
                    '💫 WEITER SO! 💫',
                    '⭐ SCHÖN! ⭐'
                ];
                resultMessage.textContent = okMessages[Math.floor(Math.random() * okMessages.length)];
                resultMessage.className = 'result-message correct';
            } else {
                const encourageMessages = [
                    '💪 Weiter üben!',
                    '🌈 Nächstes Mal!',
                    '⭐ Fast geschafft!',
                    '💫 Du schaffst das!'
                ];
                resultMessage.textContent = encourageMessages[Math.floor(Math.random() * encourageMessages.length)];
                resultMessage.className = 'result-message wrong';
            }
            
            document.getElementById('questionText').textContent = 
                `Du hast ${multiDivState.score} von ${multiDivSettings.questionCount} Fragen richtig beantwortet!`;
            document.getElementById('correctAnswer').textContent = `Erfolgsquote: ${percentage}%`;
            document.getElementById('userAnswer').textContent = '';
        }

        // Abakus Bauen
        let abakusBauenSettings = { digits: 1, questionCount: 8 };
        let abakusBauenState = { currentQuestion: 0, score: 0, targetNumber: 0, beadStates: [] };

        // Logik Rätsel Settings and State
        let logikRatselSettings = {
            patternType: 'addition', // 'addition', 'subtraktion', 'multiplikation', 'gemischt'
            difficulty: 'leicht', // 'leicht', 'mittel', 'schwer'
            numberCount: 3, // 3, 4, or 5
            questionCount: 8
        };

        let logikRatselState = {
            currentQuestion: 0,
            score: 0,
            pattern: [],
            correctAnswer: 0,
            patternRule: ''
        };

        function showLogikRatselSettings() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('logikRatselSettingsScreen').classList.add('active');
        }

        function selectPatternType(type, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            logikRatselSettings.patternType = type;
        }

        function selectPatternDifficulty(difficulty, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            logikRatselSettings.difficulty = difficulty;
        }

        function selectPatternCount(count, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            logikRatselSettings.numberCount = count;
        }

        function startLogikRatselGame() {
            logikRatselState = {
                currentQuestion: 0,
                score: 0,
                pattern: [],
                correctAnswer: 0,
                patternRule: ''
            };

            // Reset progress boxes
            const boxes = document.querySelectorAll('#logikRatselProgressBoxes .progress-box');
            boxes.forEach(box => {
                box.classList.remove('correct', 'wrong');
            });

            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('logikRatselGameScreen').classList.add('active');

            showLogikRatselQuestion();
        }

        function showLogikRatselQuestion() {
            if (logikRatselState.currentQuestion >= logikRatselSettings.questionCount) {
                endLogikRatselGame();
                return;
            }

            // Determine pattern type
            let type = logikRatselSettings.patternType;
            if (type === 'gemischt') {
                const types = ['addition', 'subtraktion', 'multiplikation'];
                type = types[Math.floor(Math.random() * types.length)];
            }

            // Generate pattern based on difficulty and type
            let pattern = [];
            let step;
            
            if (type === 'addition') {
                if (logikRatselSettings.difficulty === 'leicht') {
                    step = Math.floor(Math.random() * 3) + 1; // +1, +2, +3
                } else if (logikRatselSettings.difficulty === 'mittel') {
                    step = Math.floor(Math.random() * 5) + 3; // +3 to +7
                } else {
                    step = Math.floor(Math.random() * 8) + 5; // +5 to +12
                }
                
                let start = Math.floor(Math.random() * 10) + 1;
                for (let i = 0; i < logikRatselSettings.numberCount; i++) {
                    pattern.push(start + (i * step));
                }
                logikRatselState.patternRule = `+${step}`;
                
            } else if (type === 'subtraktion') {
                if (logikRatselSettings.difficulty === 'leicht') {
                    step = Math.floor(Math.random() * 3) + 1; // -1, -2, -3
                } else if (logikRatselSettings.difficulty === 'mittel') {
                    step = Math.floor(Math.random() * 5) + 3; // -3 to -7
                } else {
                    step = Math.floor(Math.random() * 8) + 5; // -5 to -12
                }
                
                let start = Math.floor(Math.random() * 30) + 50; // Start high enough
                for (let i = 0; i < logikRatselSettings.numberCount; i++) {
                    pattern.push(start - (i * step));
                }
                logikRatselState.patternRule = `-${step}`;
                
            } else { // multiplikation
                if (logikRatselSettings.difficulty === 'leicht') {
                    step = 2; // ×2
                } else if (logikRatselSettings.difficulty === 'mittel') {
                    step = Math.random() < 0.5 ? 2 : 3; // ×2 or ×3
                } else {
                    step = Math.floor(Math.random() * 3) + 2; // ×2, ×3, or ×4
                }
                
                let start = Math.floor(Math.random() * 5) + 1;
                for (let i = 0; i < logikRatselSettings.numberCount; i++) {
                    pattern.push(start * Math.pow(step, i));
                }
                logikRatselState.patternRule = `×${step}`;
            }

            // Calculate correct answer (next number in pattern)
            if (type === 'addition') {
                logikRatselState.correctAnswer = pattern[pattern.length - 1] + step;
            } else if (type === 'subtraktion') {
                logikRatselState.correctAnswer = pattern[pattern.length - 1] - step;
            } else {
                logikRatselState.correctAnswer = pattern[pattern.length - 1] * step;
            }

            logikRatselState.pattern = pattern;

            // Display pattern and options
            displayLogikPattern(pattern);
            generateLogikOptions(logikRatselState.correctAnswer);
        }

        function displayLogikPattern(pattern) {
            const container = document.getElementById('logikRatselPattern');
            container.innerHTML = '';

            pattern.forEach(num => {
                const numBox = document.createElement('div');
                numBox.style.cssText = `
                    font-size: 3em;
                    font-weight: bold;
                    color: white;
                    background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
                    padding: 20px 30px;
                    border-radius: 20px;
                    border: 3px solid rgba(255,255,255,0.3);
                    min-width: 80px;
                    text-align: center;
                    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                `;
                numBox.textContent = num;
                container.appendChild(numBox);
            });

            // Add question mark
            const questionBox = document.createElement('div');
            questionBox.style.cssText = `
                font-size: 3em;
                font-weight: bold;
                color: #FFD700;
                background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,215,0,0.1));
                padding: 20px 30px;
                border-radius: 20px;
                border: 3px solid #FFD700;
                min-width: 80px;
                text-align: center;
                text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                animation: pulse 1.5s ease-in-out infinite;
            `;
            questionBox.textContent = '?';
            container.appendChild(questionBox);
        }

        function generateLogikOptions(correctAnswer) {
            const options = [correctAnswer];
            
            // Generate 2 wrong answers
            while (options.length < 3) {
                let wrongAnswer;
                const offset = Math.floor(Math.random() * 10) + 1;
                wrongAnswer = correctAnswer + (Math.random() < 0.5 ? offset : -offset);
                
                if (wrongAnswer > 0 && !options.includes(wrongAnswer)) {
                    options.push(wrongAnswer);
                }
            }

            // Shuffle options
            options.sort(() => Math.random() - 0.5);

            // Display options as abacus
            const container = document.getElementById('logikRatselOptions');
            container.innerHTML = '';

            options.forEach(option => {
                const btn = document.createElement('div');
                btn.style.cssText = `
                    cursor: pointer;
                    transition: all 0.3s ease;
                    padding: 25px;
                    background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
                    border-radius: 20px;
                    border: 3px solid rgba(255,255,255,0.3);
                    backdrop-filter: blur(10px);
                `;
                btn.dataset.value = option;
                btn.innerHTML = drawLogikAbacus(option);
                btn.onclick = () => checkLogikAnswer(option);
                
                btn.onmouseenter = () => {
                    btn.style.background = 'linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.15))';
                    btn.style.transform = 'translateY(-5px) scale(1.03)';
                    btn.style.borderColor = 'rgba(255,255,255,0.5)';
                };
                btn.onmouseleave = () => {
                    btn.style.background = 'linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05))';
                    btn.style.transform = 'translateY(0) scale(1)';
                    btn.style.borderColor = 'rgba(255,255,255,0.3)';
                };
                
                container.appendChild(btn);
            });
        }

        function drawLogikAbacus(number) {
            // Determine digit count based on number
            const digitCount = number.toString().length;
            const numStr = number.toString().padStart(digitCount, '0');
            const digits = numStr.split('').map(d => parseInt(d));

            let html = '<div style="display: flex; justify-content: center; gap: 12px; padding: 15px;">';

            digits.forEach((digit) => {
                html += `<div style="display: flex; flex-direction: column; align-items: center; width: 40px;">`;
                html += `<div style="width: 5px; height: 150px; background: #5DADE2; position: relative; border-radius: 3px;">`;
                
                // Heaven bead
                if (digit >= 5) {
                    html += `<div style="position: absolute; bottom: 73px; left: -15px; width: 35px; height: 18px; background: linear-gradient(145deg, #FFD700, #FFA500); border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`;
                }
                
                // Divider
                html += `<div style="position: absolute; top: 75px; left: -15px; right: -15px; height: 3px; background: #5DADE2; border-radius: 2px;"></div>`;
                
                // Earth beads
                const activeCount = digit % 5;
                for (let i = 0; i < activeCount; i++) {
                    html += `<div style="position: absolute; top: ${78 + i * 18}px; left: -15px; width: 35px; height: 18px; background: linear-gradient(145deg, #FFD700, #FFA500); border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`;
                }
                
                html += `</div></div>`;
            });

            html += '</div>';
            return html;
        }

        function checkLogikAnswer(selectedAnswer) {
            const isCorrect = selectedAnswer === logikRatselState.correctAnswer;
            
            // Update progress box
            const boxes = document.querySelectorAll('#logikRatselProgressBoxes .progress-box');
            const currentBox = boxes[logikRatselState.currentQuestion];
            if (currentBox) {
                currentBox.classList.add(isCorrect ? 'correct' : 'wrong');
            }

            // Disable all buttons and show feedback
            const buttons = document.querySelectorAll('#logikRatselOptions > div');
            buttons.forEach(btn => {
                const value = parseInt(btn.dataset.value);
                btn.style.pointerEvents = 'none';
                
                if (value === logikRatselState.correctAnswer) {
                    btn.style.background = 'linear-gradient(145deg, rgba(76, 175, 80, 0.4), rgba(76, 175, 80, 0.2))';
                    btn.style.borderColor = '#4CAF50';
                    btn.style.transform = 'scale(1.05)';
                    btn.style.boxShadow = '0 0 30px rgba(76, 175, 80, 0.6)';
                } else if (value === selectedAnswer && !isCorrect) {
                    btn.style.background = 'linear-gradient(145deg, rgba(244, 67, 54, 0.4), rgba(244, 67, 54, 0.2))';
                    btn.style.borderColor = '#f44336';
                }
            });

            if (isCorrect) {
                logikRatselState.score++;
                playBeep();
            }

            // Next question after delay
            setTimeout(() => {
                logikRatselState.currentQuestion++;
                showLogikRatselQuestion();
            }, 1500);
        }

        function endLogikRatselGame() {
            showScreen('resultScreen');
            
            const percentage = Math.round((logikRatselState.score / logikRatselSettings.questionCount) * 100);
            const resultMessage = document.getElementById('resultMessage');
            
            if (percentage === 100) {
                const perfectMessages = [
                    '🎉 SUPER! 🎉',
                    '⭐ TOLL! ⭐',
                    '🏆 FANTASTISCH! 🏆',
                    '🌟 PERFEKT! 🌟',
                    '💪 STARK! 💪',
                    '🎊 SPITZE! 🎊'
                ];
                resultMessage.textContent = perfectMessages[Math.floor(Math.random() * perfectMessages.length)];
                resultMessage.className = 'result-message correct';
                playSuccessSound();
                createConfetti();
            } else if (percentage >= 75) {
                const goodMessages = [
                    '👏 SEHR GUT! 👏',
                    '🌟 TOLL GEMACHT! 🌟',
                    '💪 SUPER LEISTUNG! 💪'
                ];
                resultMessage.textContent = goodMessages[Math.floor(Math.random() * goodMessages.length)];
                resultMessage.className = 'result-message correct';
            } else if (percentage >= 50) {
                const okMessages = [
                    '👍 GUT GEMACHT! 👍',
                    '💫 WEITER SO! 💫',
                    '⭐ SCHÖN! ⭐'
                ];
                resultMessage.textContent = okMessages[Math.floor(Math.random() * okMessages.length)];
                resultMessage.className = 'result-message correct';
            } else {
                const encourageMessages = [
                    '💪 Weiter üben!',
                    '🌈 Nächstes Mal!',
                    '⭐ Fast geschafft!',
                    '💫 Du schaffst das!'
                ];
                resultMessage.textContent = encourageMessages[Math.floor(Math.random() * encourageMessages.length)];
                resultMessage.className = 'result-message wrong';
            }
            
            let typeText;
            if (logikRatselSettings.patternType === 'addition') {
                typeText = 'Addition';
            } else if (logikRatselSettings.patternType === 'subtraktion') {
                typeText = 'Subtraktion';
            } else if (logikRatselSettings.patternType === 'multiplikation') {
                typeText = 'Multiplikation';
            } else {
                typeText = 'Gemischt';
            }
            
            const difficultyText = logikRatselSettings.difficulty.charAt(0).toUpperCase() + logikRatselSettings.difficulty.slice(1);
            document.getElementById('questionText').textContent = 
                `Typ: ${typeText} | ${logikRatselSettings.numberCount} Zahlen | ${difficultyText} | ${logikRatselState.score} von ${logikRatselSettings.questionCount} richtig!`;
            document.getElementById('correctAnswer').textContent = `Erfolgsquote: ${percentage}%`;
            document.getElementById('userAnswer').textContent = '';
        }

        // Zahlen Vergleichen Settings and State
        let zahlenVergleichenSettings = {
            mode: 'groesser', // 'groesser', 'kleiner', or 'groesste'
            digits: 1, // 1, 2, or 3
            difficulty: 'leicht', // 'leicht', 'mittel', 'schwer'
            questionCount: 8
        };

        let zahlenVergleichenState = {
            currentQuestion: 0,
            score: 0,
            numbers: [],
            correctAnswer: 0
        };

        function showZahlenVergleichenSettings() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('zahlenVergleichenSettingsScreen').classList.add('active');
        }

        function selectCompareMode(mode, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            zahlenVergleichenSettings.mode = mode;
        }

        function selectCompareDigits(digits, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            zahlenVergleichenSettings.digits = digits;
        }

        function selectCompareDifficulty(difficulty, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            zahlenVergleichenSettings.difficulty = difficulty;
        }

        function startZahlenVergleichenGame() {
            zahlenVergleichenState = {
                currentQuestion: 0,
                score: 0,
                numbers: [],
                correctAnswer: 0
            };

            // Reset progress boxes
            const boxes = document.querySelectorAll('#zahlenVergleichenProgressBoxes .progress-box');
            boxes.forEach(box => {
                box.classList.remove('correct', 'wrong');
            });

            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('zahlenVergleichenGameScreen').classList.add('active');

            showZahlenVergleichenQuestion();
        }

        function showZahlenVergleichenQuestion() {
            if (zahlenVergleichenState.currentQuestion >= zahlenVergleichenSettings.questionCount) {
                endZahlenVergleichenGame();
                return;
            }

            // Update question text based on mode
            let questionText;
            if (zahlenVergleichenSettings.mode === 'groesser') {
                questionText = 'Welche ist größer?';
            } else if (zahlenVergleichenSettings.mode === 'kleiner') {
                questionText = 'Welche ist kleiner?';
            } else {
                questionText = 'Welche ist die Größte?';
            }
            document.getElementById('zahlenVergleichenQuestion').textContent = questionText;

            // Determine how many numbers to generate (2 or 3)
            const numberCount = zahlenVergleichenSettings.mode === 'groesste' ? 3 : 2;
            
            // Generate numbers based on difficulty
            const maxNum = Math.pow(10, zahlenVergleichenSettings.digits) - 1;
            const minNum = zahlenVergleichenSettings.digits === 1 ? 0 : Math.pow(10, zahlenVergleichenSettings.digits - 1);
            
            let numbers = [];
            
            if (zahlenVergleichenSettings.difficulty === 'leicht') {
                // Large differences
                const minDiff = Math.floor(maxNum * 0.3);
                numbers.push(Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum);
                
                for (let i = 1; i < numberCount; i++) {
                    let newNum;
                    let attempts = 0;
                    do {
                        newNum = Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum;
                        attempts++;
                    } while (attempts < 50 && numbers.some(n => Math.abs(n - newNum) < minDiff));
                    numbers.push(newNum);
                }
                
            } else if (zahlenVergleichenSettings.difficulty === 'mittel') {
                // Medium differences
                const minDiff = Math.floor(maxNum * 0.1);
                const maxDiff = Math.floor(maxNum * 0.3);
                numbers.push(Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum);
                
                for (let i = 1; i < numberCount; i++) {
                    let newNum;
                    let attempts = 0;
                    do {
                        newNum = Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum;
                        attempts++;
                    } while (attempts < 50 && numbers.some(n => {
                        const diff = Math.abs(n - newNum);
                        return diff < minDiff || diff > maxDiff;
                    }));
                    numbers.push(newNum);
                }
                
            } else { // schwer
                // Small differences
                const maxDiff = Math.max(3, Math.floor(maxNum * 0.05));
                numbers.push(Math.floor(Math.random() * (maxNum - minNum + 1)) + minNum);
                
                for (let i = 1; i < numberCount; i++) {
                    let newNum;
                    let attempts = 0;
                    do {
                        const offset = Math.floor(Math.random() * maxDiff) + 1;
                        newNum = numbers[0] + (Math.random() < 0.5 ? offset : -offset);
                        attempts++;
                    } while (attempts < 50 && (newNum < minNum || newNum > maxNum || numbers.includes(newNum)));
                    numbers.push(newNum);
                }
            }

            zahlenVergleichenState.numbers = numbers;
            
            // Determine correct answer based on mode
            if (zahlenVergleichenSettings.mode === 'groesser' || zahlenVergleichenSettings.mode === 'groesste') {
                zahlenVergleichenState.correctAnswer = Math.max(...numbers);
            } else {
                zahlenVergleichenState.correctAnswer = Math.min(...numbers);
            }

            // Display abacus options
            displayCompareAbacusOptions(numbers);
        }

        function displayCompareAbacusOptions(numbers) {
            const container = document.getElementById('zahlenVergleichenOptions');
            container.innerHTML = '';
            
            // Set grid based on number count
            if (numbers.length === 2) {
                container.style.gridTemplateColumns = 'repeat(2, 1fr)';
            } else {
                container.style.gridTemplateColumns = 'repeat(3, 1fr)';
            }

            numbers.forEach(num => {
                const btn = document.createElement('div');
                btn.style.cssText = `
                    cursor: pointer; 
                    transition: all 0.3s ease; 
                    padding: 30px; 
                    background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05)); 
                    border-radius: 25px; 
                    border: 3px solid rgba(255,255,255,0.3);
                    backdrop-filter: blur(10px);
                `;
                btn.dataset.value = num;
                btn.innerHTML = drawCompareAbacus(num);
                btn.onclick = () => checkCompareAnswer(num);
                
                btn.onmouseenter = () => {
                    btn.style.background = 'linear-gradient(145deg, rgba(255,255,255,0.25), rgba(255,255,255,0.15))';
                    btn.style.transform = 'translateY(-8px) scale(1.03)';
                    btn.style.borderColor = 'rgba(255,255,255,0.5)';
                    btn.style.boxShadow = '0 12px 30px rgba(0,0,0,0.3)';
                };
                btn.onmouseleave = () => {
                    btn.style.background = 'linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05))';
                    btn.style.transform = 'translateY(0) scale(1)';
                    btn.style.borderColor = 'rgba(255,255,255,0.3)';
                    btn.style.boxShadow = 'none';
                };
                
                container.appendChild(btn);
            });
        }

        function drawCompareAbacus(number) {
            const digitCount = zahlenVergleichenSettings.digits;
            const numStr = number.toString().padStart(digitCount, '0');
            const digits = numStr.split('').map(d => parseInt(d));

            let html = '<div style="display: flex; justify-content: center; gap: 15px; padding: 20px;">';

            digits.forEach((digit) => {
                html += `<div style="display: flex; flex-direction: column; align-items: center; width: 50px;">`;
                html += `<div style="width: 6px; height: 180px; background: #5DADE2; position: relative; border-radius: 3px;">`;
                
                // Heaven bead
                if (digit >= 5) {
                    html += `<div style="position: absolute; bottom: 88px; left: -18px; width: 42px; height: 20px; background: linear-gradient(145deg, #FFD700, #FFA500); border-radius: 50%; box-shadow: 0 3px 6px rgba(0,0,0,0.3);"></div>`;
                }
                
                // Divider
                html += `<div style="position: absolute; top: 90px; left: -18px; right: -18px; height: 4px; background: #5DADE2; border-radius: 2px;"></div>`;
                
                // Earth beads
                const activeCount = digit % 5;
                for (let i = 0; i < activeCount; i++) {
                    html += `<div style="position: absolute; top: ${94 + i * 22}px; left: -18px; width: 42px; height: 20px; background: linear-gradient(145deg, #FFD700, #FFA500); border-radius: 50%; box-shadow: 0 3px 6px rgba(0,0,0,0.3);"></div>`;
                }
                
                html += `</div></div>`;
            });

            html += '</div>';
            return html;
        }

        function checkCompareAnswer(selectedNumber) {
            const isCorrect = selectedNumber === zahlenVergleichenState.correctAnswer;
            
            // Update progress box
            const boxes = document.querySelectorAll('#zahlenVergleichenProgressBoxes .progress-box');
            const currentBox = boxes[zahlenVergleichenState.currentQuestion];
            if (currentBox) {
                currentBox.classList.add(isCorrect ? 'correct' : 'wrong');
            }

            // Disable all buttons and show correct/wrong
            const buttons = document.querySelectorAll('#zahlenVergleichenOptions > div');
            buttons.forEach(btn => {
                const value = parseInt(btn.dataset.value);
                btn.style.pointerEvents = 'none';
                
                if (value === zahlenVergleichenState.correctAnswer) {
                    btn.style.background = 'linear-gradient(145deg, rgba(76, 175, 80, 0.4), rgba(76, 175, 80, 0.2))';
                    btn.style.borderColor = '#4CAF50';
                    btn.style.transform = 'scale(1.05)';
                    btn.style.boxShadow = '0 0 30px rgba(76, 175, 80, 0.6)';
                } else if (value === selectedNumber && !isCorrect) {
                    btn.style.background = 'linear-gradient(145deg, rgba(244, 67, 54, 0.4), rgba(244, 67, 54, 0.2))';
                    btn.style.borderColor = '#f44336';
                    btn.style.boxShadow = '0 0 20px rgba(244, 67, 54, 0.5)';
                }
            });

            if (isCorrect) {
                zahlenVergleichenState.score++;
                playBeep();
            }

            // Next question after delay
            setTimeout(() => {
                zahlenVergleichenState.currentQuestion++;
                showZahlenVergleichenQuestion();
            }, 1500);
        }

        function endZahlenVergleichenGame() {
            showScreen('resultScreen');
            
            const percentage = Math.round((zahlenVergleichenState.score / zahlenVergleichenSettings.questionCount) * 100);
            const resultMessage = document.getElementById('resultMessage');
            
            if (percentage === 100) {
                const perfectMessages = [
                    '🎉 SUPER! 🎉',
                    '⭐ TOLL! ⭐',
                    '🏆 FANTASTISCH! 🏆',
                    '🌟 PERFEKT! 🌟',
                    '💪 STARK! 💪',
                    '🎊 SPITZE! 🎊'
                ];
                resultMessage.textContent = perfectMessages[Math.floor(Math.random() * perfectMessages.length)];
                resultMessage.className = 'result-message correct';
                playSuccessSound();
                createConfetti();
            } else if (percentage >= 75) {
                const goodMessages = [
                    '👏 SEHR GUT! 👏',
                    '🌟 TOLL GEMACHT! 🌟',
                    '💪 SUPER LEISTUNG! 💪'
                ];
                resultMessage.textContent = goodMessages[Math.floor(Math.random() * goodMessages.length)];
                resultMessage.className = 'result-message correct';
            } else if (percentage >= 50) {
                const okMessages = [
                    '👍 GUT GEMACHT! 👍',
                    '💫 WEITER SO! 💫',
                    '⭐ SCHÖN! ⭐'
                ];
                resultMessage.textContent = okMessages[Math.floor(Math.random() * okMessages.length)];
                resultMessage.className = 'result-message correct';
            } else {
                const encourageMessages = [
                    '💪 Weiter üben!',
                    '🌈 Nächstes Mal!',
                    '⭐ Fast geschafft!',
                    '💫 Du schaffst das!'
                ];
                resultMessage.textContent = encourageMessages[Math.floor(Math.random() * encourageMessages.length)];
                resultMessage.className = 'result-message wrong';
            }
            
            let modeText;
            if (zahlenVergleichenSettings.mode === 'groesser') {
                modeText = 'Größer';
            } else if (zahlenVergleichenSettings.mode === 'kleiner') {
                modeText = 'Kleiner';
            } else {
                modeText = 'Die Größte (3 Abakusse)';
            }
            
            const difficultyText = zahlenVergleichenSettings.difficulty.charAt(0).toUpperCase() + zahlenVergleichenSettings.difficulty.slice(1);
            document.getElementById('questionText').textContent = 
                `Modus: ${modeText} | ${zahlenVergleichenSettings.digits} Stellen | ${difficultyText} | ${zahlenVergleichenState.score} von ${zahlenVergleichenSettings.questionCount} richtig!`;
            document.getElementById('correctAnswer').textContent = `Erfolgsquote: ${percentage}%`;
            document.getElementById('userAnswer').textContent = '';
        }

        // Zahlen Merken Settings and State
        let zahlenMerkenSettings = {
            mode: 'vorwarts', // 'vorwarts' or 'ruckwarts'
            numberCount: 4, // 3-8
            displayTime: 3, // 3, 5, 7 seconds
            questionCount: 8
        };

        let zahlenMerkenState = {
            currentQuestion: 0,
            score: 0,
            correctSequence: [],
            userSequence: []
        };

        function showZahlenMerkenSettings() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('zahlenMerkenSettingsScreen').classList.add('active');
        }

        function selectMemoryMode(mode, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            zahlenMerkenSettings.mode = mode;
        }

        function selectMemoryCount(count, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            zahlenMerkenSettings.numberCount = count;
        }

        function selectMemoryTime(seconds, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            zahlenMerkenSettings.displayTime = seconds;
        }

        function startZahlenMerkenGame() {
            zahlenMerkenState = {
                currentQuestion: 0,
                score: 0,
                correctSequence: [],
                userSequence: []
            };

            // Reset progress boxes
            const boxes = document.querySelectorAll('#zahlenMerkenProgressBoxes .progress-box');
            boxes.forEach(box => {
                box.classList.remove('correct', 'wrong');
            });

            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('zahlenMerkenGameScreen').classList.add('active');

            showZahlenMerkenQuestion();
        }

        function showZahlenMerkenQuestion() {
            if (zahlenMerkenState.currentQuestion >= zahlenMerkenSettings.questionCount) {
                endZahlenMerkenGame();
                return;
            }

            // Generate random number sequence
            const sequence = [];
            for (let i = 0; i < zahlenMerkenSettings.numberCount; i++) {
                sequence.push(Math.floor(Math.random() * 10)); // 0-9
            }

            zahlenMerkenState.correctSequence = sequence;
            zahlenMerkenState.userSequence = [];

            // Update prompt based on mode
            const prompt = document.getElementById('zahlenMerkenPrompt');
            if (zahlenMerkenSettings.mode === 'vorwarts') {
                prompt.textContent = 'Welche Zahlen waren es? (In richtiger Reihenfolge)';
            } else {
                prompt.textContent = 'In umgekehrter Reihenfolge?';
            }

            // Hide answer section
            document.getElementById('zahlenMerkenAnswerSection').style.display = 'none';
            updateMemoryAnswerDisplay();

            // Display numbers
            displayMemoryNumbers(sequence);
        }

        function displayMemoryNumbers(sequence) {
            const display = document.getElementById('zahlenMerkenDisplay');
            
            // Show numbers with spacing - SMALLER SIZE
            display.innerHTML = `
                <div style="display: flex; gap: 15px; align-items: center; justify-content: center; flex-wrap: wrap;">
                    ${sequence.map(num => `
                        <div style="
                            font-size: 3em; 
                            font-weight: bold; 
                            color: white; 
                            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
                            background: linear-gradient(135deg, rgba(255,255,255,0.2), rgba(255,255,255,0.1));
                            padding: 15px 25px;
                            border-radius: 15px;
                            border: 3px solid rgba(255,255,255,0.3);
                            min-width: 70px;
                            text-align: center;
                        ">${num}</div>
                    `).join('')}
                </div>
            `;

            playBeep();

            // Hide after display time
            setTimeout(() => {
                display.innerHTML = `
                    <div style="font-size: 2em; color: rgba(255,255,255,0.4); text-align: center;">
                        <div style="font-size: 2.5em; margin-bottom: 10px;">🧠</div>
                        <div>Erinnere dich...</div>
                    </div>
                `;

                // Show answer section
                document.getElementById('zahlenMerkenAnswerSection').style.display = 'block';
            }, zahlenMerkenSettings.displayTime * 1000);
        }

        function addMemoryDigit(digit) {
            if (zahlenMerkenState.userSequence.length < zahlenMerkenSettings.numberCount) {
                zahlenMerkenState.userSequence.push(digit);
                updateMemoryAnswerDisplay();
                playBeep();
            }
        }

        function deleteMemoryDigit() {
            if (zahlenMerkenState.userSequence.length > 0) {
                zahlenMerkenState.userSequence.pop();
                updateMemoryAnswerDisplay();
            }
        }

        function updateMemoryAnswerDisplay() {
            const display = document.getElementById('zahlenMerkenUserAnswer');
            
            if (zahlenMerkenState.userSequence.length === 0) {
                display.innerHTML = '<span style="color: #999;">-</span>';
            } else {
                display.textContent = zahlenMerkenState.userSequence.join(' - ');
            }
        }

        function checkMemoryAnswer() {
            if (zahlenMerkenState.userSequence.length !== zahlenMerkenSettings.numberCount) {
                alert(`Bitte gib ${zahlenMerkenSettings.numberCount} Zahlen ein!`);
                return;
            }

            // Check if answer is correct based on mode
            let isCorrect;
            if (zahlenMerkenSettings.mode === 'vorwarts') {
                isCorrect = JSON.stringify(zahlenMerkenState.userSequence) === JSON.stringify(zahlenMerkenState.correctSequence);
            } else {
                const reversed = [...zahlenMerkenState.correctSequence].reverse();
                isCorrect = JSON.stringify(zahlenMerkenState.userSequence) === JSON.stringify(reversed);
            }

            // Update progress box
            const boxes = document.querySelectorAll('#zahlenMerkenProgressBoxes .progress-box');
            const currentBox = boxes[zahlenMerkenState.currentQuestion];
            if (currentBox) {
                currentBox.classList.add(isCorrect ? 'correct' : 'wrong');
            }

            if (isCorrect) {
                zahlenMerkenState.score++;
                playSuccessSound();
                
                // Show success message briefly
                const display = document.getElementById('zahlenMerkenDisplay');
                display.innerHTML = `
                    <div style="font-size: 4em; color: #4CAF50; text-align: center; animation: pulse 0.5s ease;">
                        ✓ RICHTIG!
                    </div>
                `;
            } else {
                // Show correct answer
                const display = document.getElementById('zahlenMerkenDisplay');
                const correctAnswer = zahlenMerkenSettings.mode === 'vorwarts' 
                    ? zahlenMerkenState.correctSequence 
                    : [...zahlenMerkenState.correctSequence].reverse();
                
                display.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 3em; color: #f44336; margin-bottom: 20px;">✗ FALSCH</div>
                        <div style="font-size: 1.5em; color: white;">Richtige Antwort:</div>
                        <div style="font-size: 3em; color: #FFD700; margin-top: 10px; font-weight: bold;">
                            ${correctAnswer.join(' - ')}
                        </div>
                    </div>
                `;
            }

            // Next question after delay
            setTimeout(() => {
                zahlenMerkenState.currentQuestion++;
                showZahlenMerkenQuestion();
            }, 2000);
        }

        function endZahlenMerkenGame() {
            showScreen('resultScreen');
            
            const percentage = Math.round((zahlenMerkenState.score / zahlenMerkenSettings.questionCount) * 100);
            const resultMessage = document.getElementById('resultMessage');
            
            if (percentage === 100) {
                const perfectMessages = [
                    '🎉 SUPER! 🎉',
                    '⭐ TOLL! ⭐',
                    '🏆 FANTASTISCH! 🏆',
                    '🌟 PERFEKT! 🌟',
                    '💪 STARK! 💪',
                    '🎊 SPITZE! 🎊'
                ];
                resultMessage.textContent = perfectMessages[Math.floor(Math.random() * perfectMessages.length)];
                resultMessage.className = 'result-message correct';
                playSuccessSound();
                createConfetti();
            } else if (percentage >= 75) {
                const goodMessages = [
                    '👏 SEHR GUT! 👏',
                    '🌟 TOLL GEMACHT! 🌟',
                    '💪 SUPER LEISTUNG! 💪'
                ];
                resultMessage.textContent = goodMessages[Math.floor(Math.random() * goodMessages.length)];
                resultMessage.className = 'result-message correct';
            } else if (percentage >= 50) {
                const okMessages = [
                    '👍 GUT GEMACHT! 👍',
                    '💫 WEITER SO! 💫',
                    '⭐ SCHÖN! ⭐'
                ];
                resultMessage.textContent = okMessages[Math.floor(Math.random() * okMessages.length)];
                resultMessage.className = 'result-message correct';
            } else {
                const encourageMessages = [
                    '💪 Weiter üben!',
                    '🌈 Nächstes Mal!',
                    '⭐ Fast geschafft!',
                    '💫 Du schaffst das!'
                ];
                resultMessage.textContent = encourageMessages[Math.floor(Math.random() * encourageMessages.length)];
                resultMessage.className = 'result-message wrong';
            }
            
            const modeText = zahlenMerkenSettings.mode === 'vorwarts' ? 'Vorwärts' : 'Rückwärts';
            document.getElementById('questionText').textContent = 
                `Modus: ${modeText} | ${zahlenMerkenSettings.numberCount} Zahlen | Du hast ${zahlenMerkenState.score} von ${zahlenMerkenSettings.questionCount} richtig!`;
            document.getElementById('correctAnswer').textContent = `Erfolgsquote: ${percentage}%`;
            document.getElementById('userAnswer').textContent = '';
        }

        // Visual Training settings
        let visualTrainingSettings = {
            mode: 'flashLeicht',
            displayTime: 3,
            abacusCount: 3,
            digits: 1,
            questionCount: 8
        };

        let visualTrainingState = {
            currentQuestion: 0,
            score: 0,
            correctAnswer: 0,
            questions: []
        };

        function showVisualTrainingSettings() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('visualTrainingSettingsScreen').classList.add('active');
        }

        function selectVisualMode(mode, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            visualTrainingSettings.mode = mode;
            
            const countSection = document.getElementById('visualCountSection');
            if (mode === 'flashAddition') {
                countSection.style.display = 'block';
            } else {
                countSection.style.display = 'none';
            }
        }

        function selectVisualSpeed(seconds, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            visualTrainingSettings.displayTime = seconds;
        }

        function selectVisualCount(count, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            visualTrainingSettings.abacusCount = count;
        }

        function selectVisualDigits(digits, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            visualTrainingSettings.digits = digits;
        }

        function startVisualTrainingGame() {
            // Use visualTrainingSettings instead of flashcardSettings
            flashcardSettings.mode = visualTrainingSettings.mode;
            flashcardSettings.displayTime = visualTrainingSettings.displayTime;
            flashcardSettings.abacusCount = visualTrainingSettings.abacusCount;
            flashcardSettings.digits = visualTrainingSettings.digits;
            
            // Start the game using existing flashcard game logic
            startFlashcardGame();
        }

        // Current game mode
        let currentGameMode = 'anzan'; // 'anzan', 'tandem', 'flashcard', 'anzanVisual', or 'sesliAnzan'

        // Sesli Anzan settings
        let sesliAnzanSettings = {
            mode: 'sehenHoren' // 'sehenHoren' (Mod 1) or 'nurHoren' (Mod 2)
        };

        function showSesliAnzanSettings() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('sesliAnzanSettingsScreen').classList.add('active');
        }

        function selectSesliAnzanMode(mode, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            sesliAnzanSettings.mode = mode;
        }

        function startSesliAnzanGame() {
            // Use same Anzan logic but with voice
            currentGameMode = 'sesliAnzan';
            startGame();
        }

        // Flash Card settings and state
        let flashcardSettings = {
            mode: 'abacusToNumber', // 'abacusToNumber', 'numberToAbacus', or 'abacusAnzan'
            digits: 1, // 1, 2, or 3 digits
            displayTime: 3, // Display time in seconds (1-5)
            abacusCount: 3, // Number of abacuses to add (2-5)
            questionCount: 8 // Fixed at 8 questions
        };

        let flashcardState = {
            currentQuestion: 0,
            score: 0,
            correctAnswer: 0,
            questions: []
        };

        // Tandem variables
        let tandemLeftNumbers = [];
        let tandemRightNumbers = [];
        let tandemLeftCorrect = 0;
        let tandemRightCorrect = 0;

        function selectTandemOption(type, value, element) {
            tandemSettings[type] = value;
            
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
        }

        function startTandemGame() {
            // Generate numbers for both sides
            generateTandemNumbers();
            
            // Show countdown screen (same as Anzan!)
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('countdownScreen').classList.add('active');

            const countdownProgress = document.getElementById('countdownProgress');
            const countdownLogo = document.getElementById('countdownLogo');
            const countdownLos = document.getElementById('countdownLos');
            
            // Reset states
            countdownLogo.classList.remove('hide');
            countdownLogo.style.display = 'block';
            countdownLos.style.display = 'none';
            
            // Reset progress
            countdownProgress.style.strokeDashoffset = '565.5';
            
            // Animate with requestAnimationFrame
            const duration = 3000; // 3 seconds
            const start = performance.now();
            const startOffset = 565.5;
            
            // Play initial beep
            playBeep();
            
            function animate(currentTime) {
                const elapsed = currentTime - start;
                const progress = Math.min(elapsed / duration, 1);
                
                // Ease-in-out function
                const easeProgress = progress < 0.5
                    ? 2 * progress * progress
                    : 1 - Math.pow(-2 * progress + 2, 2) / 2;
                
                const currentOffset = startOffset - (startOffset * easeProgress);
                countdownProgress.style.strokeDashoffset = currentOffset;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // Animation complete - show LOS
                    countdownLogo.classList.add('hide');
                    setTimeout(() => {
                        countdownLogo.style.display = 'none';
                        countdownLos.style.display = 'block';
                    }, 300);
                    
                    // Start displaying Tandem numbers
                    setTimeout(() => {
                        displayTandemNumbersInGame();
                    }, 1500);
                }
            }
            
            requestAnimationFrame(animate);
        }

        function generateTandemNumbers() {
            const [min, max] = settings.zahlenbereich; // Use Anzan settings!
            const count = settings.anzahl; // Use Anzan settings!
            
            // Generate left side numbers
            tandemLeftNumbers = [];
            for (let i = 0; i < count; i++) {
                let num;
                do {
                    num = Math.floor(Math.random() * (max - min + 1)) + min;
                } while (i > 0 && num === tandemLeftNumbers[i - 1]);
                tandemLeftNumbers.push(num);
            }
            
            // Generate right side numbers
            tandemRightNumbers = [];
            for (let i = 0; i < count; i++) {
                let num;
                do {
                    num = Math.floor(Math.random() * (max - min + 1)) + min;
                } while (i > 0 && num === tandemRightNumbers[i - 1]);
                tandemRightNumbers.push(num);
            }
            
            // Calculate correct answers
            if (settings.rechenart === 'addition') { // Use Anzan settings!
                tandemLeftCorrect = tandemLeftNumbers.reduce((sum, n) => sum + n, 0);
                tandemRightCorrect = tandemRightNumbers.reduce((sum, n) => sum + n, 0);
            } else if (settings.rechenart === 'subtraktion') { // Use Anzan settings!
                // Ensure positive results
                tandemLeftNumbers.sort((a, b) => b - a);
                tandemRightNumbers.sort((a, b) => b - a);
                
                tandemLeftCorrect = tandemLeftNumbers.reduce((result, n, i) => i === 0 ? n : result - n, 0);
                tandemRightCorrect = tandemRightNumbers.reduce((result, n, i) => i === 0 ? n : result - n, 0);
            }
        }

        function displayTandemNumbers() {
            const container = document.getElementById('tandemDisplayContainer');
            const leftEl = document.getElementById('tandemNumberLeft');
            const rightEl = document.getElementById('tandemNumberRight');
            
            container.style.display = 'block';
            
            let index = 0;
            const interval = 1000 / settings.geschwindigkeit; // Use Anzan settings!
            
            const displayInterval = setInterval(() => {
                if (index < tandemLeftNumbers.length) {
                    leftEl.textContent = tandemLeftNumbers[index];
                    rightEl.textContent = tandemRightNumbers[index];
                    playBeep();
                    index++;
                } else {
                    clearInterval(displayInterval);
                    setTimeout(() => {
                        container.style.display = 'none';
                        showTandemAnswerSection();
                    }, 500);
                }
            }, interval);
        }

        function displayTandemNumbersInGame() {
            // Switch to game screen
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('gameScreen').classList.add('active');
            
            // Hide answer section (keypad) for Tandem
            document.getElementById('answerSection').style.display = 'none';
            
            // Use game screen's number display with split view
            const display = document.getElementById('numberDisplay');
            display.style.display = 'flex';
            display.style.flexDirection = 'row';
            display.style.gap = '60px'; // Increased from 20px
            display.style.justifyContent = 'center';
            display.style.alignItems = 'center';
            
            let index = 0;
            const interval = settings.geschwindigkeit / tandemLeftNumbers.length; // Total time divided by count
            
            // Show first number immediately
            function showNumber() {
                if (index < tandemLeftNumbers.length) {
                    // Show both numbers side by side
                    display.innerHTML = `
                        <div style="flex: 1; text-align: center; font-size: 2em; color: white; text-shadow: 4px 4px 8px rgba(0,0,0,0.4);">${tandemLeftNumbers[index]}</div>
                        <div style="width: 4px; height: 300px; background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.6), rgba(255,255,255,0.1)); border-radius: 2px;"></div>
                        <div style="flex: 1; text-align: center; font-size: 2em; color: white; text-shadow: 4px 4px 8px rgba(0,0,0,0.4);">${tandemRightNumbers[index]}</div>
                    `;
                    playBeep();
                    index++;
                    return true;
                } else {
                    return false;
                }
            }
            
            // Show first number immediately
            showNumber();
            
            // Then continue with interval
            const displayInterval = setInterval(() => {
                if (!showNumber()) {
                    clearInterval(displayInterval);
                    setTimeout(() => {
                        // Reset display style and show answer section
                        display.style.display = '';
                        display.style.flexDirection = '';
                        display.style.gap = '';
                        display.style.justifyContent = '';
                        display.style.alignItems = '';
                        showTandemAnswerInGame();
                    }, 500);
                }
            }, interval);
        }

        function showTandemAnswerInGame() {
            // Switch to tandem screen for answer input
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('tandemScreen').classList.add('active');
            
            // Show answer section
            const section = document.getElementById('tandemAnswerSection');
            section.style.display = 'block';
            
            document.getElementById('tandemAnswerLeft').value = '';
            document.getElementById('tandemAnswerRight').value = '';
            document.getElementById('tandemAnswerLeft').focus();
        }

        function checkTandemAnswer() {
            const leftAnswer = parseInt(document.getElementById('tandemAnswerLeft').value);
            const rightAnswer = parseInt(document.getElementById('tandemAnswerRight').value);
            
            if (isNaN(leftAnswer) || isNaN(rightAnswer)) {
                alert('Bitte beide Antworten eingeben!');
                return;
            }
            
            const leftCorrect = leftAnswer === tandemLeftCorrect;
            const rightCorrect = rightAnswer === tandemRightCorrect;
            
            // Show result screen
            showScreen('resultScreen');
            
            if (leftCorrect && rightCorrect) {
                document.getElementById('resultMessage').textContent = '⭐ TOLL! ⭐';
                document.getElementById('resultMessage').className = 'result-message correct';
                playSuccessSound();
                createConfetti();
            } else {
                document.getElementById('resultMessage').textContent = 'SCHADE!';
                document.getElementById('resultMessage').className = 'result-message wrong';
            }
            
            // Build question text
            let leftQuestion = tandemLeftNumbers[0].toString();
            for (let i = 1; i < tandemLeftNumbers.length; i++) {
                leftQuestion += ` ${settings.rechenart === 'addition' ? '+' : '-'} ${tandemLeftNumbers[i]}`; // Use Anzan settings!
            }
            
            let rightQuestion = tandemRightNumbers[0].toString();
            for (let i = 1; i < tandemRightNumbers.length; i++) {
                rightQuestion += ` ${settings.rechenart === 'addition' ? '+' : '-'} ${tandemRightNumbers[i]}`; // Use Anzan settings!
            }
            
            document.getElementById('questionText').textContent = `Links: ${leftQuestion} | Rechts: ${rightQuestion}`;
            document.getElementById('correctAnswer').textContent = `Links: ${tandemLeftCorrect} | Rechts: ${tandemRightCorrect}`;
            
            // Add colored icons to user answer based on correctness
            const userAnswerElement = document.getElementById('userAnswer');
            let userAnswerHTML = '';
            
            if (leftCorrect && rightCorrect) {
                userAnswerHTML = `<span style="color: #4CAF50; font-weight: bold;">✅</span> Links: ${leftAnswer} | Rechts: ${rightAnswer}`;
            } else if (!leftCorrect && !rightCorrect) {
                userAnswerHTML = `<span style="color: #f44336; font-weight: bold;">❌</span> Links: ${leftAnswer} | Rechts: ${rightAnswer}`;
            } else if (leftCorrect && !rightCorrect) {
                userAnswerHTML = `<span style="color: #4CAF50; font-weight: bold;">✅</span> Links: ${leftAnswer} | <span style="color: #f44336; font-weight: bold;">❌</span> Rechts: ${rightAnswer}`;
            } else {
                userAnswerHTML = `<span style="color: #f44336; font-weight: bold;">❌</span> Links: ${leftAnswer} | <span style="color: #4CAF50; font-weight: bold;">✅</span> Rechts: ${rightAnswer}`;
            }
            
            userAnswerElement.innerHTML = userAnswerHTML;
        }

        // ==================== FLASH CARD FUNCTIONS ====================

        function showFlashcardSettings() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('flashcardSettingsScreen').classList.add('active');
        }

        // Anzan Visual Training
        let anzanVisualSettings = {
            mode: 'flashLeicht',
            digits: 1,
            displayTime: 3,
            abacusCount: 3,
            questionCount: 8
        };

        let anzanVisualState = {
            currentQuestion: 0,
            score: 0,
            correctAnswer: 0,
            questions: []
        };

        function showAnzanVisualSettings() {
            console.log('showAnzanVisualSettings called');
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screen = document.getElementById('anzanVisualSettingsScreen');
            console.log('anzanVisualSettingsScreen element:', screen);
            if (screen) {
                screen.classList.add('active');
                console.log('Active class added, classList:', screen.classList);
            } else {
                console.error('anzanVisualSettingsScreen NOT FOUND!');
            }
        }

        function selectAnzanVisualMode(mode, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            anzanVisualSettings.mode = mode;
            
            const countSection = document.getElementById('anzanVisualCountSection');
            
            if (mode === 'flashAddition') {
                countSection.style.display = 'block';
            } else {
                countSection.style.display = 'none';
            }
        }

        function selectAnzanVisualTime(seconds, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            anzanVisualSettings.displayTime = seconds;
        }

        function selectAnzanVisualCount(count, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            anzanVisualSettings.abacusCount = count;
        }

        function selectAnzanVisualDigits(digits, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            anzanVisualSettings.digits = digits;
        }

        function startAnzanVisualGame() {
            console.log('Starting Anzan Visual Game, mode:', anzanVisualSettings.mode);
            
            anzanVisualState = {
                currentQuestion: 0,
                score: 0,
                correctAnswer: 0,
                questions: []
            };

            // Reset progress boxes
            const boxes = document.querySelectorAll('#anzanVisualProgressBoxes .progress-box');
            boxes.forEach(box => {
                box.classList.remove('correct', 'wrong');
            });

            const maxNum = Math.pow(10, anzanVisualSettings.digits) - 1;

            for (let i = 0; i < anzanVisualSettings.questionCount; i++) {
                const num = Math.floor(Math.random() * (maxNum + 1));
                anzanVisualState.questions.push(num);
            }

            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('anzanVisualGameScreen').classList.add('active');

            console.log('Game screen activated, showing first question');
            showAnzanVisualQuestion();
        }

        function showAnzanVisualQuestion() {
            if (anzanVisualState.currentQuestion >= anzanVisualSettings.questionCount) {
                endAnzanVisualGame();
                return;
            }

            if (anzanVisualSettings.mode === 'flashLeicht') {
                // Mode 1: Flash Leicht - Show Abacus, hide, choose number
                const correctAnswer = anzanVisualState.questions[anzanVisualState.currentQuestion];
                anzanVisualState.correctAnswer = correctAnswer;
                showAnzanVisualFlash(correctAnswer);
            } else if (anzanVisualSettings.mode === 'flashAddition') {
                // Mode 2: Flash Addition - Show multiple abacuses, calculate sum
                showAnzanVisualAddition();
            }
        }

        function drawAnzanVisualSoroban(number) {
            console.log('drawAnzanVisualSoroban called with:', number);
            const display = document.getElementById('anzanVisualDisplay');
            console.log('Display element:', display);
            
            const digitCount = anzanVisualSettings.digits;
            const numStr = number.toString().padStart(digitCount, '0');
            const digits = numStr.split('').map(d => parseInt(d));
            
            console.log('Drawing digits:', digits);

            let html = '<div class="soroban-frame"><div class="soroban-rods">';

            digits.forEach((digit) => {
                html += `<div class="soroban-rod">`;
                html += `<div class="soroban-column"></div>`;
                html += `<div class="soroban-heaven">`;
                if (digit >= 5) {
                    html += `<div class="soroban-bead active"></div>`;
                }
                html += `</div>`;
                html += `<div class="soroban-divider"></div>`;
                html += `<div class="soroban-earth">`;
                const activeCount = digit % 5;
                for (let i = 0; i < activeCount; i++) {
                    html += `<div class="soroban-bead active"></div>`;
                }
                html += `</div></div>`;
            });

            html += '</div></div>';
            display.innerHTML = html;
            console.log('Abacus HTML set, length:', html.length);
        }

        function drawAnzanVisualNumber(number) {
            const display = document.getElementById('anzanVisualDisplay');
            display.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; min-height: 300px;">
                    <div style="font-size: 10em; font-weight: bold; color: #FFFFFF;">${number}</div>
                </div>
            `;
        }

        function generateAnzanVisualNumberOptions(correctAnswer) {
            const options = [correctAnswer];
            const maxNum = Math.pow(10, anzanVisualSettings.digits) - 1;
            
            while (options.length < 3) {
                let wrongAnswer;
                const offset = Math.floor(Math.random() * 5) + 1;
                const direction = Math.random() < 0.5 ? -1 : 1;
                wrongAnswer = correctAnswer + (offset * direction);
                
                if (wrongAnswer < 0) wrongAnswer = Math.abs(wrongAnswer);
                if (wrongAnswer > maxNum) wrongAnswer = maxNum - offset;
                
                if (!options.includes(wrongAnswer) && wrongAnswer >= 0 && wrongAnswer <= maxNum) {
                    options.push(wrongAnswer);
                }
            }

            options.sort(() => Math.random() - 0.5);

            const container = document.getElementById('anzanVisualOptions');
            container.innerHTML = '';
            container.style.display = 'grid';
            container.style.gridTemplateColumns = 'repeat(3, 1fr)';
            
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'flashcard-option';
                btn.textContent = option;
                btn.onclick = () => checkAnzanVisualAnswer(option);
                container.appendChild(btn);
            });
        }

        function generateAnzanVisualAbacusOptions(correctAnswer) {
            const options = [correctAnswer];
            const maxNum = Math.pow(10, anzanVisualSettings.digits) - 1;
            
            while (options.length < 3) {
                let wrongAnswer;
                const offset = Math.floor(Math.random() * 5) + 1;
                const direction = Math.random() < 0.5 ? -1 : 1;
                wrongAnswer = correctAnswer + (offset * direction);
                
                if (wrongAnswer < 0) wrongAnswer = Math.abs(wrongAnswer);
                if (wrongAnswer > maxNum) wrongAnswer = maxNum - offset;
                
                if (!options.includes(wrongAnswer) && wrongAnswer >= 0 && wrongAnswer <= maxNum) {
                    options.push(wrongAnswer);
                }
            }

            options.sort(() => Math.random() - 0.5);

            const container = document.getElementById('anzanVisualOptions');
            container.innerHTML = '';
            container.style.display = 'grid';
            container.style.gridTemplateColumns = 'repeat(3, 1fr)';
            container.style.gap = '15px';
            
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'flashcard-option';
                btn.style.padding = '10px';
                btn.style.minHeight = '150px';
                btn.dataset.value = option; // Store value in data attribute
                btn.innerHTML = drawMiniAnzanVisualSoroban(option);
                btn.onclick = () => checkAnzanVisualAnswer(option);
                container.appendChild(btn);
            });
        }

        function drawMiniAnzanVisualSoroban(number) {
            const digitCount = anzanVisualSettings.digits;
            const numStr = number.toString().padStart(digitCount, '0');
            const digits = numStr.split('').map(d => parseInt(d));

            let html = '<div style="display: flex; justify-content: center; gap: 8px;">';

            digits.forEach((digit) => {
                html += `<div style="display: flex; flex-direction: column; align-items: center; width: 25px;">`;
                html += `<div style="width: 3px; height: 80px; background: #5DADE2; position: relative;">`;
                
                if (digit >= 5) {
                    html += `<div style="position: absolute; bottom: 38px; left: -6px; width: 15px; height: 8px; background: linear-gradient(145deg, #FFD700, #FFA500); border-radius: 50%;"></div>`;
                }
                
                html += `<div style="position: absolute; top: 40px; left: -6px; right: -6px; height: 2px; background: #5DADE2;"></div>`;
                
                const activeCount = digit % 5;
                for (let i = 0; i < activeCount; i++) {
                    html += `<div style="position: absolute; top: ${42 + i * 10}px; left: -6px; width: 15px; height: 8px; background: linear-gradient(145deg, #FFD700, #FFA500); border-radius: 50%;"></div>`;
                }
                
                html += `</div></div>`;
            });

            html += '</div>';
            return html;
        }

        function showAnzanVisualFlash(correctAnswer) {
            const display = document.getElementById('anzanVisualDisplay');
            const optionsContainer = document.getElementById('anzanVisualOptions');
            
            optionsContainer.innerHTML = '';
            drawAnzanVisualSoroban(correctAnswer);
            
            setTimeout(() => {
                display.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 300px;">
                        <div style="font-size: 3em; color: rgba(255,255,255,0.3);">❓</div>
                    </div>
                `;
                
                generateAnzanVisualNumberOptions(correctAnswer);
            }, anzanVisualSettings.displayTime * 1000);
        }

        function showAnzanVisualAddition() {
            console.log('showAnzanVisualAddition called');
            const display = document.getElementById('anzanVisualDisplay');
            const optionsContainer = document.getElementById('anzanVisualOptions');
            const gameScreen = document.getElementById('anzanVisualGameScreen');
            
            console.log('Elements:', {display, optionsContainer, gameScreen});
            
            optionsContainer.innerHTML = '';
            const progressBoxes = document.getElementById('anzanVisualProgressBoxes');
            progressBoxes.style.display = 'none';
            
            const maxNum = Math.pow(10, anzanVisualSettings.digits) - 1;
            const numbers = [];
            let sum = 0;
            
            for (let i = 0; i < anzanVisualSettings.abacusCount; i++) {
                const num = Math.floor(Math.random() * (maxNum + 1));
                numbers.push(num);
                sum += num;
            }
            
            console.log('Numbers to add:', numbers, 'Sum:', sum);
            
            anzanVisualState.correctAnswer = sum;
            
            gameScreen.innerHTML += `
                <div id="anzanVisualCountdown" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999;">
                    <div id="anzanVisualCountdownCircle" style="width: 200px; height: 200px; border-radius: 50%; background: linear-gradient(145deg, #4CAF50, #45a049); display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(76, 175, 80, 0.5); margin-bottom: 30px;">
                        <span id="anzanVisualCountdownNumber" style="font-size: 5em; font-weight: bold; color: white;">3</span>
                    </div>
                    <div style="font-size: 2em; color: white; font-weight: bold;">Bereit machen!</div>
                </div>
            `;
            
            console.log('Countdown added, starting interval');
            
            let countdown = 3;
            const countdownInterval = setInterval(() => {
                try {
                    playBeep();
                } catch(e) {
                    console.log('Beep error:', e);
                }
                countdown--;
                if (countdown > 0) {
                    const countdownNum = document.getElementById('anzanVisualCountdownNumber');
                    if (countdownNum) countdownNum.textContent = countdown;
                } else {
                    const countdownNum = document.getElementById('anzanVisualCountdownNumber');
                    if (countdownNum) {
                        countdownNum.textContent = 'LOS!';
                        countdownNum.style.fontSize = '3.5em';
                    }
                    clearInterval(countdownInterval);
                    
                    setTimeout(() => {
                        const countdownEl = document.getElementById('anzanVisualCountdown');
                        if (countdownEl) countdownEl.remove();
                        progressBoxes.style.display = 'flex';
                        showAnzanVisualSequence(numbers, 0);
                    }, 1000);
                }
            }, 1000);
        }

        function showAnzanVisualSequence(numbers, index) {
            const display = document.getElementById('anzanVisualDisplay');
            const optionsContainer = document.getElementById('anzanVisualOptions');
            
            if (index >= numbers.length) {
                display.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 300px;">
                        <div style="font-size: 4em; font-weight: bold; color: #FFFFFF;">ERGEBNIS?</div>
                    </div>
                `;
                
                generateAnzanVisualNumberOptions(anzanVisualState.correctAnswer);
                return;
            }
            
            drawAnzanVisualSoroban(numbers[index]);
            try {
                playBeep();
            } catch(e) {
                console.log('Beep error:', e);
            }
            
            setTimeout(() => {
                display.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 300px; background: #000;">
                    </div>
                `;
                
                setTimeout(() => {
                    showAnzanVisualSequence(numbers, index + 1);
                }, 500);
            }, anzanVisualSettings.displayTime * 1000);
        }

        function checkAnzanVisualAnswer(selectedAnswer) {
            const isCorrect = selectedAnswer === anzanVisualState.correctAnswer;
            
            const boxes = document.querySelectorAll('#anzanVisualProgressBoxes .progress-box');
            const currentBox = boxes[anzanVisualState.currentQuestion];
            if (currentBox) {
                currentBox.classList.add(isCorrect ? 'correct' : 'wrong');
            }
            
            const buttons = document.querySelectorAll('#anzanVisualOptions .flashcard-option');
            buttons.forEach(btn => {
                btn.disabled = true;
                const value = btn.dataset.value ? parseInt(btn.dataset.value) : parseInt(btn.textContent);
                if (value === anzanVisualState.correctAnswer) {
                    btn.classList.add('correct');
                } else if (value === selectedAnswer && !isCorrect) {
                    btn.classList.add('wrong');
                }
            });

            if (isCorrect) {
                anzanVisualState.score++;
                playBeep();
                
                if (anzanVisualSettings.mode === 'flashAddition') {
                    createConfetti();
                    playApplause();
                }
            }

            setTimeout(() => {
                anzanVisualState.currentQuestion++;
                showAnzanVisualQuestion();
            }, 1500);
        }

        function endAnzanVisualGame() {
            const percentage = Math.round((anzanVisualState.score / anzanVisualSettings.questionCount) * 100);
            
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('resultScreen').classList.add('active');
            
            document.getElementById('resultTitle').textContent = 'Anzan Visual Training';
            document.getElementById('resultScore').textContent = `${anzanVisualState.score} / ${anzanVisualSettings.questionCount}`;
            document.getElementById('resultPercentage').textContent = `${percentage}%`;
            
            if (percentage === 100) {
                createConfetti();
                playApplause();
            }
        }

        function selectFlashcardMode(mode, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            flashcardSettings.mode = mode;
        }

        function selectFlashcardSpeed(seconds, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            flashcardSettings.displayTime = seconds;
        }

        function selectFlashcardCount(count, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            flashcardSettings.abacusCount = count;
        }

        function selectDisplayTime(seconds, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            flashcardSettings.displayTime = seconds;
        }

        function selectAbacusCount(count, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            flashcardSettings.abacusCount = count;
        }

        function selectFlashcardDigits(digits, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            flashcardSettings.digits = digits;
        }

        function startFlashcardGame() {
            // Reset state
            flashcardState = {
                currentQuestion: 0,
                score: 0,
                correctAnswer: 0,
                questions: []
            };

            // Reset progress boxes
            const boxes = document.querySelectorAll('#flashcardProgressBoxes .progress-box');
            boxes.forEach(box => {
                box.classList.remove('correct', 'wrong');
            });

            // Calculate max number based on digits
            const maxNum = Math.pow(10, flashcardSettings.digits) - 1;

            // Generate questions
            for (let i = 0; i < flashcardSettings.questionCount; i++) {
                const num = Math.floor(Math.random() * (maxNum + 1));
                flashcardState.questions.push(num);
            }

            // Show game screen
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('flashcardGameScreen').classList.add('active');

            // Show first question
            showFlashcardQuestion();
        }

        function showFlashcardQuestion() {
            if (flashcardState.currentQuestion >= flashcardSettings.questionCount) {
                endFlashcardGame();
                return;
            }

            if (flashcardSettings.mode === 'abacusToNumber') {
                // Mode 1: Show Abacus, choose number
                const correctAnswer = flashcardState.questions[flashcardState.currentQuestion];
                flashcardState.correctAnswer = correctAnswer;
                drawSoroban(correctAnswer);
                generateFlashcardOptions(correctAnswer);
            } else if (flashcardSettings.mode === 'numberToAbacus') {
                // Mode 2: Show number, choose Abacus
                const correctAnswer = flashcardState.questions[flashcardState.currentQuestion];
                flashcardState.correctAnswer = correctAnswer;
                drawNumberDisplay(correctAnswer);
                generateAbacusOptions(correctAnswer);
            } else if (flashcardSettings.mode === 'flashLeicht') {
                // Mode 3: Flash Leicht - show briefly then hide
                const correctAnswer = flashcardState.questions[flashcardState.currentQuestion];
                flashcardState.correctAnswer = correctAnswer;
                showFlashLeicht(correctAnswer);
            } else if (flashcardSettings.mode === 'flashAddition') {
                // Mode 4: Flash Addition - show multiple, calculate sum
                showFlashAddition();
            }
        }

        function showAbacusAnzan(correctAnswer) {
            const display = document.getElementById('sorobanDisplay');
            const optionsContainer = document.getElementById('flashcardOptions');
            const gameScreen = document.getElementById('flashcardGameScreen');
            
            // Hide options and progress boxes
            optionsContainer.innerHTML = '';
            const progressBoxes = document.getElementById('flashcardProgressBoxes');
            progressBoxes.style.display = 'none';
            
            // Generate random numbers to add
            const maxNum = Math.pow(10, flashcardSettings.digits) - 1;
            const numbers = [];
            let sum = 0;
            
            for (let i = 0; i < flashcardSettings.abacusCount; i++) {
                const num = Math.floor(Math.random() * (maxNum + 1));
                numbers.push(num);
                sum += num;
            }
            
            // Store the correct answer (sum)
            flashcardState.correctAnswer = sum;
            
            // Show countdown overlay
            gameScreen.innerHTML += `
                <div id="anzanCountdown" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999;">
                    <div id="countdownCircle" style="width: 200px; height: 200px; border-radius: 50%; background: linear-gradient(145deg, #4CAF50, #45a049); display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(76, 175, 80, 0.5); margin-bottom: 30px;">
                        <span id="countdownNumber" style="font-size: 5em; font-weight: bold; color: white;">3</span>
                    </div>
                    <div style="font-size: 2em; color: white; font-weight: bold;">Bereit machen!</div>
                </div>
            `;
            
            // Countdown: 3, 2, 1, LOS!
            let countdown = 3;
            const countdownInterval = setInterval(() => {
                playBeep();
                countdown--;
                if (countdown > 0) {
                    document.getElementById('countdownNumber').textContent = countdown;
                } else {
                    document.getElementById('countdownNumber').textContent = 'LOS!';
                    document.getElementById('countdownNumber').style.fontSize = '3.5em';
                    clearInterval(countdownInterval);
                    
                    // Start showing abacuses after 1 second
                    setTimeout(() => {
                        document.getElementById('anzanCountdown').remove();
                        progressBoxes.style.display = 'flex';
                        showAbacusSequence(numbers, 0);
                    }, 1000);
                }
            }, 1000);
        }
        
        function showAbacusSequence(numbers, index) {
            const display = document.getElementById('sorobanDisplay');
            const optionsContainer = document.getElementById('flashcardOptions');
            
            if (index >= numbers.length) {
                // All abacuses shown, now show "Ergebnis?" and options
                display.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 300px;">
                        <div style="font-size: 4em; font-weight: bold; color: #FFFFFF;">ERGEBNIS?</div>
                    </div>
                `;
                
                // Show answer options
                generateFlashcardOptions(flashcardState.correctAnswer);
                return;
            }
            
            // Show current abacus
            drawSoroban(numbers[index]);
            playBeep();
            
            // Wait for display time
            setTimeout(() => {
                // Black screen
                display.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 300px; background: #000;">
                    </div>
                `;
                
                // Wait 500ms, then show next
                setTimeout(() => {
                    showAbacusSequence(numbers, index + 1);
                }, 500);
            }, flashcardSettings.displayTime * 1000);
        }

        function drawSoroban(number) {
            const display = document.getElementById('sorobanDisplay');
            
            // Get number of digits from settings
            const digitCount = flashcardSettings.digits;
            
            // Pad number with leading zeros
            const numStr = number.toString().padStart(digitCount, '0');
            const digits = numStr.split('').map(d => parseInt(d));

            let html = '<div class="soroban-frame"><div class="soroban-rods">';

            // Draw a rod for each digit
            digits.forEach((digit, index) => {
                html += `<div class="soroban-rod">`;
                html += `<div class="soroban-column"></div>`;
                
                // Heaven bead (5-value) - ONLY show if digit >= 5
                html += `<div class="soroban-heaven">`;
                if (digit >= 5) {
                    html += `<div class="soroban-bead active"></div>`;
                }
                html += `</div>`;
                
                html += `<div class="soroban-divider"></div>`;
                
                // Earth beads (1-value each) - ONLY show active beads
                html += `<div class="soroban-earth">`;
                const activeCount = digit % 5;
                
                // Only show the active beads (digit % 5)
                for (let i = 0; i < activeCount; i++) {
                    html += `<div class="soroban-bead active"></div>`;
                }
                
                html += `</div>`;
                html += `</div>`;
            });

            html += '</div></div>';
            
            display.innerHTML = html;
        }

        function generateFlashcardOptions(correctAnswer) {
            const options = [correctAnswer];
            
            // Calculate max number based on digits
            const maxNum = Math.pow(10, flashcardSettings.digits) - 1;
            
            // Generate 2 wrong answers
            while (options.length < 3) {
                let wrongAnswer;
                
                // Generate plausible wrong answers (close to correct)
                const offset = Math.floor(Math.random() * 5) + 1;
                const direction = Math.random() < 0.5 ? -1 : 1;
                wrongAnswer = correctAnswer + (offset * direction);
                
                // Keep within range
                if (wrongAnswer < 0) wrongAnswer = Math.abs(wrongAnswer);
                if (wrongAnswer > maxNum) wrongAnswer = maxNum - offset;
                
                // Avoid duplicates
                if (!options.includes(wrongAnswer) && wrongAnswer >= 0 && wrongAnswer <= maxNum) {
                    options.push(wrongAnswer);
                }
            }

            // Shuffle options
            options.sort(() => Math.random() - 0.5);

            // Create buttons
            const container = document.getElementById('flashcardOptions');
            container.innerHTML = '';
            
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'flashcard-option';
                btn.textContent = option;
                btn.onclick = () => checkFlashcardAnswer(option);
                container.appendChild(btn);
            });
        }

        function checkFlashcardAnswer(selectedAnswer) {
            const isCorrect = selectedAnswer === flashcardState.correctAnswer;
            
            // Update progress box
            const boxes = document.querySelectorAll('.progress-box');
            const currentBox = boxes[flashcardState.currentQuestion];
            if (currentBox) {
                currentBox.classList.add(isCorrect ? 'correct' : 'wrong');
            }
            
            // Disable all buttons
            const buttons = document.querySelectorAll('.flashcard-option');
            buttons.forEach(btn => {
                btn.disabled = true;
                const value = btn.dataset.value ? parseInt(btn.dataset.value) : parseInt(btn.textContent);
                if (value === flashcardState.correctAnswer) {
                    btn.classList.add('correct');
                } else if (value === selectedAnswer && !isCorrect) {
                    btn.classList.add('wrong');
                }
            });

            if (isCorrect) {
                flashcardState.score++;
                playBeep();
                
                // Konfeti ve alkış (sadece Anzan modunda)
                if (flashcardSettings.mode === 'abacusAnzan') {
                    createConfetti();
                    playApplause();
                }
            }

            // Next question after delay
            setTimeout(() => {
                flashcardState.currentQuestion++;
                showFlashcardQuestion();
            }, 1500);
        }

        function drawNumberDisplay(number) {
            const display = document.getElementById('sorobanDisplay');
            display.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; min-height: 300px;">
                    <div style="font-size: 10em; font-weight: bold; color: #FFFFFF;">${number}</div>
                </div>
            `;
        }

        function generateAbacusOptions(correctAnswer) {
            const options = [correctAnswer];
            const maxNum = Math.pow(10, flashcardSettings.digits) - 1;
            
            // Generate 2 wrong answers
            while (options.length < 3) {
                let wrongAnswer;
                const offset = Math.floor(Math.random() * 5) + 1;
                const direction = Math.random() < 0.5 ? -1 : 1;
                wrongAnswer = correctAnswer + (offset * direction);
                
                if (wrongAnswer < 0) wrongAnswer = Math.abs(wrongAnswer);
                if (wrongAnswer > maxNum) wrongAnswer = maxNum - offset;
                
                if (!options.includes(wrongAnswer) && wrongAnswer >= 0 && wrongAnswer <= maxNum) {
                    options.push(wrongAnswer);
                }
            }

            // Shuffle options
            options.sort(() => Math.random() - 0.5);

            // Create mini Abacus buttons
            const container = document.getElementById('flashcardOptions');
            container.innerHTML = '';
            container.style.display = 'grid';
            container.style.gridTemplateColumns = 'repeat(3, 1fr)';
            container.style.gap = '15px';
            
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'flashcard-option';
                btn.style.padding = '10px';
                btn.style.minHeight = '150px';
                btn.dataset.value = option; // Store value in data attribute
                btn.innerHTML = drawMiniSoroban(option);
                btn.onclick = () => checkFlashcardAnswer(option);
                container.appendChild(btn);
            });
        }

        function drawMiniSoroban(number) {
            const digitCount = flashcardSettings.digits;
            const numStr = number.toString().padStart(digitCount, '0');
            const digits = numStr.split('').map(d => parseInt(d));

            let html = '<div style="display: flex; justify-content: center; gap: 8px;">';

            digits.forEach((digit) => {
                html += `<div style="display: flex; flex-direction: column; align-items: center; width: 25px;">`;
                html += `<div style="width: 3px; height: 80px; background: #5DADE2; position: relative;">`;
                
                // Heaven bead
                if (digit >= 5) {
                    html += `<div style="position: absolute; bottom: 38px; left: -6px; width: 15px; height: 8px; background: linear-gradient(145deg, #FFD700, #FFA500); border-radius: 50%;"></div>`;
                }
                
                // Divider
                html += `<div style="position: absolute; top: 40px; left: -6px; right: -6px; height: 2px; background: #5DADE2;"></div>`;
                
                // Earth beads
                const activeCount = digit % 5;
                for (let i = 0; i < activeCount; i++) {
                    html += `<div style="position: absolute; top: ${42 + i * 10}px; left: -6px; width: 15px; height: 8px; background: linear-gradient(145deg, #FFD700, #FFA500); border-radius: 50%;"></div>`;
                }
                
                html += `</div></div>`;
            });

            html += '</div>';
            return html;
        }

        function showFlashLeicht(correctAnswer) {
            const display = document.getElementById('sorobanDisplay');
            const optionsContainer = document.getElementById('flashcardOptions');
            
            // Show Abacus
            optionsContainer.innerHTML = '';
            drawSoroban(correctAnswer);
            
            // Hide after displayTime seconds
            setTimeout(() => {
                display.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 300px;">
                        <div style="font-size: 3em; color: rgba(255,255,255,0.3);">❓</div>
                    </div>
                `;
                generateFlashcardOptions(correctAnswer);
            }, flashcardSettings.displayTime * 1000);
        }

        function showFlashAddition() {
            const display = document.getElementById('sorobanDisplay');
            const optionsContainer = document.getElementById('flashcardOptions');
            
            optionsContainer.innerHTML = '';
            
            // Generate numbers based on abacusCount
            const maxNum = Math.pow(10, flashcardSettings.digits) - 1;
            const numbers = [];
            let sum = 0;
            
            for (let i = 0; i < flashcardSettings.abacusCount; i++) {
                const num = Math.floor(Math.random() * (maxNum + 1));
                numbers.push(num);
                sum += num;
            }
            
            flashcardState.correctAnswer = sum;
            
            // Show sequence
            showFlashSequence(numbers, 0);
        }

        function showFlashSequence(numbers, index) {
            const display = document.getElementById('sorobanDisplay');
            
            if (index >= numbers.length) {
                // All shown, ask for result
                display.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; min-height: 300px;">
                        <div style="font-size: 4em; font-weight: bold; color: #FFFFFF;">ERGEBNIS?</div>
                    </div>
                `;
                generateFlashcardOptions(flashcardState.correctAnswer);
                return;
            }
            
            // Fade out - completely hide the card
            display.style.opacity = '0';
            display.style.transition = 'opacity 0.15s ease-out';
            
            setTimeout(() => {
                // Change the content while invisible
                drawSoroban(numbers[index]);
                playBeep();
                
                // Fade in - show the new card
                display.style.opacity = '1';
                display.style.transition = 'opacity 0.15s ease-in';
                
                // Wait based on selected display time, then show next card
                setTimeout(() => {
                    showFlashSequence(numbers, index + 1);
                }, flashcardSettings.displayTime * 1000);
            }, 150);
        }

        function endFlashcardGame() {
            showScreen('resultScreen');
            
            const percentage = Math.round((flashcardState.score / flashcardSettings.questionCount) * 100);
            
            // Motivierende Nachrichten basierend auf Erfolgsquote
            const resultMessage = document.getElementById('resultMessage');
            
            if (percentage === 100) {
                const perfectMessages = [
                    '🎉 SUPER! 🎉',
                    '⭐ TOLL! ⭐',
                    '🏆 FANTASTISCH! 🏆',
                    '🌟 PERFEKT! 🌟',
                    '💪 STARK! 💪',
                    '🎊 SPITZE! 🎊',
                    '✨ WUNDERBAR! ✨',
                    '🚀 HAMMER! 🚀'
                ];
                resultMessage.textContent = perfectMessages[Math.floor(Math.random() * perfectMessages.length)];
                resultMessage.className = 'result-message correct';
                playSuccessSound();
                createConfetti();
            } else if (percentage >= 75) {
                const goodMessages = [
                    '👏 SEHR GUT! 👏',
                    '🌟 TOLL GEMACHT! 🌟',
                    '💪 SUPER LEISTUNG! 💪',
                    '🎯 FAST PERFEKT! 🎯'
                ];
                resultMessage.textContent = goodMessages[Math.floor(Math.random() * goodMessages.length)];
                resultMessage.className = 'result-message correct';
            } else if (percentage >= 50) {
                const okMessages = [
                    '👍 GUT GEMACHT! 👍',
                    '💫 WEITER SO! 💫',
                    '🌈 DU BIST AUF DEM WEG! 🌈',
                    '⭐ SCHÖN! ⭐'
                ];
                resultMessage.textContent = okMessages[Math.floor(Math.random() * okMessages.length)];
                resultMessage.className = 'result-message correct';
            } else {
                const encourageMessages = [
                    '💪 Weiter üben!',
                    '🌈 Nächstes Mal!',
                    '⭐ Fast geschafft!',
                    '🎯 Probier nochmal!',
                    '💫 Du schaffst das!',
                    '🚀 Nicht aufgeben!'
                ];
                resultMessage.textContent = encourageMessages[Math.floor(Math.random() * encourageMessages.length)];
                resultMessage.className = 'result-message wrong';
            }
            
            document.getElementById('questionText').textContent = 
                `Du hast ${flashcardState.score} von ${flashcardSettings.questionCount} Fragen richtig beantwortet!`;
            document.getElementById('correctAnswer').textContent = `Erfolgsquote: ${percentage}%`;
            document.getElementById('userAnswer').textContent = '';
        }




        function startGame() {
            // Check if Tandem mode
            if (currentGameMode === 'tandem') {
                startTandemGame();
                return;
            }
            
            // Only generate random numbers if not custom task
            if (!isCustomTask) {
                // Generate numbers - ensure no consecutive duplicates
                currentNumbers = [];
                const [min, max] = settings.zahlenbereich;
                
                if (settings.rechenart === 'addition') {
                    // Addition: generate random numbers
                    for (let i = 0; i < settings.anzahl; i++) {
                        let num;
                        do {
                            num = Math.floor(Math.random() * (max - min + 1)) + min;
                        } while (i > 0 && num === currentNumbers[i - 1]);
                        
                        currentNumbers.push(num);
                    }
                    
                    correctAnswer = currentNumbers.reduce((sum, num) => sum + num, 0);
                    
                } else if (settings.rechenart === 'subtraktion') {
                    // Subtraction: ensure result is always positive and at least one minus sign
                    
                    // Start with a larger number to ensure positive result
                    const maxPossibleSum = (settings.anzahl - 1) * max;
                    const safeMax = Math.min(max, maxPossibleSum + max);
                    const firstNumber = Math.floor(Math.random() * (safeMax - max + 1)) + max;
                    currentNumbers.push(firstNumber);
                    
                    let runningTotal = firstNumber;
                    
                    // Generate remaining numbers ensuring result stays positive
                    for (let i = 1; i < settings.anzahl; i++) {
                        let num;
                        // Make sure we can subtract this number and still have room for more subtractions
                        const remainingNumbers = settings.anzahl - i - 1;
                        const minNeeded = remainingNumbers * min; // Minimum we might need to subtract later
                        const maxCanSubtract = runningTotal - minNeeded;
                        
                        if (maxCanSubtract < min) {
                            // If we can't subtract safely, use a small number
                            num = min;
                        } else {
                            const safeMaxForThis = Math.min(max, maxCanSubtract);
                            do {
                                num = Math.floor(Math.random() * (safeMaxForThis - min + 1)) + min;
                            } while (num === currentNumbers[i - 1]);
                        }
                        
                        currentNumbers.push(num);
                        runningTotal -= num;
                    }
                    
                    // Calculate correct answer (should always be >= 0)
                    correctAnswer = currentNumbers[0];
                    for (let i = 1; i < currentNumbers.length; i++) {
                        correctAnswer -= currentNumbers[i];
                    }
                    
                    // Safety check - if somehow negative, regenerate
                    if (correctAnswer < 0) {
                        return startGame(); // Regenerate
                    }
                    
                } else if (settings.rechenart === 'multiplikation') {
                    // Multiplication: generate based on level
                    const level = settings.multiplicationLevel;
                    const digitRange = settings.digitRange;
                    
                    let num1, num2;
                    
                    switch(level) {
                        case 1: // 1 × 5 (single × single)
                            num1 = generateNumberWithDigits(1, digitRange);
                            num2 = generateNumberWithDigits(1, digitRange);
                            break;
                        case 11: // 1 × 9 (single × single, full range)
                            num1 = generateNumberWithDigits(1, digitRange);
                            num2 = generateNumberWithDigits(1, digitRange);
                            break;
                        case 2: // 35 × 2 (two digit × single)
                            num1 = generateNumberWithDigits(2, digitRange);
                            num2 = generateNumberWithDigits(1, digitRange);
                            break;
                        case 3: // 452 × 4 (three digit × single)
                            num1 = generateNumberWithDigits(3, digitRange);
                            num2 = generateNumberWithDigits(1, digitRange);
                            break;
                        case 4: // 4524 × 4 (four digit × single)
                            num1 = generateNumberWithDigits(4, digitRange);
                            num2 = generateNumberWithDigits(1, digitRange);
                            break;
                        case 5: // 34 × 23 (two digit × two digit)
                            num1 = generateNumberWithDigits(2, digitRange);
                            num2 = generateNumberWithDigits(2, digitRange);
                            break;
                        case 6: // 234 × 42 (three digit × two digit)
                            num1 = generateNumberWithDigits(3, digitRange);
                            num2 = generateNumberWithDigits(2, digitRange);
                            break;
                        case 7: // 89 × 7 (two digit × single, harder)
                            num1 = generateNumberWithDigits(2, digitRange);
                            num2 = generateNumberWithDigits(1, digitRange);
                            break;
                        case 9: // 149 × 9 (three digit × single, hardest)
                            num1 = generateNumberWithDigits(3, digitRange);
                            num2 = generateNumberWithDigits(1, digitRange);
                            break;
                        case 10: // 56 × 78 (two digit × two digit, hardest)
                            num1 = generateNumberWithDigits(2, digitRange);
                            num2 = generateNumberWithDigits(2, digitRange);
                            break;
                    }
                    
                    currentNumbers = [num1, num2];
                    correctAnswer = num1 * num2;
                    
                } else if (settings.rechenart === 'division') {
                    // Division: generate result first, then multiply to get dividend
                    const level = settings.divisionLevel;
                    const digitRange = settings.digitRangeDiv;
                    
                    let result, divisor, dividend;
                    
                    switch(level) {
                        case 1: // 10 ÷ 5 (single ÷ single)
                            result = generateNumberWithDigits(1, digitRange);
                            divisor = generateNumberWithDigits(1, digitRange);
                            break;
                        case 2: // 45 ÷ 9 (two ÷ single)
                            result = generateNumberWithDigits(1, digitRange);
                            divisor = generateNumberWithDigits(1, digitRange);
                            break;
                        case 3: // 70 ÷ 2 (two ÷ single)
                            result = generateNumberWithDigits(2, digitRange);
                            divisor = generateNumberWithDigits(1, digitRange);
                            break;
                        case 4: // 452 ÷ 4 (three ÷ single)
                            result = generateNumberWithDigits(3, digitRange);
                            divisor = generateNumberWithDigits(1, digitRange);
                            break;
                        case 5: // 4524 ÷ 4 (four ÷ single)
                            result = generateNumberWithDigits(4, digitRange);
                            divisor = generateNumberWithDigits(1, digitRange);
                            break;
                        case 6: // 45234 ÷ 5 (five ÷ single)
                            result = generateNumberWithDigits(5, digitRange);
                            divisor = generateNumberWithDigits(1, digitRange);
                            break;
                        case 7: // 451234 ÷ 4 (six ÷ single)
                            result = generateNumberWithDigits(6, digitRange);
                            divisor = generateNumberWithDigits(1, digitRange);
                            break;
                        case 8: // 455 ÷ 13 (three ÷ two)
                            result = generateNumberWithDigits(2, digitRange);
                            divisor = generateNumberWithDigits(2, digitRange);
                            break;
                        case 9: // 5684 ÷ 17 (four ÷ two)
                            result = generateNumberWithDigits(3, digitRange);
                            divisor = generateNumberWithDigits(2, digitRange);
                            break;
                        case 10: // 8856 ÷ 123 (four ÷ three)
                            result = generateNumberWithDigits(2, digitRange);
                            divisor = generateNumberWithDigits(3, digitRange);
                            break;
                    }
                    
                    // Calculate dividend to ensure exact division
                    dividend = result * divisor;
                    
                    currentNumbers = [dividend, divisor];
                    correctAnswer = result;
                }
            }

            // Reset custom task flag after using
            isCustomTask = false;

            // Reset user answer
            userAnswerString = '';

            // Start countdown
            startCountdown();
        }

        function startCountdown() {
            // Show countdown screen
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('countdownScreen').classList.add('active');

            const countdownProgress = document.getElementById('countdownProgress');
            const countdownLogo = document.getElementById('countdownLogo');
            const countdownLos = document.getElementById('countdownLos');
            
            // Reset states
            countdownLogo.classList.remove('hide');
            countdownLogo.style.display = 'block';
            countdownLos.style.display = 'none';
            
            // Reset progress
            countdownProgress.style.strokeDashoffset = '565.5';
            
            // Animate with requestAnimationFrame for smooth performance
            const duration = 3000; // 3 seconds
            const start = performance.now();
            const startOffset = 565.5;
            
            function animate(currentTime) {
                const elapsed = currentTime - start;
                const progress = Math.min(elapsed / duration, 1);
                
                // Ease-in-out function
                const easeProgress = progress < 0.5
                    ? 2 * progress * progress
                    : 1 - Math.pow(-2 * progress + 2, 2) / 2;
                
                const currentOffset = startOffset - (startOffset * easeProgress);
                countdownProgress.style.strokeDashoffset = currentOffset;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    // Animation complete - show LOS
                    countdownLogo.classList.add('hide');
                    setTimeout(() => {
                        countdownLogo.style.display = 'none';
                        countdownLos.style.display = 'block';
                    }, 300);
                    
                    // Start game after 1.5 seconds (LOS stays longer)
                    setTimeout(() => {
                        showGameScreen();
                    }, 1500);
                }
            }
            
            requestAnimationFrame(animate);
        }

        function showGameScreen() {
            // Show game screen
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('gameScreen').classList.add('active');
            document.getElementById('answerSection').style.display = 'none';
            updateAnswerDisplay();

            // Display numbers sequentially
            displayNumbers();
        }

        function displayNumbers() {
            const display = document.getElementById('numberDisplay');
            let index = 0;
            
            // Multiplication: show all at once, no animation
            if (settings.rechenart === 'multiplikation') {
                display.style.fontSize = '6em'; // Smaller for multiplication
                display.textContent = `${currentNumbers[0]} • ${currentNumbers[1]} = `;
                playBeep();
                document.getElementById('answerSection').style.display = 'block';
                return;
            }
            
            // Division: show all at once, no animation
            if (settings.rechenart === 'division') {
                display.style.fontSize = '6em'; // Smaller for division
                display.textContent = `${currentNumbers[0]} : ${currentNumbers[1]} = `;
                playBeep();
                document.getElementById('answerSection').style.display = 'block';
                return;
            }
            
            // Reset font size for addition/subtraction
            display.style.fontSize = '';
            
            // Prepare display elements for addition/subtraction
            const displayElements = [];
            
            if (settings.rechenart === 'addition' || settings.rechenart === 'subtraktion') {
                // For addition: show numbers without + sign
                // For subtraction: show first number without sign, others with - sign
                for (let i = 0; i < currentNumbers.length; i++) {
                    if (i === 0) {
                        // First number without operator
                        displayElements.push(currentNumbers[i].toString());
                    } else {
                        // Subsequent numbers
                        if (settings.rechenart === 'addition') {
                            // Addition: no + sign, just the number
                            displayElements.push(currentNumbers[i].toString());
                        } else {
                            // Subtraction: show with - sign
                            displayElements.push('-' + currentNumbers[i]);
                        }
                    }
                }
            } else if (typeof currentNumbers[0] === 'number' && typeof currentNumbers[1] === 'string') {
                // Mixed operations (from custom tasks)
                for (let i = 0; i < currentNumbers.length; i++) {
                    if (typeof currentNumbers[i] === 'number') {
                        if (i > 0 && typeof currentNumbers[i-1] === 'string') {
                            displayElements.push(currentNumbers[i-1] + currentNumbers[i]);
                        } else if (i === 0 || typeof currentNumbers[i-1] === 'number') {
                            displayElements.push(currentNumbers[i].toString());
                        }
                    }
                }
            } else {
                // Fallback for custom operations
                for (let i = 0; i < currentNumbers.length; i++) {
                    displayElements.push(currentNumbers[i].toString());
                }
            }

            function showNext() {
                if (index < displayElements.length) {
                    // Sesli Anzan Mod 2: Nur Hören - Abakus zeigen statt Zahlen
                    if (currentGameMode === 'sesliAnzan' && sesliAnzanSettings.mode === 'nurHoren') {
                        display.innerHTML = `
                            <div style="display: flex; align-items: center; justify-content: center; animation: soundPulse 0.6s ease-in-out;">
                                <svg width="600" height="280" viewBox="0 0 600 280" style="filter: drop-shadow(0 10px 30px rgba(0,0,0,0.3)); max-width: 90%;">
                                    <!-- Abakus Frame -->
                                    <rect x="20" y="20" width="560" height="240" rx="30" fill="#FF9800" stroke="#F57C00" stroke-width="8"/>
                                    <rect x="35" y="35" width="530" height="210" rx="20" fill="#FFF8E1"/>
                                    
                                    <!-- Horizontal Divider -->
                                    <line x1="35" y1="140" x2="565" y2="140" stroke="#FF9800" stroke-width="6"/>
                                    
                                    <!-- 8 Vertical Rods -->
                                    ${Array.from({length: 8}, (_, i) => {
                                        const x = 80 + i * 60;
                                        return `
                                            <!-- Rod ${i+1} -->
                                            <line x1="${x}" y1="45" x2="${x}" y2="235" stroke="#FF6F00" stroke-width="6"/>
                                            
                                            <!-- Heaven Beads (Green) -->
                                            <ellipse cx="${x}" cy="70" rx="20" ry="12" fill="#4CAF50"/>
                                            <ellipse cx="${x}" cy="70" rx="18" ry="10" fill="#66BB6A"/>
                                            
                                            <!-- Earth Beads (Yellow/Orange) -->
                                            <ellipse cx="${x}" cy="170" rx="18" ry="11" fill="#FFD54F"/>
                                            <ellipse cx="${x}" cy="170" rx="16" ry="9" fill="#FFEB3B"/>
                                            
                                            <ellipse cx="${x}" cy="190" rx="18" ry="11" fill="#FFA726"/>
                                            <ellipse cx="${x}" cy="190" rx="16" ry="9" fill="#FFB74D"/>
                                            
                                            <ellipse cx="${x}" cy="210" rx="18" ry="11" fill="#FFD54F"/>
                                            <ellipse cx="${x}" cy="210" rx="16" ry="9" fill="#FFEB3B"/>
                                            
                                            <ellipse cx="${x}" cy="230" rx="18" ry="11" fill="#FFD54F"/>
                                            <ellipse cx="${x}" cy="230" rx="16" ry="9" fill="#FFEB3B"/>
                                        `;
                                    }).join('')}
                                    
                                    <!-- Divider Dots -->
                                    <circle cx="210" cy="140" r="5" fill="#FF9800"/>
                                    <circle cx="330" cy="140" r="5" fill="#FF9800"/>
                                    <circle cx="510" cy="140" r="5" fill="#FF9800"/>
                                </svg>
                            </div>
                        `;
                    } else {
                        // Normal mode oder Mod 1: Zahlen zeigen
                        display.textContent = displayElements[index];
                    }
                    
                    // Play beep sound AND voice (if Sesli Anzan mode)
                    playBeep();
                    
                    // Sesli Anzan: Speak the number (BOTH Mod 1 and Mod 2)
                    if (currentGameMode === 'sesliAnzan') {
                        speakNumber(currentNumbers[index]);
                    }
                    
                    display.style.animation = 'none';
                    setTimeout(() => {
                        display.style.animation = 'pulse 0.3s ease-in-out';
                    }, 10);
                    index++;
                    setTimeout(showNext, settings.geschwindigkeit);
                } else {
                    // All elements shown, now show input
                    display.textContent = '?';
                    document.getElementById('answerSection').style.display = 'block';
                }
            }

            showNext();
        }

        // Speech synthesis function for Sesli Anzan
        function speakNumber(number) {
            if (!soundEnabled) return;
            
            // Use Web Speech API
            const utterance = new SpeechSynthesisUtterance(number.toString());
            utterance.lang = 'de-DE'; // German
            utterance.rate = 1.0; // Normal speed
            utterance.pitch = 1.0;
            
            window.speechSynthesis.speak(utterance);
        }

        function checkAnswer() {
            const userAnswer = parseInt(userAnswerString) || 0;
            
            // Show result screen
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('resultScreen').classList.add('active');

            // Display result
            const resultMessage = document.getElementById('resultMessage');
            if (userAnswer === correctAnswer) {
                const correctMessages = [
                    '🎉 SUPER! 🎉',
                    '⭐ TOLL! ⭐',
                    '🏆 FANTASTISCH! 🏆',
                    '🌟 PERFEKT! 🌟',
                    '💪 STARK! 💪',
                    '🎊 SPITZE! 🎊',
                    '✨ WUNDERBAR! ✨',
                    '🚀 HAMMER! 🚀'
                ];
                resultMessage.textContent = correctMessages[Math.floor(Math.random() * correctMessages.length)];
                resultMessage.className = 'result-message correct';
                
                // Play success sound and show confetti
                playSuccessSound();
                createConfetti();
            } else {
                const wrongMessages = [
                    '💪 Weiter üben!',
                    '🌈 Nächstes Mal!',
                    '⭐ Fast geschafft!',
                    '🎯 Probier nochmal!',
                    '💫 Du schaffst das!'
                ];
                resultMessage.textContent = wrongMessages[Math.floor(Math.random() * wrongMessages.length)];
                resultMessage.className = 'result-message wrong';
            }

            // Display details
            let questionText = '';
            if (settings.rechenart === 'addition' || settings.rechenart === 'subtraktion') {
                // For addition and subtraction
                questionText = currentNumbers[0].toString();
                for (let i = 1; i < currentNumbers.length; i++) {
                    const operator = settings.rechenart === 'addition' ? ' + ' : ' - ';
                    questionText += operator + currentNumbers[i];
                }
            } else if (settings.rechenart === 'multiplikation') {
                // For multiplication
                questionText = `${currentNumbers[0]} • ${currentNumbers[1]}`;
            } else if (settings.rechenart === 'division') {
                // For division
                questionText = `${currentNumbers[0]} : ${currentNumbers[1]}`;
            } else {
                // For mixed operations
                for (let i = 0; i < currentNumbers.length; i++) {
                    if (typeof currentNumbers[i] === 'number') {
                        questionText += currentNumbers[i];
                    } else {
                        questionText += ' ' + currentNumbers[i] + ' ';
                    }
                }
            }
            document.getElementById('questionText').textContent = questionText;
            document.getElementById('correctAnswer').textContent = correctAnswer;
            document.getElementById('userAnswer').textContent = userAnswer;

            // If playing from queue, update Nochmal button to play next task
            const restartButton = document.querySelector('.restart-button');
            if (selectedTasksQueue.length > 0 && currentTaskIndex < selectedTasksQueue.length) {
                currentTaskIndex++;
                if (currentTaskIndex < selectedTasksQueue.length) {
                    restartButton.textContent = '➡️ Nächste Aufgabe';
                    restartButton.onclick = playNextTaskFromQueue;
                } else {
                    restartButton.textContent = '🔄 Nochmal';
                    restartButton.onclick = startGame;
                    // Clear queue
                    selectedTasksQueue = [];
                    currentTaskIndex = 0;
                }
            } else {
                restartButton.textContent = '🔄 Nochmal';
                restartButton.onclick = startGame;
            }
        }

        // Load tasks when page loads
        loadTasksFromStorage();
        
        // Load sound preference when page loads
        window.addEventListener('DOMContentLoaded', loadSoundPreference);
        
        // Tandem input Enter key handler
        window.addEventListener('DOMContentLoaded', function() {
            const tandemInput = document.getElementById('tandemLeftInput');
            if (tandemInput) {
                tandemInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        submitLeftAnswer();
                    }
                });
            }
        });

        // ==================== FARB SPIEL (SAG DIE RICHTIGE FARBE!) ====================
        
        let farbSpielSettings = {
            mode: 'congruent', // 'congruent', 'incongruent', or 'farbenMerken'
            speed: 3000, // milliseconds
            colorCount: 10 // number of colors to show
        };

        let farbSpielState = {
            currentColor: 0,
            colors: [],
            userAnswers: [], // for farbenMerken mode
            correctSequence: [], // for farbenMerken mode
            score: 0
        };

        const colorDefinitions = {
            rot: { name: 'ROT', hex: '#FF0000' },
            blau: { name: 'BLAU', hex: '#0000FF' },
            gelb: { name: 'GELB', hex: '#FFD700' },
            grun: { name: 'GRÜN', hex: '#00FF00' },
            rosa: { name: 'ROSA', hex: '#FF69B4' }
        };

        function showFarbSpielSettings() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('farbSpielSettingsScreen').classList.add('active');
        }

        function selectFarbMode(mode, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            farbSpielSettings.mode = mode;
        }

        function selectFarbSpeed(speed, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            farbSpielSettings.speed = speed;
        }

        function selectFarbAnzahl(count, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            farbSpielSettings.colorCount = count;
        }

        function startFarbSpielGame() {
            // Reset state
            farbSpielState = {
                currentColor: 0,
                colors: [],
                userAnswers: [],
                correctSequence: [],
                score: 0
            };

            // Generate color sequence
            const colorKeys = Object.keys(colorDefinitions);
            
            if (farbSpielSettings.mode === 'farbenMerken') {
                // Farben Merken: Just show colored boxes (no text)
                for (let i = 0; i < farbSpielSettings.colorCount; i++) {
                    const randomColor = colorKeys[Math.floor(Math.random() * colorKeys.length)];
                    farbSpielState.colors.push({
                        colorKey: randomColor,
                        color: colorDefinitions[randomColor].hex
                    });
                    farbSpielState.correctSequence.push(randomColor);
                }
            } else {
                // Congruent or Incongruent modes
                for (let i = 0; i < farbSpielSettings.colorCount; i++) {
                    if (farbSpielSettings.mode === 'congruent') {
                        const randomColor = colorKeys[Math.floor(Math.random() * colorKeys.length)];
                        farbSpielState.colors.push({
                            word: colorDefinitions[randomColor].name,
                            color: colorDefinitions[randomColor].hex
                        });
                    } else {
                        const wordKey = colorKeys[Math.floor(Math.random() * colorKeys.length)];
                        let colorKey;
                        do {
                            colorKey = colorKeys[Math.floor(Math.random() * colorKeys.length)];
                        } while (colorKey === wordKey);
                        
                        farbSpielState.colors.push({
                            word: colorDefinitions[wordKey].name,
                            color: colorDefinitions[colorKey].hex
                        });
                    }
                }
            }

            // Show countdown screen FIRST (like Anzan!)
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('countdownScreen').classList.add('active');

            const countdownProgress = document.getElementById('countdownProgress');
            const countdownLogo = document.getElementById('countdownLogo');
            const countdownLos = document.getElementById('countdownLos');
            
            countdownLogo.classList.remove('hide');
            countdownLogo.style.display = 'block';
            countdownLos.style.display = 'none';
            countdownProgress.style.strokeDashoffset = '565.5';
            
            const duration = 3000;
            const start = performance.now();
            const startOffset = 565.5;
            
            function animate(currentTime) {
                const elapsed = currentTime - start;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = progress < 0.5
                    ? 2 * progress * progress
                    : 1 - Math.pow(-2 * progress + 2, 2) / 2;
                
                const currentOffset = startOffset - (startOffset * easeProgress);
                countdownProgress.style.strokeDashoffset = currentOffset;
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    countdownLogo.classList.add('hide');
                    setTimeout(() => {
                        countdownLogo.style.display = 'none';
                        countdownLos.style.display = 'block';
                    }, 300);
                    
                    setTimeout(() => {
                        showFarbSpielGameAfterCountdown();
                    }, 1500);
                }
            }
            
            requestAnimationFrame(animate);
        }

        function showFarbSpielGameAfterCountdown() {
            // NOW show game screen
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('farbSpielGameScreen').classList.add('active');
            
            // Reset UI
            document.getElementById('farbSpielEndMessage').style.display = 'none';
            document.getElementById('farbSpielProgressBar').style.width = '0%';
            document.getElementById('farbSpielAnswerSection').style.display = 'none';
            document.getElementById('farbSpielMainDisplay').style.display = 'flex';

            // Start showing colors
            showFarbSpielSequence();
        }

        function showFarbSpielSequence() {
            const counter = document.getElementById('farbSpielCounter');
            const wordDisplay = document.getElementById('farbSpielWordDisplay');
            const progressBar = document.getElementById('farbSpielProgressBar');
            
            if (farbSpielState.currentColor >= farbSpielState.colors.length) {
                // All colors shown
                if (farbSpielSettings.mode === 'farbenMerken') {
                    // Show answer section for Farben Merken
                    showFarbenMerkenAnswerSection();
                } else {
                    // End game for other modes
                    document.getElementById('farbSpielEndMessage').style.display = 'flex';
                    playSuccessSound();
                    createConfetti();
                }
                return;
            }
            
            const currentColorData = farbSpielState.colors[farbSpielState.currentColor];
            
            // Update counter
            counter.textContent = `${farbSpielState.currentColor + 1}/${farbSpielSettings.colorCount}`;
            
            // Update progress bar
            const progress = ((farbSpielState.currentColor + 1) / farbSpielSettings.colorCount) * 100;
            progressBar.style.width = progress + '%';
            
            if (farbSpielSettings.mode === 'farbenMerken') {
                // Show colored box (no text)
                wordDisplay.innerHTML = `<div style="width: 300px; height: 300px; background: ${currentColorData.color}; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.3);"></div>`;
            } else {
                // Show word with color
                wordDisplay.textContent = currentColorData.word;
                wordDisplay.style.color = currentColorData.color;
                wordDisplay.style.fontSize = '12em';
            }
            
            wordDisplay.style.animation = 'none';
            setTimeout(() => {
                wordDisplay.style.animation = 'pulse 0.3s ease-in-out';
            }, 10);
            
            playBeep();
            
            // Move to next color
            farbSpielState.currentColor++;
            setTimeout(() => {
                showFarbSpielSequence();
            }, farbSpielSettings.speed);
        }

        function showFarbenMerkenAnswerSection() {
            document.getElementById('farbSpielMainDisplay').style.display = 'none';
            document.getElementById('farbSpielAnswerSection').style.display = 'block';
            document.getElementById('farbenMerkenFeedback').innerHTML = '';
        }

        function selectFarbenMerkenColor(colorKey) {
            farbSpielState.userAnswers.push(colorKey);
            const feedbackDiv = document.getElementById('farbenMerkenFeedback');
            const currentIndex = farbSpielState.userAnswers.length - 1;
            const isCorrect = farbSpielState.correctSequence[currentIndex] === colorKey;
            
            if (isCorrect) {
                farbSpielState.score++;
                feedbackDiv.innerHTML = `<span style="color: #4CAF50;">✅ Richtig! (${farbSpielState.userAnswers.length}/${farbSpielSettings.colorCount})</span>`;
                playBeep();
            } else {
                feedbackDiv.innerHTML = `<span style="color: #f44336;">❌ Falsch! Richtig war: ${colorDefinitions[farbSpielState.correctSequence[currentIndex]].name}</span>`;
            }
            
            // Check if all colors selected
            if (farbSpielState.userAnswers.length >= farbSpielSettings.colorCount) {
                setTimeout(() => {
                    showFarbenMerkenResult();
                }, 1500);
            }
        }

        function showFarbenMerkenResult() {
            const percentage = Math.round((farbSpielState.score / farbSpielSettings.colorCount) * 100);
            
            document.getElementById('farbSpielAnswerSection').style.display = 'none';
            document.getElementById('farbSpielEndMessage').style.display = 'flex';
            
            // Update end message
            const endMsg = document.getElementById('farbSpielEndMessage');
            endMsg.innerHTML = `
                <h2 style="color: white; font-size: 5em; margin: 0;">🎉 FERTIG! 🎉</h2>
                <div style="color: white; font-size: 3em; margin: 20px 0;">
                    ${farbSpielState.score} / ${farbSpielSettings.colorCount} richtig (${percentage}%)
                </div>
                <div class="button-group" style="flex-direction: row;">
                    <button class="restart-button" onclick="startFarbSpielGame()">🔄 Nochmal</button>
                    <button class="new-settings-button" onclick="showFarbSpielSettings()">⚙️ Neue Einstellungen</button>
                    <button class="home-button" onclick="goHome()">🏠 Startseite</button>
                </div>
            `;
            
            if (percentage === 100) {
                playSuccessSound();
                createConfetti();
            }
        }

        // ==================== SOROBAN MATHE ====================
        
        let sorobanMatheSettings = {
            operation: 'addition', // 'addition', 'subtraktion', 'multiplikation', or 'division'
            difficulty: 'leicht', // 'leicht', 'mittel', 'schwer'
            digits: 1, // 1, 2, or 3 digits
            questionCount: 8
        };

        let sorobanMatheState = {
            currentQuestion: 0,
            score: 0,
            num1: 0,
            num2: 0,
            correctAnswer: 0
        };

        function showSorobanMatheSettings() {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('sorobanMatheSettingsScreen').classList.add('active');
        }

        function selectSorobanOperation(operation, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            sorobanMatheSettings.operation = operation;
        }

        function selectSorobanDifficulty(difficulty, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            sorobanMatheSettings.difficulty = difficulty;
        }

        function selectSorobanDigits(digits, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            sorobanMatheSettings.digits = digits;
        }

        function selectSorobanCount(count, element) {
            const siblings = element.parentElement.querySelectorAll('.option-card');
            siblings.forEach(sib => sib.classList.remove('selected'));
            element.classList.add('selected');
            sorobanMatheSettings.questionCount = count;
        }

        function startSorobanMatheGame() {
            sorobanMatheState = {
                currentQuestion: 0,
                score: 0,
                num1: 0,
                num2: 0,
                correctAnswer: 0
            };

            // Generate progress boxes dynamically based on questionCount
            const progressContainer = document.getElementById('sorobanMatheProgressBoxes');
            progressContainer.innerHTML = '';
            for (let i = 0; i < sorobanMatheSettings.questionCount; i++) {
                const box = document.createElement('div');
                box.className = 'progress-box';
                progressContainer.appendChild(box);
            }

            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('sorobanMatheGameScreen').classList.add('active');

            showSorobanMatheQuestion();
        }

        function showSorobanMatheQuestion() {
            if (sorobanMatheState.currentQuestion >= sorobanMatheSettings.questionCount) {
                endSorobanMatheGame();
                return;
            }

            // Calculate min and max based on digits
            const minNum = sorobanMatheSettings.digits === 1 ? 1 : Math.pow(10, sorobanMatheSettings.digits - 1);
            const maxNum = Math.pow(10, sorobanMatheSettings.digits) - 1;
            
            // Apply difficulty multiplier to range
            let rangeMin = minNum;
            let rangeMax = maxNum;
            
            if (sorobanMatheSettings.difficulty === 'leicht') {
                // Use lower half of range
                rangeMax = Math.floor((maxNum - minNum) * 0.5) + minNum;
            } else if (sorobanMatheSettings.difficulty === 'mittel') {
                // Use middle range
                rangeMin = Math.floor((maxNum - minNum) * 0.3) + minNum;
                rangeMax = Math.floor((maxNum - minNum) * 0.7) + minNum;
            }
            // schwer uses full range

            if (sorobanMatheSettings.operation === 'addition') {
                // Addition
                sorobanMatheState.num1 = Math.floor(Math.random() * (rangeMax - rangeMin + 1)) + rangeMin;
                sorobanMatheState.num2 = Math.floor(Math.random() * (rangeMax - rangeMin + 1)) + rangeMin;
                sorobanMatheState.correctAnswer = sorobanMatheState.num1 + sorobanMatheState.num2;
                
                document.getElementById('sorobanMatheOperation').textContent = '+';
                
            } else if (sorobanMatheSettings.operation === 'subtraktion') {
                // Subtraktion - ensure positive result
                sorobanMatheState.num1 = Math.floor(Math.random() * (rangeMax - rangeMin + 1)) + rangeMin;
                sorobanMatheState.num2 = Math.floor(Math.random() * (sorobanMatheState.num1 - rangeMin + 1)) + rangeMin;
                sorobanMatheState.correctAnswer = sorobanMatheState.num1 - sorobanMatheState.num2;
                
                document.getElementById('sorobanMatheOperation').textContent = '−';
                
            } else if (sorobanMatheSettings.operation === 'multiplikation') {
                // Multiplikation - smaller numbers for result to fit
                let smallRangeMin = minNum;
                let smallRangeMax = Math.min(rangeMax, Math.floor(Math.sqrt(maxNum)));
                
                if (sorobanMatheSettings.difficulty === 'leicht') {
                    smallRangeMax = Math.min(smallRangeMax, 5);
                } else if (sorobanMatheSettings.difficulty === 'mittel') {
                    smallRangeMax = Math.min(smallRangeMax, 9);
                }
                
                sorobanMatheState.num1 = Math.floor(Math.random() * (smallRangeMax - smallRangeMin + 1)) + smallRangeMin;
                sorobanMatheState.num2 = Math.floor(Math.random() * (smallRangeMax - smallRangeMin + 1)) + smallRangeMin;
                sorobanMatheState.correctAnswer = sorobanMatheState.num1 * sorobanMatheState.num2;
                
                document.getElementById('sorobanMatheOperation').textContent = '×';
                
            } else if (sorobanMatheSettings.operation === 'division') {
                // Division - generate result first, then multiply
                let resultMax = Math.min(rangeMax, 20);
                if (sorobanMatheSettings.difficulty === 'leicht') {
                    resultMax = Math.min(resultMax, 9);
                } else if (sorobanMatheSettings.difficulty === 'mittel') {
                    resultMax = Math.min(resultMax, 15);
                }
                
                sorobanMatheState.correctAnswer = Math.floor(Math.random() * resultMax) + 1;
                
                let divisorMax = Math.min(rangeMax, 12);
                if (sorobanMatheSettings.difficulty === 'leicht') {
                    divisorMax = Math.min(divisorMax, 5);
                } else if (sorobanMatheSettings.difficulty === 'mittel') {
                    divisorMax = Math.min(divisorMax, 9);
                }
                
                sorobanMatheState.num2 = Math.floor(Math.random() * divisorMax) + 1;
                sorobanMatheState.num1 = sorobanMatheState.correctAnswer * sorobanMatheState.num2;
                
                document.getElementById('sorobanMatheOperation').textContent = '÷';
            }

            // Draw abacuses
            drawSorobanMatheAbacus('sorobanMatheLeft', sorobanMatheState.num1);
            drawSorobanMatheAbacus('sorobanMatheRight', sorobanMatheState.num2);

            // Generate answer options
            generateSorobanMatheOptions();
        }

        function drawSorobanMatheAbacus(containerId, number) {
            const container = document.getElementById(containerId);
            const digitCount = number.toString().length;
            const numStr = number.toString().padStart(Math.max(1, digitCount), '0');
            const digits = numStr.split('').map(d => parseInt(d));

            let html = '<div style="background: linear-gradient(180deg, #ffffff 0%, #f8f8f8 100%); border-radius: 25px; padding: 40px 50px; box-shadow: 0 8px 25px rgba(0,0,0,0.15);"><div style="display: flex; justify-content: center; gap: 12px;">';

            digits.forEach((digit) => {
                html += `<div style="display: flex; flex-direction: column; align-items: center; width: 40px;">`;
                html += `<div style="width: 5px; height: 150px; background: #5DADE2; position: relative; border-radius: 3px;">`;
                
                // Heaven bead
                if (digit >= 5) {
                    html += `<div style="position: absolute; bottom: 73px; left: -15px; width: 35px; height: 18px; background: linear-gradient(145deg, #FFD700, #FFA500); border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`;
                }
                
                // Divider
                html += `<div style="position: absolute; top: 75px; left: -15px; right: -15px; height: 3px; background: #5DADE2; border-radius: 2px;"></div>`;
                
                // Earth beads
                const activeCount = digit % 5;
                for (let i = 0; i < activeCount; i++) {
                    html += `<div style="position: absolute; top: ${78 + i * 18}px; left: -15px; width: 35px; height: 18px; background: linear-gradient(145deg, #FFD700, #FFA500); border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.3);"></div>`;
                }
                
                html += `</div></div>`;
            });

            html += '</div></div>';
            container.innerHTML = html;
        }

        function generateSorobanMatheOptions() {
            const options = [sorobanMatheState.correctAnswer];
            
            // Generate 2 wrong answers
            while (options.length < 3) {
                const offset = Math.floor(Math.random() * 5) + 1;
                const wrongAnswer = sorobanMatheState.correctAnswer + (Math.random() < 0.5 ? offset : -offset);
                
                if (wrongAnswer > 0 && !options.includes(wrongAnswer)) {
                    options.push(wrongAnswer);
                }
            }

            // Shuffle
            options.sort(() => Math.random() - 0.5);

            // Create buttons
            const container = document.getElementById('sorobanMatheOptions');
            container.innerHTML = '';
            
            options.forEach(option => {
                const btn = document.createElement('button');
                btn.className = 'flashcard-option';
                btn.textContent = option;
                btn.onclick = () => checkSorobanMatheAnswer(option);
                container.appendChild(btn);
            });
        }

        function checkSorobanMatheAnswer(selectedAnswer) {
            const isCorrect = selectedAnswer === sorobanMatheState.correctAnswer;

            // Update progress box
            const boxes = document.querySelectorAll('#sorobanMatheProgressBoxes .progress-box');
            const currentBox = boxes[sorobanMatheState.currentQuestion];
            if (currentBox) {
                currentBox.classList.add(isCorrect ? 'correct' : 'wrong');
            }

            // Disable buttons and show feedback
            const buttons = document.querySelectorAll('#sorobanMatheOptions .flashcard-option');
            buttons.forEach(btn => {
                btn.disabled = true;
                const value = parseInt(btn.textContent);
                if (value === sorobanMatheState.correctAnswer) {
                    btn.classList.add('correct');
                } else if (value === selectedAnswer && !isCorrect) {
                    btn.classList.add('wrong');
                }
            });

            if (isCorrect) {
                sorobanMatheState.score++;
                playBeep();
            }

            // Next question
            setTimeout(() => {
                sorobanMatheState.currentQuestion++;
                showSorobanMatheQuestion();
            }, 1500);
        }

        function endSorobanMatheGame() {
            showScreen('resultScreen');
            
            const percentage = Math.round((sorobanMatheState.score / sorobanMatheSettings.questionCount) * 100);
            const resultMessage = document.getElementById('resultMessage');
            
            if (percentage === 100) {
                const perfectMessages = ['🎉 SUPER! 🎉', '⭐ TOLL! ⭐', '🏆 FANTASTISCH! 🏆'];
                resultMessage.textContent = perfectMessages[Math.floor(Math.random() * perfectMessages.length)];
                resultMessage.className = 'result-message correct';
                playSuccessSound();
                createConfetti();
            } else if (percentage >= 75) {
                resultMessage.textContent = '👏 SEHR GUT! 👏';
                resultMessage.className = 'result-message correct';
            } else if (percentage >= 50) {
                resultMessage.textContent = '👍 GUT GEMACHT! 👍';
                resultMessage.className = 'result-message correct';
            } else {
                resultMessage.textContent = '💪 Weiter üben!';
                resultMessage.className = 'result-message wrong';
            }
            
            const operationName = sorobanMatheSettings.operation === 'addition' ? 'Addition' : 
                                  sorobanMatheSettings.operation === 'subtraktion' ? 'Subtraktion' :
                                  sorobanMatheSettings.operation === 'multiplikation' ? 'Multiplikation' : 'Division';
            document.getElementById('questionText').textContent = 
                `${operationName} | ${sorobanMatheSettings.difficulty} | ${sorobanMatheState.score} von ${sorobanMatheSettings.questionCount} richtig!`;
            document.getElementById('correctAnswer').textContent = `Erfolgsquote: ${percentage}%`;
            document.getElementById('userAnswer').textContent = '';
        }

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('✅ Service Worker registriert:', registration.scope);
                    })
                    .catch(error => {
                        console.error('❌ Service Worker Registrierung fehlgeschlagen:', error);
                    });
            });
        }
    </script>
</body>
</html>
